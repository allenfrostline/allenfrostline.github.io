<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Spread Trading: XOP and DRIP - Allen&#39;s Whiteboard</title>
    <meta property="og:title" content="Spread Trading: XOP and DRIP - Allen&#39;s Whiteboard">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="In this strategy we try to do spread trading based on the M-day (adjusted) returns of two highly related ETFs (exchange-traded funds). The intuition is to hedge the one-sided risks of buy-and-holding &amp;hellip;">
      <meta property="og:description" content="In this strategy we try to do spread trading based on the M-day (adjusted) returns of two highly related ETFs (exchange-traded funds). The intuition is to hedge the one-sided risks of buy-and-holding &amp;hellip;">
      
    

    
    
    
    <meta name="twitter:image" content="https://allenfrostline.com/logo.png">
    
    

    

    
    




    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
<script src="/js/math-code.js"></script>


<script>
  (function (u, c) {
    var d = document, t = 'script', o = d.createElement(t), s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(e); }); }
    s.parentNode.insertBefore(o, s);
  })('//cdn.jsdelivr.net/npm/pangu@4.0.5/dist/browser/pangu.min.js', function () {
    pangu.spacingPage();
  });
</script>



<script async src="/js/center-img.js"></script>


<script>
    window.minimalAnalytics = {
        trackingId: 'G-B4WMGBPB4Z',
        autoTrack: true, 
    };
</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-B4WMGBPB4Z"></script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B4WMGBPB4Z');
</script>


<script src="/index_1423847519945263698.js" async></script>


  </head>

  
  <body class="blog">
    <header class="masthead">
      

<h1><a href="/"><img src="/logo.png" alt="allenfrostline" /></a></h1>



      <nav class="menu">
  <ul>
  
  
  <li><a href="/blog/">Blog</a></li>
  
  <li><a href="/pottery/">Pottery</a></li>
  
  <li><a href="/recipe/">Recipe</a></li>
  
  <li><a href="/kotoba">Kotoba</a></li>
  
  <li><a href="/vitae/">Vitae</a></li>
  
  













  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
    <h1>Spread Trading: XOP and DRIP</h1>
    

    <hr style="margin-top:-1em">

    <h3 style="margin-top:-2.3em">
    
        

        
            2019-04-23
        
    
    </h3>



      </header>



<p>In this strategy we try to do spread trading based on the <code>M</code>-day (adjusted) returns of two highly related ETFs (exchange-traded funds). The intuition is to hedge the one-sided risks of buy-and-holding one specific ETF with (in expectation) increasing returns, by holding an opposite position of another ETF with decreasing returns. Once we have that the two ETFs&rsquo; returns are highly correlated, we can trade and make profit by this sort of pair trading.</p>
<!-- more -->
<p>Apart from <code>M</code>, we define trading thresholds <code>g</code> and <code>j</code>, together with stop-loss threshold <code>s</code>. Total capital limit <code>K</code> is assumed to be twice of <code>N</code>, namely the 15-day rolling median volume (of the less liquid ETF). Specifically, we first calculate the array of daily minimums of the two (adjusted) volume series, and then calculate the 15-day rolling median of this series as <code>N</code>. Apart from the capital limit, we also define daily position value (if any) based on <code>N</code>, which is <code>N/100</code>.</p>
<p>Specifically, for each trading day, we have workflow as below.</p>
<center><img src="/images/spread0.png" style="max-width:min(100%, 600px)"></center>
<p>Apart from this process, we also keep track of our risk exposure with a stop-loss threshold, and try to do trading only within a month&rsquo;s time, i.e. we start trading only when it&rsquo;s the start of a new month, and kill any position every time it&rsquo;s the end of a month.</p>
<h1 id="dependencies">Dependencies</h1>
<p>Import necessary modules and set up corresponding configurations. In this research notebook, we are using the following packages:</p>
<ul>
<li><strong>Quandl</strong>: source of financial data</li>
<li><strong>NumPy</strong>: mathematical tools &amp; matrix processing</li>
<li><strong>Pandas</strong>: data frame support</li>
<li><strong>Matplotlib</strong>: plotting</li>
<li><strong>SciPy</strong>: statistical analysis</li>
<li><strong>StatsModels</strong>: statistical analysis</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">warnings</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">quandl</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">numpy</span> <span style="font-weight:bold">as</span> <span style="color:#555">np</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">pandas</span> <span style="font-weight:bold">as</span> <span style="color:#555">pd</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">matplotlib.pyplot</span> <span style="font-weight:bold">as</span> <span style="color:#555">plt</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">scipy.stats</span> <span style="font-weight:bold">import</span> norm, t
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">statsmodels.tsa.stattools</span> <span style="font-weight:bold">import</span> adfuller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pd<span style="font-weight:bold">.</span>set_option(<span style="color:#b84">&#39;display.max_rows&#39;</span>, <span style="color:#099">30</span>)
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>style<span style="font-weight:bold">.</span>use(<span style="color:#b84">&#39;bmh&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>rcParams[<span style="color:#b84">&#39;font.family&#39;</span>] <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;serif&#39;</span>
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>rcParams[<span style="color:#b84">&#39;font.size&#39;</span>] <span style="font-weight:bold">=</span> <span style="color:#099">15</span>
</span></span><span style="display:flex;"><span>warnings<span style="font-weight:bold">.</span>filterwarnings(<span style="color:#b84">&#39;ignore&#39;</span>)
</span></span><span style="display:flex;"><span>quandl<span style="font-weight:bold">.</span>ApiConfig<span style="font-weight:bold">.</span>api_key <span style="font-weight:bold">=</span> QUANDL_API_KEY
</span></span></code></pre></div><h1 id="preparatory-analysis">Preparatory Analysis</h1>
<p>In this part, we will try to analyze the economic and statistical features in the data. Here the two ETFs we&rsquo;re using are XOP and DRIP. Data is retrieved from Quandl from <code>2015-12-02</code> to <code>2018-12-31</code>. We&rsquo;ll use only data from <code>2015-12-02</code> to <code>2016-12-01</code> for this section, as we don&rsquo;t want to include future information during the backtest. Also, while it&rsquo;s always better to have longer historical data for analysis, due to limited length of ETF data on Quandl (specifically for these two ETFs) we&rsquo;re unfortunately restrained to this short timespan.</p>
<h3 id="definition-of-xop">Definition of XOP</h3>
<p>The SPDR S&amp;P Oil &amp; Gas Exploration &amp; Production ETF (XOP) seeks to provide investment results that, before fees and expenses, correspond generally to the total return performance of the S&amp;P Oil &amp; Gas Exploration &amp; Production Select Industry Index. See <a href="https://us.spdrs.com/en/etf/spdr-sp-oil-gas-exploration-production-etf-XOP">here</a> for more detailed description.</p>
<h3 id="definition-of-drip">Definition of DRIP</h3>
<p>The Direxion Daily S&amp;P Oil &amp; Gas Exp. &amp; Prod. Bull and Bear 3X Shares (DRIP) seek daily investment results, before fees and expenses, of <strong>300% of the inverse</strong>, of the performance of the S&amp;P Oil &amp; Gas Exploration &amp; Production Select Industry Index. See <a href="http://www.direxioninvestments.com/products/daily-sp-oil-gas-exp-prod-bull-3x-shares">here</a> for more detailed description.</p>
<h3 id="relationship-of-xop-and-drip">Relationship of XOP and DRIP</h3>
<p>By definition of the two ETFs, we expect DRIP to track -300% the daily return of XOP. This means the spread we should be tracking is, instead of the return difference between the two, the difference of -300% of <code>M</code>-day returns of XOP and the <code>M</code>-day returns of DRIP. Also, we are supposed to hold, if any, positions of these two ETFs in a ratio of XOP:DRIP = -3, no matter we&rsquo;re long or short in the spread.</p>
<p>A peek into the data (assume <code>M</code> is 5.):</p>
<ul>
<li><code>DRIP</code>: price of DRIP</li>
<li><code>XOP</code>: price of XOP</li>
<li><code>rDRIP</code>: 5-day return of DRIP</li>
<li><code>rXOP</code>: 5-day return of XOP</li>
<li><code>rXOPn3</code>: -300% of 5-day return of XOP</li>
<li><code>spread</code>: spread of <code>rXOPn3</code> from <code>rDRIP</code> ( <code>spread = rDRIP - rXOPn3</code> )</li>
</ul>
<p>The first few entries of our data reads:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># exploratory settings</span>
</span></span><span style="display:flex;"><span>symbols <span style="font-weight:bold">=</span> (<span style="color:#b84">&#39;DRIP&#39;</span>, <span style="color:#b84">&#39;XOP&#39;</span>)
</span></span><span style="display:flex;"><span>dates <span style="font-weight:bold">=</span> (<span style="color:#b84">&#39;2015-12-02&#39;</span>, <span style="color:#b84">&#39;2016-12-01&#39;</span>)
</span></span><span style="display:flex;"><span>M <span style="font-weight:bold">=</span> <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># retrieve data</span>
</span></span><span style="display:flex;"><span>df_X <span style="font-weight:bold">=</span> quandl<span style="font-weight:bold">.</span>get(<span style="color:#b84">&#39;EOD/&#39;</span> <span style="font-weight:bold">+</span> symbols[<span style="color:#099">0</span>], start_date<span style="font-weight:bold">=</span>dates[<span style="color:#099">0</span>], end_date<span style="font-weight:bold">=</span>dates[<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>df_Y <span style="font-weight:bold">=</span> quandl<span style="font-weight:bold">.</span>get(<span style="color:#b84">&#39;EOD/&#39;</span> <span style="font-weight:bold">+</span> symbols[<span style="color:#099">1</span>], start_date<span style="font-weight:bold">=</span>dates[<span style="color:#099">0</span>], end_date<span style="font-weight:bold">=</span>dates[<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>X <span style="font-weight:bold">=</span> df_X<span style="font-weight:bold">.</span>Adj_Close
</span></span><span style="display:flex;"><span>Y <span style="font-weight:bold">=</span> df_Y<span style="font-weight:bold">.</span>Adj_Close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># calculate M-day returns</span>
</span></span><span style="display:flex;"><span>rX <span style="font-weight:bold">=</span> (X<span style="font-weight:bold">.</span>diff(M) <span style="font-weight:bold">/</span> X<span style="font-weight:bold">.</span>shift(M))<span style="font-weight:bold">.</span>dropna()
</span></span><span style="display:flex;"><span>rY <span style="font-weight:bold">=</span> (Y<span style="font-weight:bold">.</span>diff(M) <span style="font-weight:bold">/</span> Y<span style="font-weight:bold">.</span>shift(M))<span style="font-weight:bold">.</span>dropna()
</span></span><span style="display:flex;"><span>rY3 <span style="font-weight:bold">=</span> rY <span style="font-weight:bold">*</span> <span style="font-weight:bold">-</span><span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>spread <span style="font-weight:bold">=</span> rX <span style="font-weight:bold">-</span> rY3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># concat all variables</span>
</span></span><span style="display:flex;"><span>df <span style="font-weight:bold">=</span> pd<span style="font-weight:bold">.</span>concat([X, Y, rX, rY, rY3, spread], axis<span style="font-weight:bold">=</span><span style="color:#099">1</span>)<span style="font-weight:bold">.</span>dropna()
</span></span><span style="display:flex;"><span><span style="font-weight:bold">del</span> X, Y, rX, rY, rY3, spread, df_X, df_Y
</span></span><span style="display:flex;"><span>df<span style="font-weight:bold">.</span>columns <span style="font-weight:bold">=</span> [symbols[<span style="color:#099">0</span>], symbols[<span style="color:#099">1</span>],
</span></span><span style="display:flex;"><span>              <span style="color:#b84">&#39;r&#39;</span> <span style="font-weight:bold">+</span> symbols[<span style="color:#099">0</span>], <span style="color:#b84">&#39;r&#39;</span> <span style="font-weight:bold">+</span> symbols[<span style="color:#099">1</span>],
</span></span><span style="display:flex;"><span>              <span style="color:#b84">&#39;r&#39;</span> <span style="font-weight:bold">+</span> symbols[<span style="color:#099">1</span>] <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;n3&#39;</span>, <span style="color:#b84">&#39;spread&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df<span style="font-weight:bold">.</span>head(<span style="color:#099">10</span>)
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">DRIP</th>
<th style="text-align:center">XOP</th>
<th style="text-align:center">rDRIP</th>
<th style="text-align:center">rXOP</th>
<th style="text-align:center">rXOPn3</th>
<th style="text-align:center">spread</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2015-12-09</td>
<td style="text-align:center">93.228406</td>
<td style="text-align:center">31.481858</td>
<td style="text-align:center">0.300551</td>
<td style="text-align:center">-0.091874</td>
<td style="text-align:center">0.275621</td>
<td style="text-align:center">0.024930</td>
</tr>
<tr>
<td style="text-align:center">2015-12-10</td>
<td style="text-align:center">87.783600</td>
<td style="text-align:center">32.033661</td>
<td style="text-align:center">0.175401</td>
<td style="text-align:center">-0.063402</td>
<td style="text-align:center">0.190207</td>
<td style="text-align:center">-0.014806</td>
</tr>
<tr>
<td style="text-align:center">2015-12-11</td>
<td style="text-align:center">100.660997</td>
<td style="text-align:center">30.465377</td>
<td style="text-align:center">0.247456</td>
<td style="text-align:center">-0.084908</td>
<td style="text-align:center">0.254725</td>
<td style="text-align:center">-0.007269</td>
</tr>
<tr>
<td style="text-align:center">2015-12-14</td>
<td style="text-align:center">107.982471</td>
<td style="text-align:center">29.719958</td>
<td style="text-align:center">0.113006</td>
<td style="text-align:center">-0.041524</td>
<td style="text-align:center">0.124571</td>
<td style="text-align:center">-0.011565</td>
</tr>
<tr>
<td style="text-align:center">2015-12-15</td>
<td style="text-align:center">101.685757</td>
<td style="text-align:center">30.310485</td>
<td style="text-align:center">0.065597</td>
<td style="text-align:center">-0.028545</td>
<td style="text-align:center">0.085635</td>
<td style="text-align:center">-0.020037</td>
</tr>
<tr>
<td style="text-align:center">2015-12-16</td>
<td style="text-align:center">108.538063</td>
<td style="text-align:center">29.632831</td>
<td style="text-align:center">0.164217</td>
<td style="text-align:center">-0.058733</td>
<td style="text-align:center">0.176199</td>
<td style="text-align:center">-0.011983</td>
</tr>
<tr>
<td style="text-align:center">2015-12-17</td>
<td style="text-align:center">118.711577</td>
<td style="text-align:center">28.616350</td>
<td style="text-align:center">0.352321</td>
<td style="text-align:center">-0.106679</td>
<td style="text-align:center">0.320036</td>
<td style="text-align:center">0.032284</td>
</tr>
<tr>
<td style="text-align:center">2015-12-18</td>
<td style="text-align:center">125.551661</td>
<td style="text-align:center">28.154731</td>
<td style="text-align:center">0.247272</td>
<td style="text-align:center">-0.075845</td>
<td style="text-align:center">0.227535</td>
<td style="text-align:center">0.019737</td>
</tr>
<tr>
<td style="text-align:center">2015-12-21</td>
<td style="text-align:center">130.267899</td>
<td style="text-align:center">27.862871</td>
<td style="text-align:center">0.206380</td>
<td style="text-align:center">-0.062486</td>
<td style="text-align:center">0.187459</td>
<td style="text-align:center">0.018921</td>
</tr>
<tr>
<td style="text-align:center">2015-12-22</td>
<td style="text-align:center">125.008291</td>
<td style="text-align:center">28.203374</td>
<td style="text-align:center">0.229359</td>
<td style="text-align:center">-0.069518</td>
<td style="text-align:center">0.208553</td>
<td style="text-align:center">0.020806</td>
</tr>
</tbody>
</table>
<p>Also we may plot the histogram of the spread. Here we plot it against the fitted normal and t distributions. Apparently the t distribution matches our spread data better, which coincides with our expectation as financial data is commonly seen with fat tails. Also, we may notice that the spread is well centered around zero, which reassures us that we can assume <strong>symmetrical</strong> thresholds for trading.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fig <span style="font-weight:bold">=</span> plt<span style="font-weight:bold">.</span>figure(figsize<span style="font-weight:bold">=</span>(<span style="color:#099">20</span>, <span style="color:#099">7.5</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax <span style="font-weight:bold">=</span> fig<span style="font-weight:bold">.</span>add_subplot(<span style="color:#099">121</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>hist(df<span style="font-weight:bold">.</span>spread, bins<span style="font-weight:bold">=</span><span style="color:#099">50</span>, edgecolor<span style="font-weight:bold">=</span><span style="color:#b84">&#39;k&#39;</span>, facecolor<span style="font-weight:bold">=</span><span style="color:#b84">&#39;c&#39;</span>, density<span style="font-weight:bold">=</span><span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>x_grid <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>linspace(<span style="font-weight:bold">-</span><span style="color:#099">.2</span>, <span style="color:#099">.2</span>, <span style="color:#099">200</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># fit to normal</span>
</span></span><span style="display:flex;"><span>params <span style="font-weight:bold">=</span> norm<span style="font-weight:bold">.</span>fit(df<span style="font-weight:bold">.</span>spread)
</span></span><span style="display:flex;"><span>pdf_fitted <span style="font-weight:bold">=</span> norm<span style="font-weight:bold">.</span>pdf(x_grid, <span style="font-weight:bold">*</span>params)
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>plot(x_grid, pdf_fitted, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>         label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;$\mathcal</span><span style="color:#b84">{N}</span><span style="color:#b84">$&#39;</span> <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;(</span><span style="color:#b84">{:.2f}</span><span style="color:#b84">,</span><span style="color:#b84">{:.2f}</span><span style="color:#b84">)&#39;</span><span style="font-weight:bold">.</span>format(<span style="font-weight:bold">*</span>params))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># fit to t</span>
</span></span><span style="display:flex;"><span>params <span style="font-weight:bold">=</span> t<span style="font-weight:bold">.</span>fit(df<span style="font-weight:bold">.</span>spread)
</span></span><span style="display:flex;"><span>pdf_fitted <span style="font-weight:bold">=</span> t<span style="font-weight:bold">.</span>pdf(x_grid, <span style="font-weight:bold">*</span>params)
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>plot(x_grid, pdf_fitted, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;orange&#39;</span>,
</span></span><span style="display:flex;"><span>         label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;t(</span><span style="color:#b84">{:.2f}</span><span style="color:#b84">,</span><span style="color:#b84">{:.2f}</span><span style="color:#b84">,</span><span style="color:#b84">{:.2f}</span><span style="color:#b84">)&#39;</span><span style="font-weight:bold">.</span>format(<span style="font-weight:bold">*</span>params))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_xlabel(<span style="color:#b84">&#39;Spread&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Density&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>legend(frameon<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>, loc<span style="font-weight:bold">=</span><span style="color:#b84">&#39;upper left&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax <span style="font-weight:bold">=</span> fig<span style="font-weight:bold">.</span>add_subplot(<span style="color:#099">122</span>)
</span></span><span style="display:flex;"><span>df<span style="font-weight:bold">.</span>spread<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>xticks(rotation<span style="font-weight:bold">=</span><span style="color:#099">0</span>, ha<span style="font-weight:bold">=</span><span style="color:#b84">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_xlabel(<span style="color:#b84">&#39;Date&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Spread&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>tight_layout()
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>show()
</span></span></code></pre></div><p><img src="/images/spread1.png" alt=""></p>
<p>In the second subplot, we can see that the spread series is quite &ldquo;stationary&rdquo; over time, but we&rsquo;d better not stop just observing by eye. (Also it&rsquo;s a bit heteroskedastic, but we&rsquo;re not focusing on that in this research.)</p>
<h3 id="statistical-tests">Statistical Tests</h3>
<p>Below are some statistical tests we need to run through before actual pair traing. For detailed reasoning please refer to this <a href="https://www.quantstart.com/articles/Basics-of-Statistical-Mean-Reversion-Testing">post</a>.</p>
<ul>
<li>Test for Unit Root: Here we use the Augmented Dickey-Fuller test. The p-value is 6.35e-14 $\ll$ 0.05, so we may safely reject the null.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>result <span style="font-weight:bold">=</span> adfuller(df<span style="font-weight:bold">.</span>spread)
</span></span><span style="display:flex;"><span><span style="color:#999">print</span>(<span style="color:#b84">&#39;ADF Statistic: </span><span style="color:#b84">{}</span><span style="color:#b84">\n</span><span style="color:#b84">p-value: </span><span style="color:#b84">{}</span><span style="color:#b84">\n</span><span style="color:#b84">Critical Values:&#39;</span><span style="font-weight:bold">.</span>format(<span style="font-weight:bold">*</span>result[:<span style="color:#099">2</span>]))
</span></span><span style="display:flex;"><span><span style="font-weight:bold">for</span> key, value <span style="font-weight:bold">in</span> result[<span style="color:#099">4</span>]<span style="font-weight:bold">.</span>items():
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;</span><span style="color:#b84">\t</span><span style="color:#b84">{}</span><span style="color:#b84">: </span><span style="color:#b84">{:.3f}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(key, value))
</span></span></code></pre></div><pre><code>ADF Statistic: -8.614239430241229
p-value: 6.353844261802846e-14
Critical Values:
    1%: -3.458
    5%: -2.874
    10%: -2.573
</code></pre>
<ul>
<li>Test for Strong Stationarity: Here we opt for the Hurst Exponent. By definition, Hurst value H &lt; 0.5 indicates the time series is mean-reverting, and our H value for the spread is -0.0390, so assumption is confirmed.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">hurst</span>(ts):
</span></span><span style="display:flex;"><span>    lags <span style="font-weight:bold">=</span> <span style="color:#999">range</span>(<span style="color:#099">2</span>, <span style="color:#099">100</span>)
</span></span><span style="display:flex;"><span>    tau <span style="font-weight:bold">=</span> [np<span style="font-weight:bold">.</span>sqrt(np<span style="font-weight:bold">.</span>std(np<span style="font-weight:bold">.</span>subtract(ts[lag:], ts[:<span style="font-weight:bold">-</span>lag]))) <span style="font-weight:bold">for</span> lag <span style="font-weight:bold">in</span> lags]
</span></span><span style="display:flex;"><span>    poly <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>polyfit(np<span style="font-weight:bold">.</span>log(lags), np<span style="font-weight:bold">.</span>log(tau), <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> poly[<span style="color:#099">0</span>]<span style="font-weight:bold">*</span><span style="color:#099">2.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>np<span style="font-weight:bold">.</span>random<span style="font-weight:bold">.</span>seed(<span style="color:#099">123</span>)
</span></span><span style="display:flex;"><span>gbm <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>log(np<span style="font-weight:bold">.</span>cumsum(np<span style="font-weight:bold">.</span>random<span style="font-weight:bold">.</span>randn(<span style="color:#099">100000</span>))<span style="font-weight:bold">+</span><span style="color:#099">1000</span>)
</span></span><span style="display:flex;"><span>mr <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>log(np<span style="font-weight:bold">.</span>random<span style="font-weight:bold">.</span>randn(<span style="color:#099">100000</span>)<span style="font-weight:bold">+</span><span style="color:#099">1000</span>)
</span></span><span style="display:flex;"><span>tr <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>log(np<span style="font-weight:bold">.</span>cumsum(np<span style="font-weight:bold">.</span>random<span style="font-weight:bold">.</span>randn(<span style="color:#099">100000</span>)<span style="font-weight:bold">+</span><span style="color:#099">1</span>)<span style="font-weight:bold">+</span><span style="color:#099">1000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999">print</span>(<span style="color:#b84">&#39;H: </span><span style="color:#b84">{:.4f}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(hurst(df<span style="font-weight:bold">.</span>spread)))
</span></span></code></pre></div><pre><code>H: -0.0390
</code></pre>
<p>Based on the previous two test results we conclude our spread is mean-reverting and the strategy is reasonable.</p>
<h1 id="backtest-engine">Backtest Engine</h1>
<p>In this part we design a simple backtest engine that takes ETF symbols, backtest timespan and the theoretical return ratio. It then provides an interface to run backtest against different parameters. I&rsquo;ve encapsulated private methods/variables in the class <code>BacktestEngine</code> and there are only three attributes available:</p>
<ul>
<li><code>BacktestEngine.symbols</code>: tuple of ETF symbols</li>
<li><code>BacktestEngine.run</code>: run backtest (returns Sortino ratio, Sharpe ratio, maximum drawdown and YoY return)</li>
<li><code>BacktestEngine.df</code>: stores the data from backtest (trade log)</li>
</ul>
<p>The basic usage of this engine would be</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>be <span style="font-weight:bold">=</span> BacktestEngine(<span style="color:#b84">&#39;DRIP&#39;</span>, <span style="color:#b84">&#39;XOP&#39;</span>, <span style="color:#b84">&#39;2016-12-02&#39;</span>, <span style="color:#b84">&#39;2018-12-31&#39;</span>, ratio<span style="font-weight:bold">=-</span><span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>be<span style="font-weight:bold">.</span>run(M<span style="font-weight:bold">=</span><span style="color:#099">5</span>, g<span style="font-weight:bold">=</span><span style="color:#099">0.010</span>, j<span style="font-weight:bold">=</span><span style="color:#099">0.005</span>, s<span style="font-weight:bold">=</span><span style="color:#099">0.010</span>, verbose<span style="font-weight:bold">=</span><span style="font-weight:bold">True</span>)  <span style="color:#998;font-style:italic"># plot the backtest results</span>
</span></span></code></pre></div><p>and if you want to check the tradelog during the timespan, call <code>be.df</code>. Note in this data frame, we denote the two ETFs by <code>X</code> and <code>Y</code>, and instead of the original <code>M</code>-day return of <code>Y</code>, we denote <code>rY</code> as <code>ratio</code> times the original <code>M</code>-day returns. The positions of <code>X</code> and <code>Y</code> are also reported in <code>be.df</code> together with daily and cumulative returns (in percentages of <code>K</code>).</p>
<p>An example of this <code>be.df</code> would be</p>
<table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">X</th>
<th style="text-align:center">Y</th>
<th style="text-align:center">rX</th>
<th style="text-align:center">rY</th>
<th style="text-align:center">spread</th>
<th style="text-align:center">N</th>
<th style="text-align:center">pX</th>
<th style="text-align:center">pY</th>
<th style="text-align:center">daily_rtn</th>
<th style="text-align:center">cum_rtn</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2016-12-22</td>
<td style="text-align:center">12.267480</td>
<td style="text-align:center">41.323160</td>
<td style="text-align:center">-0.019732</td>
<td style="text-align:center">-0.017567</td>
<td style="text-align:center">-0.002165</td>
<td style="text-align:center">1.549400e+07</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0.0</td>
<td style="text-align:center">0.0</td>
</tr>
<tr>
<td style="text-align:center">2016-12-23</td>
<td style="text-align:center">12.208217</td>
<td style="text-align:center">41.450761</td>
<td style="text-align:center">-0.017488</td>
<td style="text-align:center">-0.015711</td>
<td style="text-align:center">-0.001778</td>
<td style="text-align:center">1.210184e+07</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0.0</td>
<td style="text-align:center">0.0</td>
</tr>
<tr>
<td style="text-align:center">2016-12-27</td>
<td style="text-align:center">12.000796</td>
<td style="text-align:center">41.666701</td>
<td style="text-align:center">-0.018578</td>
<td style="text-align:center">-0.016343</td>
<td style="text-align:center">-0.002235</td>
<td style="text-align:center">1.064284e+07</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0.0</td>
<td style="text-align:center">0.0</td>
</tr>
<tr>
<td style="text-align:center">2016-12-28</td>
<td style="text-align:center">12.445270</td>
<td style="text-align:center">41.166112</td>
<td style="text-align:center">0.003185</td>
<td style="text-align:center">0.004286</td>
<td style="text-align:center">-0.001101</td>
<td style="text-align:center">9.867562e+06</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0.0</td>
<td style="text-align:center">0.0</td>
</tr>
<tr>
<td style="text-align:center">2016-12-29</td>
<td style="text-align:center">12.692200</td>
<td style="text-align:center">40.901094</td>
<td style="text-align:center">0.017419</td>
<td style="text-align:center">0.017180</td>
<td style="text-align:center">0.000239</td>
<td style="text-align:center">9.607867e+06</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0.0</td>
<td style="text-align:center">0.0</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">BacktestEngine</span>:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> __init__(self, X_symbol, Y_symbol, start_date, end_date, ratio<span style="font-weight:bold">=</span><span style="color:#099">1</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER:
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            X_symbol: string
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            Y_symbol: string
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            start_date: string or datetime object
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            end_date: string or datetime object
</span></span></span><span style="display:flex;"><span><span style="color:#b84">
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: None
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>symbols <span style="font-weight:bold">=</span> (X_symbol, Y_symbol)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__dates <span style="font-weight:bold">=</span> (start_date, end_date)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__stop_loss_dates <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__ratio <span style="font-weight:bold">=</span> ratio
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># load data</span>
</span></span><span style="display:flex;"><span>        df_X <span style="font-weight:bold">=</span> quandl<span style="font-weight:bold">.</span>get(<span style="color:#b84">&#39;EOD/&#39;</span> <span style="font-weight:bold">+</span> self<span style="font-weight:bold">.</span>symbols[<span style="color:#099">0</span>],
</span></span><span style="display:flex;"><span>                          start_date<span style="font-weight:bold">=</span>self<span style="font-weight:bold">.</span>__dates[<span style="color:#099">0</span>],
</span></span><span style="display:flex;"><span>                          end_date<span style="font-weight:bold">=</span>self<span style="font-weight:bold">.</span>__dates[<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>        df_Y <span style="font-weight:bold">=</span> quandl<span style="font-weight:bold">.</span>get(<span style="color:#b84">&#39;EOD/&#39;</span> <span style="font-weight:bold">+</span> self<span style="font-weight:bold">.</span>symbols[<span style="color:#099">1</span>],
</span></span><span style="display:flex;"><span>                          start_date<span style="font-weight:bold">=</span>self<span style="font-weight:bold">.</span>__dates[<span style="color:#099">0</span>],
</span></span><span style="display:flex;"><span>                          end_date<span style="font-weight:bold">=</span>self<span style="font-weight:bold">.</span>__dates[<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__data <span style="font-weight:bold">=</span> [df_X, df_Y]
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__trading <span style="font-weight:bold">=</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">__process_data</span>(self):  <span style="color:#998;font-style:italic"># prepare data to feed model</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER: None
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: None
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        df_X, df_Y <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__data
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># generate price and volume series</span>
</span></span><span style="display:flex;"><span>        N_X <span style="font-weight:bold">=</span> df_X<span style="font-weight:bold">.</span>Adj_Volume <span style="font-weight:bold">*</span> df_X<span style="font-weight:bold">.</span>Adj_Close
</span></span><span style="display:flex;"><span>        N_Y <span style="font-weight:bold">=</span> df_Y<span style="font-weight:bold">.</span>Adj_Volume <span style="font-weight:bold">*</span> df_Y<span style="font-weight:bold">.</span>Adj_Close
</span></span><span style="display:flex;"><span>        N <span style="font-weight:bold">=</span> pd<span style="font-weight:bold">.</span>concat([N_X, N_Y], axis<span style="font-weight:bold">=</span><span style="color:#099">1</span>)<span style="font-weight:bold">.</span>min(axis<span style="font-weight:bold">=</span><span style="color:#099">1</span>)<span style="font-weight:bold">.</span>rolling(<span style="color:#099">15</span>)<span style="font-weight:bold">.</span>median()
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__K <span style="font-weight:bold">=</span> N<span style="font-weight:bold">.</span>max() <span style="font-weight:bold">*</span> <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>        X <span style="font-weight:bold">=</span> df_X<span style="font-weight:bold">.</span>Adj_Close
</span></span><span style="display:flex;"><span>        Y <span style="font-weight:bold">=</span> df_Y<span style="font-weight:bold">.</span>Adj_Close
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># calculate M-day returns</span>
</span></span><span style="display:flex;"><span>        M <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__M
</span></span><span style="display:flex;"><span>        rX <span style="font-weight:bold">=</span> (X<span style="font-weight:bold">.</span>diff(M) <span style="font-weight:bold">/</span> X<span style="font-weight:bold">.</span>shift(M))<span style="font-weight:bold">.</span>dropna()
</span></span><span style="display:flex;"><span>        rY <span style="font-weight:bold">=</span> (Y<span style="font-weight:bold">.</span>diff(M) <span style="font-weight:bold">/</span> Y<span style="font-weight:bold">.</span>shift(M))<span style="font-weight:bold">.</span>dropna() <span style="font-weight:bold">*</span> self<span style="font-weight:bold">.</span>__ratio
</span></span><span style="display:flex;"><span>        spread <span style="font-weight:bold">=</span> rX <span style="font-weight:bold">-</span> rY
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># concat all variables</span>
</span></span><span style="display:flex;"><span>        df <span style="font-weight:bold">=</span> pd<span style="font-weight:bold">.</span>concat([X, Y, rX, rY, spread, N], axis<span style="font-weight:bold">=</span><span style="color:#099">1</span>)<span style="font-weight:bold">.</span>dropna()
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">del</span> X, Y, rX, rY, spread, N
</span></span><span style="display:flex;"><span>        df<span style="font-weight:bold">.</span>columns <span style="font-weight:bold">=</span> [<span style="color:#b84">&#39;X&#39;</span>, <span style="color:#b84">&#39;Y&#39;</span>, <span style="color:#b84">&#39;rX&#39;</span>, <span style="color:#b84">&#39;rY&#39;</span>, <span style="color:#b84">&#39;spread&#39;</span>, <span style="color:#b84">&#39;N&#39;</span>]
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df <span style="font-weight:bold">=</span> df
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">__update_params</span>(self, M, g, j, s):  <span style="color:#998;font-style:italic"># update parameters of the model</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER:
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            M: integer
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            g: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            j: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            s: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: None
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">assert</span> <span style="color:#999">isinstance</span>(M, (<span style="color:#999">int</span>, np<span style="font-weight:bold">.</span>integer)) <span style="font-weight:bold">and</span> (M <span style="font-weight:bold">&gt;</span> <span style="color:#099">0</span>), \
</span></span><span style="display:flex;"><span>               <span style="color:#b84">&#39;parameter M should be a positive integer&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">assert</span> <span style="font-weight:bold">-</span>g <span style="font-weight:bold">&lt;</span> j <span style="font-weight:bold">&lt;</span> g, <span style="color:#b84">&#39;parameter j and g should follow -g &lt; j &lt; g&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">assert</span> <span style="color:#099">0</span> <span style="font-weight:bold">&lt;</span> s, <span style="color:#b84">&#39;parameter s should be positive&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__M <span style="font-weight:bold">=</span> M
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__g <span style="font-weight:bold">=</span> g
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__j <span style="font-weight:bold">=</span> j
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__s <span style="font-weight:bold">=</span> s
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__process_data()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @staticmethod
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">__posval</span>(position, price1, price2, gross<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>):  <span style="color:#998;font-style:italic"># calculate value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER:
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            position: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            price1: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            price2: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            grodd: boolean (default: False)
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> gross:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">return</span> <span style="color:#999">abs</span>(position[<span style="color:#099">0</span>]) <span style="font-weight:bold">*</span> price1 <span style="font-weight:bold">+</span> <span style="color:#999">abs</span>(position[<span style="color:#099">1</span>]) <span style="font-weight:bold">*</span> price2
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">return</span> position[<span style="color:#099">0</span>] <span style="font-weight:bold">*</span> price1 <span style="font-weight:bold">+</span> position[<span style="color:#099">1</span>] <span style="font-weight:bold">*</span> price2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">__pos</span>(self, value, X, Y, longX<span style="font-weight:bold">=</span><span style="font-weight:bold">True</span>):  <span style="color:#998;font-style:italic"># calculate positions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER:
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            value: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            X: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            Y: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            longX: boolean (default: True)
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: (float, float)
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pX <span style="font-weight:bold">=</span> <span style="color:#999">round</span>(value <span style="font-weight:bold">/</span> X) <span style="font-weight:bold">*</span> <span style="color:#999">abs</span>(self<span style="font-weight:bold">.</span>__ratio)
</span></span><span style="display:flex;"><span>        pY <span style="font-weight:bold">=</span> <span style="color:#999">round</span>(value <span style="font-weight:bold">/</span> Y) <span style="font-weight:bold">*</span> (<span style="color:#099">1</span> <span style="font-weight:bold">if</span> self<span style="font-weight:bold">.</span>__ratio <span style="font-weight:bold">&gt;</span> <span style="color:#099">0</span> <span style="font-weight:bold">else</span> <span style="font-weight:bold">-</span><span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> (pX, <span style="font-weight:bold">-</span>pY) <span style="font-weight:bold">if</span> longX <span style="font-weight:bold">else</span> (<span style="font-weight:bold">-</span>pX, pY)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @staticmethod
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">__sharpe_ratio</span>(daily_rtn):  <span style="color:#998;font-style:italic"># calculate sharpe ratio</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER:
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            daily_rtn: pd.Series of float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> daily_rtn<span style="font-weight:bold">.</span>mean() <span style="font-weight:bold">/</span> daily_rtn<span style="font-weight:bold">.</span>std()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @staticmethod
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">__sortino_ratio</span>(daily_rtn):  <span style="color:#998;font-style:italic"># calculate sortino ratio</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER:
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            daily_rtn: pd.Series of float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        daily_rtn <span style="font-weight:bold">=</span> daily_rtn<span style="font-weight:bold">.</span>copy()
</span></span><span style="display:flex;"><span>        mean_rtn <span style="font-weight:bold">=</span> daily_rtn<span style="font-weight:bold">.</span>mean()
</span></span><span style="display:flex;"><span>        daily_rtn<span style="font-weight:bold">.</span>loc[daily_rtn <span style="font-weight:bold">&gt;</span> <span style="color:#099">0</span>] <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        downside_risk <span style="font-weight:bold">=</span> daily_rtn<span style="font-weight:bold">.</span>std()
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> mean_rtn <span style="font-weight:bold">/</span> downside_risk 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @staticmethod
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">__maximum_drawdown</span>(value):  <span style="color:#998;font-style:italic"># maximum drawdown</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER:
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            value: pd.Series of float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: (float, datetime, datetime)
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        end <span style="font-weight:bold">=</span> (value<span style="font-weight:bold">.</span>cummax() <span style="font-weight:bold">/</span> value)<span style="font-weight:bold">.</span>idxmax()
</span></span><span style="display:flex;"><span>        start <span style="font-weight:bold">=</span> (value<span style="font-weight:bold">.</span>loc[:end])<span style="font-weight:bold">.</span>idxmax()
</span></span><span style="display:flex;"><span>        mdd <span style="font-weight:bold">=</span> <span style="color:#099">1</span> <span style="font-weight:bold">-</span> value[end] <span style="font-weight:bold">/</span> value[start]
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> mdd, start, end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">run</span>(self, M, g, j, s, verbose<span style="font-weight:bold">=</span><span style="font-weight:bold">True</span>):  <span style="color:#998;font-style:italic"># run backtest using parameters</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER:
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            M: integer
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            g: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            j: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            s: float
</span></span></span><span style="display:flex;"><span><span style="color:#b84">            verbose: boolean (default: True)
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: None
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>__update_params(M, g, j, s)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        pX <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>        pY <span style="font-weight:bold">=</span> []  <span style="color:#998;font-style:italic"># positions</span>
</span></span><span style="display:flex;"><span>        rtn <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>        curr_position <span style="font-weight:bold">=</span> (<span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>        curr_rtn <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        prev_day <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        prev_cost <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        prev_gross_cost <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        spread <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">for</span> date <span style="font-weight:bold">in</span> self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> date<span style="font-weight:bold">.</span>day <span style="font-weight:bold">&lt;</span> prev_day:  <span style="color:#998;font-style:italic"># check start of new month</span>
</span></span><span style="display:flex;"><span>                daily_rtn <span style="font-weight:bold">=</span> curr_rtn
</span></span><span style="display:flex;"><span>                curr_position <span style="font-weight:bold">=</span> (<span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>                prev_cost <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                prev_gross_cost <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                self<span style="font-weight:bold">.</span>__trading <span style="font-weight:bold">=</span> <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">elif</span> self<span style="font-weight:bold">.</span>__trading:  <span style="color:#998;font-style:italic"># trading (never stop-lossed this month)</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">if</span> curr_rtn <span style="font-weight:bold">&lt;</span> <span style="font-weight:bold">-</span>self<span style="font-weight:bold">.</span>__s <span style="font-weight:bold">*</span> prev_gross_cost:  <span style="color:#998;font-style:italic"># stop loss</span>
</span></span><span style="display:flex;"><span>                    self<span style="font-weight:bold">.</span>__stop_loss_dates<span style="font-weight:bold">.</span>append(date)
</span></span><span style="display:flex;"><span>                    daily_rtn <span style="font-weight:bold">=</span> curr_rtn
</span></span><span style="display:flex;"><span>                    curr_position <span style="font-weight:bold">=</span> (<span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>                    prev_cost <span style="font-weight:bold">=</span> prev_gross_cost <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                    self<span style="font-weight:bold">.</span>__trading <span style="font-weight:bold">=</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">if</span> curr_position[<span style="color:#099">0</span>] <span style="font-weight:bold">&gt;</span> <span style="color:#099">1</span>:  <span style="color:#998;font-style:italic"># currently long in X</span>
</span></span><span style="display:flex;"><span>                        daily_rtn <span style="font-weight:bold">=</span> curr_rtn
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">if</span> spread <span style="font-weight:bold">&gt;</span> self<span style="font-weight:bold">.</span>__g:  <span style="color:#998;font-style:italic"># direactly from long to short</span>
</span></span><span style="display:flex;"><span>                            curr_position <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__pos(N <span style="font-weight:bold">/</span> <span style="color:#099">100</span>, X, Y, <span style="font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>                            prev_cost <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y)
</span></span><span style="display:flex;"><span>                            prev_gross_cost <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">elif</span> spread <span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">-</span>self<span style="font-weight:bold">.</span>__j:  <span style="color:#998;font-style:italic"># close position</span>
</span></span><span style="display:flex;"><span>                            curr_position <span style="font-weight:bold">=</span> (<span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>                            prev_cost <span style="font-weight:bold">=</span> prev_gross_cost <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">elif</span> curr_position[<span style="color:#099">0</span>] <span style="font-weight:bold">&lt;</span> <span style="font-weight:bold">-</span><span style="color:#099">1</span>:  <span style="color:#998;font-style:italic"># currently short in X</span>
</span></span><span style="display:flex;"><span>                        daily_rtn <span style="font-weight:bold">=</span> curr_rtn
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">if</span> spread <span style="font-weight:bold">&lt;</span> <span style="font-weight:bold">-</span>self<span style="font-weight:bold">.</span>__g:  <span style="color:#998;font-style:italic"># directly from short to long</span>
</span></span><span style="display:flex;"><span>                            curr_position <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__pos(N <span style="font-weight:bold">/</span> <span style="color:#099">100</span>, X, Y, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                            prev_cost <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y)
</span></span><span style="display:flex;"><span>                            prev_gross_cost <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">elif</span> spread <span style="font-weight:bold">&lt;</span> self<span style="font-weight:bold">.</span>__j:  <span style="color:#998;font-style:italic"># close position</span>
</span></span><span style="display:flex;"><span>                            curr_position <span style="font-weight:bold">=</span> (<span style="color:#099">0</span>, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>                            prev_cost <span style="font-weight:bold">=</span> prev_gross_cost <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">else</span>:  <span style="color:#998;font-style:italic"># currently having no position</span>
</span></span><span style="display:flex;"><span>                        daily_rtn <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">if</span> spread <span style="font-weight:bold">&gt;</span> self<span style="font-weight:bold">.</span>__g:  <span style="color:#998;font-style:italic"># open short position</span>
</span></span><span style="display:flex;"><span>                            curr_position <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__pos(N <span style="font-weight:bold">/</span> <span style="color:#099">100</span>, X, Y, <span style="font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>                            prev_cost <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y)
</span></span><span style="display:flex;"><span>                            prev_gross_cost <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">elif</span> spread <span style="font-weight:bold">&lt;</span> <span style="font-weight:bold">-</span>self<span style="font-weight:bold">.</span>__g:  <span style="color:#998;font-style:italic"># open long position</span>
</span></span><span style="display:flex;"><span>                            curr_position <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__pos(N <span style="font-weight:bold">/</span> <span style="color:#099">100</span>, X, Y, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                            prev_cost <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y)
</span></span><span style="display:flex;"><span>                            prev_gross_cost <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">else</span>:  <span style="color:#998;font-style:italic"># ceased until next month</span>
</span></span><span style="display:flex;"><span>                daily_rtn <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            spread, X, Y, N <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>df[[<span style="color:#b84">&#39;spread&#39;</span>, <span style="color:#b84">&#39;X&#39;</span>, <span style="color:#b84">&#39;Y&#39;</span>, <span style="color:#b84">&#39;N&#39;</span>]]<span style="font-weight:bold">.</span>loc[date]
</span></span><span style="display:flex;"><span>            curr_rtn <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__posval(curr_position, X, Y) <span style="font-weight:bold">-</span> prev_cost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            pX<span style="font-weight:bold">.</span>append(curr_position[<span style="color:#099">0</span>])
</span></span><span style="display:flex;"><span>            pY<span style="font-weight:bold">.</span>append(curr_position[<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>            rtn<span style="font-weight:bold">.</span>append(daily_rtn)
</span></span><span style="display:flex;"><span>            prev_day <span style="font-weight:bold">=</span> date<span style="font-weight:bold">.</span>day
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df[<span style="color:#b84">&#39;pX&#39;</span>] <span style="font-weight:bold">=</span> pX
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df[<span style="color:#b84">&#39;pY&#39;</span>] <span style="font-weight:bold">=</span> pY
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df[<span style="color:#b84">&#39;daily_rtn&#39;</span>] <span style="font-weight:bold">=</span> rtn
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>daily_rtn <span style="font-weight:bold">/=</span> self<span style="font-weight:bold">.</span>__K  <span style="color:#998;font-style:italic"># rtn is stored in %</span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df[<span style="color:#b84">&#39;cum_rtn&#39;</span>] <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>daily_rtn<span style="font-weight:bold">.</span>cumsum()
</span></span><span style="display:flex;"><span>        sortino <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__sortino_ratio(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>daily_rtn)
</span></span><span style="display:flex;"><span>        sharpe <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__sharpe_ratio(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>daily_rtn)
</span></span><span style="display:flex;"><span>        mdd <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__maximum_drawdown(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>cum_rtn <span style="font-weight:bold">+</span> self<span style="font-weight:bold">.</span>__K)[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>        yoy_rtn <span style="font-weight:bold">=</span> (<span style="color:#099">1</span> <span style="font-weight:bold">+</span> self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>cum_rtn[<span style="font-weight:bold">-</span><span style="color:#099">1</span>])<span style="font-weight:bold">**</span>(<span style="color:#099">250</span> <span style="font-weight:bold">/</span> self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>shape[<span style="color:#099">0</span>]) <span style="font-weight:bold">-</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> verbose: self<span style="font-weight:bold">.</span>__plot()
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> sortino, sharpe, mdd, yoy_rtn
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">__plot</span>(self):  <span style="color:#998;font-style:italic"># plot backtest results</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        PARAMETER: None
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        RETURN: None
</span></span></span><span style="display:flex;"><span><span style="color:#b84">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        fig <span style="font-weight:bold">=</span> plt<span style="font-weight:bold">.</span>figure(figsize<span style="font-weight:bold">=</span>(<span style="color:#099">20</span>, <span style="color:#099">15</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ax1 <span style="font-weight:bold">=</span> fig<span style="font-weight:bold">.</span>add_subplot(<span style="color:#099">221</span>)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>rX<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax1, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;X&#39;</span>, alpha<span style="font-weight:bold">=</span><span style="color:#099">.5</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;darkgreen&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>rY<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax1, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;Y&#39;</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;pink&#39;</span>)
</span></span><span style="display:flex;"><span>        ax1<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Returns&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>spread<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax1, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;spread&#39;</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>xticks(rotation<span style="font-weight:bold">=</span><span style="color:#099">0</span>, ha<span style="font-weight:bold">=</span><span style="color:#b84">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>legend(frameon<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>, loc<span style="font-weight:bold">=</span><span style="color:#b84">&#39;upper right&#39;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ax2 <span style="font-weight:bold">=</span> fig<span style="font-weight:bold">.</span>add_subplot(<span style="color:#099">222</span>)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>spread<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax2, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;spread&#39;</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>        ax2<span style="font-weight:bold">.</span>plot((<span style="color:#999">min</span>(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index), <span style="color:#999">max</span>(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index)),
</span></span><span style="display:flex;"><span>                 (self<span style="font-weight:bold">.</span>__g, self<span style="font-weight:bold">.</span>__g), <span style="color:#b84">&#39;c--&#39;</span>, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;$\pm$g&#39;</span>)
</span></span><span style="display:flex;"><span>        ax2<span style="font-weight:bold">.</span>plot((<span style="color:#999">min</span>(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index), <span style="color:#999">max</span>(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index)),
</span></span><span style="display:flex;"><span>                 (self<span style="font-weight:bold">.</span>__j, self<span style="font-weight:bold">.</span>__j), <span style="color:#b84">&#39;r--&#39;</span>, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;$\pm$j&#39;</span>)
</span></span><span style="display:flex;"><span>        ax2<span style="font-weight:bold">.</span>plot((<span style="color:#999">min</span>(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index), <span style="color:#999">max</span>(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index)),
</span></span><span style="display:flex;"><span>                 (<span style="font-weight:bold">-</span>self<span style="font-weight:bold">.</span>__g, <span style="font-weight:bold">-</span>self<span style="font-weight:bold">.</span>__g), <span style="color:#b84">&#39;c--&#39;</span>)
</span></span><span style="display:flex;"><span>        ax2<span style="font-weight:bold">.</span>plot((<span style="color:#999">min</span>(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index), <span style="color:#999">max</span>(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>index)),
</span></span><span style="display:flex;"><span>                 (<span style="font-weight:bold">-</span>self<span style="font-weight:bold">.</span>__j, <span style="font-weight:bold">-</span>self<span style="font-weight:bold">.</span>__j), <span style="color:#b84">&#39;r--&#39;</span>)
</span></span><span style="display:flex;"><span>        ax2<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Spread&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>xticks(rotation<span style="font-weight:bold">=</span><span style="color:#099">0</span>, ha<span style="font-weight:bold">=</span><span style="color:#b84">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>legend(frameon<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        mdd, sd, ed <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>__maximum_drawdown(self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>cum_rtn <span style="font-weight:bold">+</span> self<span style="font-weight:bold">.</span>__K)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ax3 <span style="font-weight:bold">=</span> fig<span style="font-weight:bold">.</span>add_subplot(<span style="color:#099">223</span>)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>N<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax3, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;N&#39;</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>        ax3<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Total Dollar Volumes&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>legend(frameon<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>, loc<span style="font-weight:bold">=</span><span style="color:#b84">&#39;upper left&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>xticks(rotation<span style="font-weight:bold">=</span><span style="color:#099">0</span>, ha<span style="font-weight:bold">=</span><span style="color:#b84">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>        ax3_ <span style="font-weight:bold">=</span> ax3<span style="font-weight:bold">.</span>twinx()
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>pX<span style="font-weight:bold">.</span>abs()<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax3_, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;position&#39;</span>, alpha<span style="font-weight:bold">=</span><span style="color:#099">.5</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;r&#39;</span>)
</span></span><span style="display:flex;"><span>        ax3_<span style="font-weight:bold">.</span>ticklabel_format(axis<span style="font-weight:bold">=</span><span style="color:#b84">&#39;y&#39;</span>, style<span style="font-weight:bold">=</span><span style="color:#b84">&#39;sci&#39;</span>, scilimits<span style="font-weight:bold">=</span>(<span style="color:#099">5</span>, <span style="color:#099">5</span>))
</span></span><span style="display:flex;"><span>        ax3_<span style="font-weight:bold">.</span>axvspan(xmin<span style="font-weight:bold">=</span>sd, xmax<span style="font-weight:bold">=</span>ed, ymin<span style="font-weight:bold">=</span><span style="color:#099">0</span>, ymax<span style="font-weight:bold">=</span><span style="color:#099">1</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;grey&#39;</span>, alpha<span style="font-weight:bold">=</span><span style="color:#099">.5</span>)
</span></span><span style="display:flex;"><span>        ax3_<span style="font-weight:bold">.</span>set_ylim(ymin<span style="font-weight:bold">=</span><span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>        ax3_<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Daily Position (Long)&#39;</span>)
</span></span><span style="display:flex;"><span>        ax3<span style="font-weight:bold">.</span>grid(<span style="font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>legend(frameon<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>, loc<span style="font-weight:bold">=</span><span style="color:#b84">&#39;upper right&#39;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ax4 <span style="font-weight:bold">=</span> fig<span style="font-weight:bold">.</span>add_subplot(<span style="color:#099">224</span>)
</span></span><span style="display:flex;"><span>        ax4<span style="font-weight:bold">.</span>axvspan(xmin<span style="font-weight:bold">=</span>sd, xmax<span style="font-weight:bold">=</span>ed, ymin<span style="font-weight:bold">=</span><span style="color:#099">0</span>, ymax<span style="font-weight:bold">=</span><span style="color:#099">1</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;grey&#39;</span>, alpha<span style="font-weight:bold">=</span><span style="color:#099">.5</span>)
</span></span><span style="display:flex;"><span>        (self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>daily_rtn <span style="font-weight:bold">*</span> <span style="color:#099">100</span>)<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax4, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;Daily Return (%)&#39;</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;c&#39;</span>)
</span></span><span style="display:flex;"><span>        (self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>cum_rtn <span style="font-weight:bold">*</span> <span style="color:#099">100</span>)<span style="font-weight:bold">.</span>plot(ax<span style="font-weight:bold">=</span>ax4, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;Cum. Return (%)&#39;</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;r&#39;</span>)
</span></span><span style="display:flex;"><span>        ax4<span style="font-weight:bold">.</span>scatter(self<span style="font-weight:bold">.</span>__stop_loss_dates,
</span></span><span style="display:flex;"><span>                    self<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>cum_rtn<span style="font-weight:bold">.</span>loc[self<span style="font-weight:bold">.</span>__stop_loss_dates] <span style="font-weight:bold">*</span> <span style="color:#099">100</span>,
</span></span><span style="display:flex;"><span>                    marker<span style="font-weight:bold">=</span><span style="color:#b84">&#39;x&#39;</span>, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;k&#39;</span>, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;&#39;</span>, zorder<span style="font-weight:bold">=</span><span style="color:#099">10</span>)
</span></span><span style="display:flex;"><span>        ax4<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Return (%)&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>xticks(rotation<span style="font-weight:bold">=</span><span style="color:#099">0</span>, ha<span style="font-weight:bold">=</span><span style="color:#b84">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>legend(frameon<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>tight_layout()
</span></span><span style="display:flex;"><span>        plt<span style="font-weight:bold">.</span>show()
</span></span></code></pre></div><p>Here for illustration, we make a test run with parameters <code>M</code>=5, <code>g</code>=0.010, <code>j</code>=0.005 and <code>s</code>=0.01. The timespan, as required throughout the analysis, is set from <code>2016-12-02</code> to <code>2018-12-31</code> inclusive. The special meta parameter <code>ratio</code> is set to -3.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>be <span style="font-weight:bold">=</span> BacktestEngine(<span style="color:#b84">&#39;DRIP&#39;</span>, <span style="color:#b84">&#39;XOP&#39;</span>, start_date<span style="font-weight:bold">=</span><span style="color:#b84">&#39;2016-12-02&#39;</span>, end_date<span style="font-weight:bold">=</span><span style="color:#b84">&#39;2018-12-31&#39;</span>, ratio<span style="font-weight:bold">=-</span><span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>st, sr, md, rt <span style="font-weight:bold">=</span> be<span style="font-weight:bold">.</span>run(M<span style="font-weight:bold">=</span><span style="color:#099">5</span>, g<span style="font-weight:bold">=</span><span style="color:#099">0.02</span>, j<span style="font-weight:bold">=</span><span style="color:#099">0.01</span>, s<span style="font-weight:bold">=</span><span style="color:#099">0.01</span>, verbose<span style="font-weight:bold">=</span><span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#999">print</span>(<span style="color:#b84">&#39;Sortino Ratio=</span><span style="color:#b84">{:.4f}</span><span style="color:#b84">, Sharpe Ratio=</span><span style="color:#b84">{:.4f}</span><span style="color:#b84">, Maximum Drawdown=</span><span style="color:#b84">{:.4g}</span><span style="color:#b84">, YoY Return=</span><span style="color:#b84">{:.2%}</span><span style="color:#b84">&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">.</span>format(st, sr, md ,rt))
</span></span></code></pre></div><p><img src="/images/spread2.png" alt=""></p>
<pre><code>Sortino Ratio=0.0574, Sharpe Ratio=0.0387, Maximum Drawdown=1.118e-11, YoY Return=0.09%
</code></pre>
<p>With only a Sortino ratio of 0.0574, a Sharpe ratio of 0.0387 and YoY return of 0.09%, it&rsquo;s definitely not a good strategy. Not to mention the unsatisfactory return plots. The top right subplot together with the bottom left one suggests that we might be using too wide thresholds. In case of detailed analysis, we can also take a look at <code>be.df</code> and specifically the trading days when we have non-zero positions, which turns out rather few (and supports our worry about wideness of thresholds):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>be<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>loc[be<span style="font-weight:bold">.</span>df<span style="font-weight:bold">.</span>pX <span style="font-weight:bold">!=</span> <span style="color:#099">0</span>]
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">X</th>
<th style="text-align:center">Y</th>
<th style="text-align:center">rX</th>
<th style="text-align:center">rY</th>
<th style="text-align:center">spread</th>
<th style="text-align:center">N</th>
<th style="text-align:center">pX</th>
<th style="text-align:center">pY</th>
<th style="text-align:center">daily_rtn</th>
<th style="text-align:center">cum_rtn</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2017-04-20</td>
<td style="text-align:center">19.072870</td>
<td style="text-align:center">34.413981</td>
<td style="text-align:center">0.191975</td>
<td style="text-align:center">0.178984</td>
<td style="text-align:center">0.012991</td>
<td style="text-align:center">1.533244e+07</td>
<td style="text-align:center">-25014</td>
<td style="text-align:center">-4643</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000000</td>
</tr>
<tr>
<td style="text-align:center">2017-04-21</td>
<td style="text-align:center">18.845694</td>
<td style="text-align:center">34.532005</td>
<td style="text-align:center">0.097182</td>
<td style="text-align:center">0.100743</td>
<td style="text-align:center">-0.003561</td>
<td style="text-align:center">1.496846e+07</td>
<td style="text-align:center">-25014</td>
<td style="text-align:center">-4643</td>
<td style="text-align:center">0.000011</td>
<td style="text-align:center">0.000011</td>
</tr>
<tr>
<td style="text-align:center">2017-06-12</td>
<td style="text-align:center">21.522415</td>
<td style="text-align:center">32.279704</td>
<td style="text-align:center">-0.076695</td>
<td style="text-align:center">-0.055866</td>
<td style="text-align:center">-0.020829</td>
<td style="text-align:center">9.166219e+06</td>
<td style="text-align:center">13122</td>
<td style="text-align:center">2984</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000056</td>
</tr>
<tr>
<td style="text-align:center">2017-08-04</td>
<td style="text-align:center">22.747188</td>
<td style="text-align:center">30.827585</td>
<td style="text-align:center">0.142928</td>
<td style="text-align:center">0.143423</td>
<td style="text-align:center">-0.000495</td>
<td style="text-align:center">1.754893e+07</td>
<td style="text-align:center">-21483</td>
<td style="text-align:center">-5827</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000029</td>
</tr>
<tr>
<td style="text-align:center">2017-11-02</td>
<td style="text-align:center">15.319535</td>
<td style="text-align:center">34.463445</td>
<td style="text-align:center">-0.210285</td>
<td style="text-align:center">-0.227637</td>
<td style="text-align:center">0.017352</td>
<td style="text-align:center">1.302198e+07</td>
<td style="text-align:center">-26349</td>
<td style="text-align:center">-3734</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000259</td>
</tr>
<tr>
<td style="text-align:center">2017-12-26</td>
<td style="text-align:center">11.398287</td>
<td style="text-align:center">37.260895</td>
<td style="text-align:center">-0.221848</td>
<td style="text-align:center">-0.249496</td>
<td style="text-align:center">0.027649</td>
<td style="text-align:center">1.189655e+07</td>
<td style="text-align:center">-29352</td>
<td style="text-align:center">-3264</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000180</td>
</tr>
<tr>
<td style="text-align:center">2017-12-27</td>
<td style="text-align:center">11.645217</td>
<td style="text-align:center">36.963916</td>
<td style="text-align:center">-0.200136</td>
<td style="text-align:center">-0.218041</td>
<td style="text-align:center">0.017905</td>
<td style="text-align:center">1.351392e+07</td>
<td style="text-align:center">-29352</td>
<td style="text-align:center">-3264</td>
<td style="text-align:center">0.000135</td>
<td style="text-align:center">0.000315</td>
</tr>
<tr>
<td style="text-align:center">2017-12-28</td>
<td style="text-align:center">11.418041</td>
<td style="text-align:center">37.241096</td>
<td style="text-align:center">-0.152493</td>
<td style="text-align:center">-0.163117</td>
<td style="text-align:center">0.010624</td>
<td style="text-align:center">1.189655e+07</td>
<td style="text-align:center">-29352</td>
<td style="text-align:center">-3264</td>
<td style="text-align:center">0.000092</td>
<td style="text-align:center">0.000406</td>
</tr>
<tr>
<td style="text-align:center">2017-12-29</td>
<td style="text-align:center">11.714357</td>
<td style="text-align:center">36.805528</td>
<td style="text-align:center">-0.054226</td>
<td style="text-align:center">-0.042553</td>
<td style="text-align:center">-0.011673</td>
<td style="text-align:center">1.246303e+07</td>
<td style="text-align:center">-29352</td>
<td style="text-align:center">-3264</td>
<td style="text-align:center">0.000131</td>
<td style="text-align:center">0.000537</td>
</tr>
<tr>
<td style="text-align:center">2018-02-05</td>
<td style="text-align:center">14.331815</td>
<td style="text-align:center">34.023830</td>
<td style="text-align:center">0.357343</td>
<td style="text-align:center">0.307833</td>
<td style="text-align:center">0.049510</td>
<td style="text-align:center">1.823786e+07</td>
<td style="text-align:center">-40842</td>
<td style="text-align:center">-5061</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000619</td>
</tr>
<tr>
<td style="text-align:center">2018-03-28</td>
<td style="text-align:center">13.193795</td>
<td style="text-align:center">33.978894</td>
<td style="text-align:center">0.097942</td>
<td style="text-align:center">0.103973</td>
<td style="text-align:center">-0.006031</td>
<td style="text-align:center">2.054748e+07</td>
<td style="text-align:center">52227</td>
<td style="text-align:center">6579</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000305</td>
</tr>
<tr>
<td style="text-align:center">2018-04-03</td>
<td style="text-align:center">12.630042</td>
<td style="text-align:center">34.326023</td>
<td style="text-align:center">0.045008</td>
<td style="text-align:center">0.062801</td>
<td style="text-align:center">-0.017792</td>
<td style="text-align:center">2.304128e+07</td>
<td style="text-align:center">51093</td>
<td style="text-align:center">6703</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000390</td>
</tr>
<tr>
<td style="text-align:center">2018-05-11</td>
<td style="text-align:center">7.140870</td>
<td style="text-align:center">40.931377</td>
<td style="text-align:center">-0.120585</td>
<td style="text-align:center">-0.125726</td>
<td style="text-align:center">0.005141</td>
<td style="text-align:center">3.427444e+07</td>
<td style="text-align:center">-150390</td>
<td style="text-align:center">-8464</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000188</td>
</tr>
<tr>
<td style="text-align:center">2018-08-23</td>
<td style="text-align:center">6.237512</td>
<td style="text-align:center">41.241724</td>
<td style="text-align:center">-0.144022</td>
<td style="text-align:center">-0.155054</td>
<td style="text-align:center">0.011033</td>
<td style="text-align:center">2.413513e+07</td>
<td style="text-align:center">-118650</td>
<td style="text-align:center">-5898</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000023</td>
</tr>
<tr>
<td style="text-align:center">2018-08-24</td>
<td style="text-align:center">6.039495</td>
<td style="text-align:center">41.778234</td>
<td style="text-align:center">-0.157459</td>
<td style="text-align:center">-0.177582</td>
<td style="text-align:center">0.020123</td>
<td style="text-align:center">2.205453e+07</td>
<td style="text-align:center">-118650</td>
<td style="text-align:center">-5898</td>
<td style="text-align:center">-0.000041</td>
<td style="text-align:center">-0.000018</td>
</tr>
<tr>
<td style="text-align:center">2018-08-27</td>
<td style="text-align:center">5.960289</td>
<td style="text-align:center">41.877588</td>
<td style="text-align:center">-0.146099</td>
<td style="text-align:center">-0.152580</td>
<td style="text-align:center">0.006481</td>
<td style="text-align:center">2.155575e+07</td>
<td style="text-align:center">-118650</td>
<td style="text-align:center">-5898</td>
<td style="text-align:center">0.000098</td>
<td style="text-align:center">0.000081</td>
</tr>
<tr>
<td style="text-align:center">2018-10-24</td>
<td style="text-align:center">9.096368</td>
<td style="text-align:center">35.500295</td>
<td style="text-align:center">0.494290</td>
<td style="text-align:center">0.398785</td>
<td style="text-align:center">0.095505</td>
<td style="text-align:center">3.827526e+07</td>
<td style="text-align:center">-146172</td>
<td style="text-align:center">-9913</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000239</td>
</tr>
<tr>
<td style="text-align:center">2018-11-12</td>
<td style="text-align:center">9.106299</td>
<td style="text-align:center">34.953065</td>
<td style="text-align:center">0.168153</td>
<td style="text-align:center">0.166935</td>
<td style="text-align:center">0.001217</td>
<td style="text-align:center">4.281623e+07</td>
<td style="text-align:center">156027</td>
<td style="text-align:center">11825</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">-0.001016</td>
</tr>
<tr>
<td style="text-align:center">2018-11-14</td>
<td style="text-align:center">9.801436</td>
<td style="text-align:center">34.107346</td>
<td style="text-align:center">0.324832</td>
<td style="text-align:center">0.280804</td>
<td style="text-align:center">0.044028</td>
<td style="text-align:center">4.281623e+07</td>
<td style="text-align:center">-141351</td>
<td style="text-align:center">-13473</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">-0.000185</td>
</tr>
<tr>
<td style="text-align:center">2018-11-15</td>
<td style="text-align:center">9.364493</td>
<td style="text-align:center">34.614778</td>
<td style="text-align:center">0.136145</td>
<td style="text-align:center">0.133480</td>
<td style="text-align:center">0.002665</td>
<td style="text-align:center">4.050823e+07</td>
<td style="text-align:center">-141351</td>
<td style="text-align:center">-13473</td>
<td style="text-align:center">0.000016</td>
<td style="text-align:center">-0.000169</td>
</tr>
<tr>
<td style="text-align:center">2018-11-23</td>
<td style="text-align:center">11.211572</td>
<td style="text-align:center">32.336311</td>
<td style="text-align:center">0.197243</td>
<td style="text-align:center">0.197471</td>
<td style="text-align:center">-0.000228</td>
<td style="text-align:center">4.050823e+07</td>
<td style="text-align:center">120567</td>
<td style="text-align:center">12081</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.000222</td>
</tr>
<tr>
<td style="text-align:center">2018-12-06</td>
<td style="text-align:center">11.797473</td>
<td style="text-align:center">31.520441</td>
<td style="text-align:center">0.111319</td>
<td style="text-align:center">0.125227</td>
<td style="text-align:center">-0.013908</td>
<td style="text-align:center">3.503895e+07</td>
<td style="text-align:center">97920</td>
<td style="text-align:center">10763</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.001057</td>
</tr>
<tr>
<td style="text-align:center">2018-12-07</td>
<td style="text-align:center">11.906709</td>
<td style="text-align:center">31.381147</td>
<td style="text-align:center">0.147368</td>
<td style="text-align:center">0.155996</td>
<td style="text-align:center">-0.008628</td>
<td style="text-align:center">3.503895e+07</td>
<td style="text-align:center">97920</td>
<td style="text-align:center">10763</td>
<td style="text-align:center">0.000635</td>
<td style="text-align:center">0.001692</td>
</tr>
<tr>
<td style="text-align:center">2018-12-12</td>
<td style="text-align:center">12.989137</td>
<td style="text-align:center">30.475730</td>
<td style="text-align:center">0.209991</td>
<td style="text-align:center">0.191626</td>
<td style="text-align:center">0.018365</td>
<td style="text-align:center">4.187946e+07</td>
<td style="text-align:center">-89073</td>
<td style="text-align:center">-12988</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.002391</td>
</tr>
<tr>
<td style="text-align:center">2018-12-13</td>
<td style="text-align:center">13.187748</td>
<td style="text-align:center">30.286687</td>
<td style="text-align:center">0.117845</td>
<td style="text-align:center">0.117424</td>
<td style="text-align:center">0.000421</td>
<td style="text-align:center">3.936253e+07</td>
<td style="text-align:center">-89073</td>
<td style="text-align:center">-12988</td>
<td style="text-align:center">0.000148</td>
<td style="text-align:center">0.002539</td>
</tr>
<tr>
<td style="text-align:center">2018-12-17</td>
<td style="text-align:center">16.375449</td>
<td style="text-align:center">28.077868</td>
<td style="text-align:center">0.248297</td>
<td style="text-align:center">0.226081</td>
<td style="text-align:center">0.022215</td>
<td style="text-align:center">4.187946e+07</td>
<td style="text-align:center">-78804</td>
<td style="text-align:center">-13600</td>
<td style="text-align:center">0.000000</td>
<td style="text-align:center">0.002583</td>
</tr>
</tbody>
</table>
<h1 id="parameter-tuning">Parameter Tuning</h1>
<p>As mentioned above, in this section we try to fit the best set of parameters from <code>2015-12-02</code> to <code>2016-12-01</code>, i.e. the training set. As the focus of this report is not about efficient optimization, we opt for a simple grid search here. The parameter grids are defined as</p>
<ul>
<li><code>M_grid</code>: 5, 10, 15, 20 (4 in total)</li>
<li><code>g_grid</code>: 0.001, 0.003, &hellip;, 0.011 (6 in total)</li>
<li><code>j_grid</code>: -0.010, -0.008, &hellip;, 0.010 (11 in total)</li>
<li><code>s_grid</code>: 1e-3, 5e-3, 1e-2, 5e-2, 1e-1 (5 in total)</li>
</ul>
<p>So no more than 1320 simulations are run. Note here parameter combinations where <code>-g &lt; j &lt; g</code> does not hold are neglected. Below are a selection of outstanding parameter sets during simulation.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">time</span> <span style="font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">itertools</span> <span style="font-weight:bold">import</span> product
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">record</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># record function with closure designed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># to keep track of the best parameters</span>
</span></span><span style="display:flex;"><span>    record<span style="font-weight:bold">.</span>best <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">f</span>(<span style="font-weight:bold">*</span>args):
</span></span><span style="display:flex;"><span>        record<span style="font-weight:bold">.</span>best<span style="font-weight:bold">.</span>append((<span style="font-weight:bold">*</span>args,))
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mst, msr, mmd, mrt <span style="font-weight:bold">=</span> <span style="color:#099">0</span>, <span style="color:#099">0</span>, <span style="color:#099">1</span>, <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>M_grid <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>arange(<span style="color:#099">5</span>, <span style="color:#099">25</span>, <span style="color:#099">5</span>)
</span></span><span style="display:flex;"><span>g_grid <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>arange(<span style="color:#099">0.001</span>, <span style="color:#099">0.012</span>, <span style="color:#099">0.002</span>)
</span></span><span style="display:flex;"><span>j_grid <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>arange(<span style="font-weight:bold">-</span><span style="color:#099">0.010</span>, <span style="color:#099">0.011</span>, <span style="color:#099">0.002</span>)
</span></span><span style="display:flex;"><span>s_grid <span style="font-weight:bold">=</span> [<span style="color:#099">1e-3</span>, <span style="color:#099">5e-3</span>, <span style="color:#099">0.01</span>, <span style="color:#099">0.05</span>, <span style="color:#099">0.10</span>]
</span></span><span style="display:flex;"><span>nsim <span style="font-weight:bold">=</span> <span style="color:#999">len</span>(M_grid) <span style="font-weight:bold">*</span> <span style="color:#999">len</span>(g_grid) <span style="font-weight:bold">*</span> <span style="color:#999">len</span>(j_grid) <span style="font-weight:bold">*</span> <span style="color:#999">len</span>(s_grid)
</span></span><span style="display:flex;"><span>report_params <span style="font-weight:bold">=</span> record()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>be <span style="font-weight:bold">=</span> BacktestEngine(<span style="color:#b84">&#39;DRIP&#39;</span>, <span style="color:#b84">&#39;XOP&#39;</span>, start_date<span style="font-weight:bold">=</span><span style="color:#b84">&#39;2015-12-02&#39;</span>, end_date<span style="font-weight:bold">=</span><span style="color:#b84">&#39;2016-12-01&#39;</span>, ratio<span style="font-weight:bold">=-</span><span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>start_time <span style="font-weight:bold">=</span> time()
</span></span><span style="display:flex;"><span><span style="font-weight:bold">for</span> i, params <span style="font-weight:bold">in</span> <span style="color:#999">enumerate</span>(product(M_grid, g_grid, j_grid, s_grid)):
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        st, sr, md, rt <span style="font-weight:bold">=</span> be<span style="font-weight:bold">.</span>run(<span style="font-weight:bold">*</span>params, verbose<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> np<span style="font-weight:bold">.</span>isnan(sr) <span style="font-weight:bold">or</span> sr <span style="font-weight:bold">&lt;</span> <span style="color:#099">0</span> <span style="font-weight:bold">or</span> st <span style="font-weight:bold">&lt;</span> <span style="color:#099">0</span>: <span style="font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>        report <span style="font-weight:bold">=</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> st <span style="font-weight:bold">&gt;</span> mst: mst, report <span style="font-weight:bold">=</span> st, <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> sr <span style="font-weight:bold">&gt;</span> msr: msr, report <span style="font-weight:bold">=</span> sr, <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> md <span style="font-weight:bold">&lt;</span> mmd: mmd, report <span style="font-weight:bold">=</span> md, <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> rt <span style="font-weight:bold">&gt;</span> mrt: mrt, report <span style="font-weight:bold">=</span> rt, <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        prog <span style="font-weight:bold">=</span> (i <span style="font-weight:bold">+</span> <span style="color:#099">1</span>) <span style="font-weight:bold">/</span> nsim
</span></span><span style="display:flex;"><span>        current_time <span style="font-weight:bold">=</span> time()
</span></span><span style="display:flex;"><span>        elapse <span style="font-weight:bold">=</span> current_time <span style="font-weight:bold">-</span> start_time
</span></span><span style="display:flex;"><span>        eta <span style="font-weight:bold">=</span> elapse <span style="font-weight:bold">/</span> prog <span style="font-weight:bold">*</span> (<span style="color:#099">1</span> <span style="font-weight:bold">-</span> prog)
</span></span><span style="display:flex;"><span>        <span style="color:#999">print</span>(<span style="color:#b84">&#39;Running </span><span style="color:#b84">{}</span><span style="color:#b84"> simulations... </span><span style="color:#b84">{:.2%}</span><span style="color:#b84"> finished, ETA=</span><span style="color:#b84">{:.0f}</span><span style="color:#b84">s&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">.</span>format(nsim, prog, eta) <span style="font-weight:bold">+</span> <span style="color:#b84">&#39; &#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">10</span>, end<span style="font-weight:bold">=</span><span style="color:#b84">&#39;</span><span style="color:#b84">\r</span><span style="color:#b84">&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> report: report_params(<span style="font-weight:bold">*</span>params, st, sr, md, rt)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">except</span> <span style="color:#900;font-weight:bold">AssertionError</span>:  <span style="color:#998;font-style:italic"># (-g &lt; j &lt; g) does not hold</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>st_list, sr_list, md_list, rt_list <span style="font-weight:bold">=</span> <span style="color:#999">list</span>(<span style="color:#999">zip</span>(<span style="font-weight:bold">*</span>record<span style="font-weight:bold">.</span>best))[<span style="font-weight:bold">-</span><span style="color:#099">4</span>:]
</span></span><span style="display:flex;"><span>record<span style="font-weight:bold">.</span>best <span style="font-weight:bold">=</span> [entries <span style="font-weight:bold">for</span> _, entries <span style="font-weight:bold">in</span> <span style="color:#999">sorted</span>(<span style="color:#999">zip</span>(st_list, record<span style="font-weight:bold">.</span>best))][<span style="font-weight:bold">-</span><span style="color:#099">5</span>:]
</span></span><span style="display:flex;"><span>record<span style="font-weight:bold">.</span>best <span style="font-weight:bold">=</span> [entries <span style="font-weight:bold">for</span> _, entries <span style="font-weight:bold">in</span> <span style="color:#999">sorted</span>(<span style="color:#999">zip</span>(sr_list, record<span style="font-weight:bold">.</span>best))][<span style="font-weight:bold">-</span><span style="color:#099">5</span>:]
</span></span><span style="display:flex;"><span>record<span style="font-weight:bold">.</span>best <span style="font-weight:bold">=</span> [entries <span style="font-weight:bold">for</span> _, entries <span style="font-weight:bold">in</span> <span style="color:#999">sorted</span>(<span style="color:#999">zip</span>(rt_list, record<span style="font-weight:bold">.</span>best))][<span style="font-weight:bold">-</span><span style="color:#099">5</span>:]
</span></span><span style="display:flex;"><span>record<span style="font-weight:bold">.</span>best <span style="font-weight:bold">=</span> [entries <span style="font-weight:bold">for</span> _, entries <span style="font-weight:bold">in</span> <span style="color:#999">sorted</span>(<span style="color:#999">zip</span>(md_list, record<span style="font-weight:bold">.</span>best))][:<span style="color:#099">5</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">for</span> i, entries <span style="font-weight:bold">in</span> <span style="color:#999">enumerate</span>(record<span style="font-weight:bold">.</span>best):
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;(Record </span><span style="color:#b84">{:2}</span><span style="color:#b84">) M=</span><span style="color:#b84">{:&gt;2}</span><span style="color:#b84">, g=</span><span style="color:#b84">{:.3f}</span><span style="color:#b84">, j=</span><span style="color:#b84">{:6.3f}</span><span style="color:#b84">, s=</span><span style="color:#b84">{:.5f}</span><span style="color:#b84">,</span><span style="color:#b84">\t</span><span style="color:#b84">&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#b84">&#39;st=</span><span style="color:#b84">{:.4f}</span><span style="color:#b84"> sr=</span><span style="color:#b84">{:.4f}</span><span style="color:#b84">, md=</span><span style="color:#b84">{:9.4g}</span><span style="color:#b84">, rt=</span><span style="color:#b84">{:6.2%}</span><span style="color:#b84">&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">.</span>format(i, <span style="font-weight:bold">*</span>entries))
</span></span></code></pre></div><pre><code>(Record  0) M=15, g=0.007, j=-0.004, s=0.05000, st=1.4542 sr=0.3393, md=1.934e-10, rt= 8.99%
(Record  1) M=15, g=0.011, j=-0.010, s=0.05000, st=1.4591 sr=0.3430, md=1.673e-10, rt= 9.17%
(Record  2) M=20, g=0.007, j=-0.006, s=0.05000, st=1.5146 sr=0.3540, md=2.076e-10, rt= 9.47%
(Record  3) M=20, g=0.007, j= 0.006, s=0.05000, st=1.6001 sr=0.3534, md=  1.7e-10, rt= 9.33%
(Record  4) M=15, g=0.011, j=-0.004, s=0.05000, st=1.4680 sr=0.3452, md=1.673e-10, rt= 9.15%
</code></pre>
<p>From the two plots below, we can tell that Record 3, or the parameter set <code>M=20, g=0.007, j=0.006, s=0.05000</code>, is a good choice as it has both large Sortino ratio/YoY return and a relatively small maximum drawdown. Record 2, or <code>M=20, g=0.007, j=-0.006, s=0.05000</code> is also playing well among all outstanding parameter sets, with slightly better Sortino ratio and YoY returns but larger maximum drawdown. We&rsquo;ll test on both sets.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>rec <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>arange(<span style="color:#999">len</span>(record<span style="font-weight:bold">.</span>best))
</span></span><span style="display:flex;"><span>st_list, st_list, md_list, rt_list <span style="font-weight:bold">=</span> <span style="color:#999">list</span>(<span style="color:#999">zip</span>(<span style="font-weight:bold">*</span>record<span style="font-weight:bold">.</span>best))[<span style="font-weight:bold">-</span><span style="color:#099">4</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig <span style="font-weight:bold">=</span> plt<span style="font-weight:bold">.</span>figure(figsize<span style="font-weight:bold">=</span>(<span style="color:#099">20</span>, <span style="color:#099">7.5</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax <span style="font-weight:bold">=</span> fig<span style="font-weight:bold">.</span>add_subplot(<span style="color:#099">121</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_xlim(<span style="color:#999">min</span>(rt_list) <span style="font-weight:bold">*</span> <span style="color:#099">0.95</span>, <span style="color:#999">max</span>(rt_list) <span style="font-weight:bold">*</span> <span style="color:#099">1.05</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_ylim(<span style="color:#999">min</span>(st_list) <span style="font-weight:bold">*</span> <span style="color:#099">0.95</span>, <span style="color:#999">max</span>(st_list) <span style="font-weight:bold">*</span> <span style="color:#099">1.05</span>)
</span></span><span style="display:flex;"><span>st_offset <span style="font-weight:bold">=</span> (<span style="color:#999">max</span>(st_list) <span style="font-weight:bold">-</span> <span style="color:#999">min</span>(st_list)) <span style="font-weight:bold">*</span> <span style="color:#099">0.02</span>
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>scatter(rt_list, st_list, s<span style="font-weight:bold">=</span>[(md <span style="font-weight:bold">/</span> np<span style="font-weight:bold">.</span>mean(md_list))<span style="font-weight:bold">**</span><span style="color:#099">2</span> <span style="font-weight:bold">*</span> <span style="color:#099">4e3</span> <span style="font-weight:bold">for</span> md <span style="font-weight:bold">in</span> md_list],
</span></span><span style="display:flex;"><span>           color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;r&#39;</span>, edgecolor<span style="font-weight:bold">=</span><span style="color:#b84">&#39;k&#39;</span>, alpha<span style="font-weight:bold">=</span><span style="color:#099">.5</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>text(<span style="color:#099">.086</span>, <span style="color:#099">.325</span>, <span style="color:#b84">&#39;(Bubble Size ~ Maximum Drawdown)&#39;</span>)
</span></span><span style="display:flex;"><span><span style="font-weight:bold">for</span> rt, st, i <span style="font-weight:bold">in</span> <span style="color:#999">zip</span>(rt_list, st_list, <span style="color:#999">range</span>(<span style="color:#999">len</span>(record<span style="font-weight:bold">.</span>best))):
</span></span><span style="display:flex;"><span>    ax<span style="font-weight:bold">.</span>text(x<span style="font-weight:bold">=</span>rt, y<span style="font-weight:bold">=</span>st <span style="font-weight:bold">-</span> st_offset, s<span style="font-weight:bold">=</span><span style="color:#999">str</span>(i), ha<span style="font-weight:bold">=</span><span style="color:#b84">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_xlabel(<span style="color:#b84">&#39;YoY Return&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Sortino Ratio&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax <span style="font-weight:bold">=</span> fig<span style="font-weight:bold">.</span>add_subplot(<span style="color:#099">122</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>scatter(rec, st_list, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;r&#39;</span>, marker<span style="font-weight:bold">=</span><span style="color:#b84">&#39;x&#39;</span>, s<span style="font-weight:bold">=</span><span style="color:#099">200</span>, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;Sortino Ratio&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>scatter(rec, rt_list, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;c&#39;</span>, marker<span style="font-weight:bold">=</span><span style="color:#b84">&#39;o&#39;</span>, s<span style="font-weight:bold">=</span><span style="color:#099">200</span>, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;YoY Return&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_xlabel(<span style="color:#b84">&#39;Record&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Return &amp; Ratio&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>legend(frameon<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>, loc<span style="font-weight:bold">=</span><span style="color:#b84">&#39;upper left&#39;</span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>ax <span style="font-weight:bold">=</span> ax<span style="font-weight:bold">.</span>twinx()
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>grid(<span style="font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>scatter(rec, md_list, color<span style="font-weight:bold">=</span><span style="color:#b84">&#39;orange&#39;</span>, marker<span style="font-weight:bold">=</span><span style="color:#b84">&#39;s&#39;</span>, s<span style="font-weight:bold">=</span><span style="color:#099">200</span>, label<span style="font-weight:bold">=</span><span style="color:#b84">&#39;Maximum Drawdown&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_ylim(<span style="color:#999">min</span>(md_list) <span style="font-weight:bold">*</span> <span style="color:#099">0.9</span>, <span style="color:#999">max</span>(md_list) <span style="font-weight:bold">*</span> <span style="color:#099">1.1</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>xaxis<span style="font-weight:bold">.</span>set_ticks(rec)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>set_ylabel(<span style="color:#b84">&#39;Maximum Drawdown&#39;</span>)
</span></span><span style="display:flex;"><span>ax<span style="font-weight:bold">.</span>legend(frameon<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>, loc<span style="font-weight:bold">=</span><span style="color:#b84">&#39;upper right&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="font-weight:bold">.</span>tight_layout()
</span></span></code></pre></div><p><img src="/images/spread3.png" alt=""></p>
<p>Using the parameters from Record 3, we run backtest against the test set, i.e. from <code>2016-12-02</code> to <code>2018-12-31</code>. The plots are as below.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>be <span style="font-weight:bold">=</span> BacktestEngine(<span style="color:#b84">&#39;DRIP&#39;</span>, <span style="color:#b84">&#39;XOP&#39;</span>, start_date<span style="font-weight:bold">=</span><span style="color:#b84">&#39;2016-12-02&#39;</span>, end_date<span style="font-weight:bold">=</span><span style="color:#b84">&#39;2018-12-31&#39;</span>, ratio<span style="font-weight:bold">=-</span><span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>st, sr, md, rt <span style="font-weight:bold">=</span> be<span style="font-weight:bold">.</span>run(M<span style="font-weight:bold">=</span><span style="color:#099">20</span>, g<span style="font-weight:bold">=</span><span style="color:#099">0.007</span>, j<span style="font-weight:bold">=</span> <span style="color:#099">0.006</span>, s<span style="font-weight:bold">=</span><span style="color:#099">0.05000</span>, verbose<span style="font-weight:bold">=</span><span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#999">print</span>(<span style="color:#b84">&#39;Sortino Ratio=</span><span style="color:#b84">{:.4f}</span><span style="color:#b84">, Sharpe Ratio=</span><span style="color:#b84">{:.4f}</span><span style="color:#b84">, Maximum Drawdown=</span><span style="color:#b84">{:.4g}</span><span style="color:#b84">, YoY Return=</span><span style="color:#b84">{:.2%}</span><span style="color:#b84">&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">.</span>format(st, sr, md ,rt))
</span></span></code></pre></div><p><img src="/images/spread4.png" alt=""></p>
<pre><code>Sortino Ratio=0.7407, Sharpe Ratio=0.2447, Maximum Drawdown=2.005e-11, YoY Return=1.76%
</code></pre>
<p>Using the parameters from Record 3, the backtest result is as below.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>be <span style="font-weight:bold">=</span> BacktestEngine(<span style="color:#b84">&#39;DRIP&#39;</span>, <span style="color:#b84">&#39;XOP&#39;</span>, start_date<span style="font-weight:bold">=</span><span style="color:#b84">&#39;2016-12-02&#39;</span>, end_date<span style="font-weight:bold">=</span><span style="color:#b84">&#39;2018-12-31&#39;</span>, ratio<span style="font-weight:bold">=-</span><span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>st, sr, md, rt <span style="font-weight:bold">=</span> be<span style="font-weight:bold">.</span>run(M<span style="font-weight:bold">=</span><span style="color:#099">20</span>, g<span style="font-weight:bold">=</span><span style="color:#099">0.007</span>, j<span style="font-weight:bold">=-</span><span style="color:#099">0.006</span>, s<span style="font-weight:bold">=</span><span style="color:#099">0.05000</span>, verbose<span style="font-weight:bold">=</span><span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#999">print</span>(<span style="color:#b84">&#39;Sortino Ratio=</span><span style="color:#b84">{:.4f}</span><span style="color:#b84">, Sharpe Ratio=</span><span style="color:#b84">{:.4f}</span><span style="color:#b84">, Maximum Drawdown=</span><span style="color:#b84">{:.4g}</span><span style="color:#b84">, YoY Return=</span><span style="color:#b84">{:.2%}</span><span style="color:#b84">&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">.</span>format(st, sr, md ,rt))
</span></span></code></pre></div><p><img src="/images/spread5.png" alt=""></p>
<pre><code>Sortino Ratio=0.9394, Sharpe Ratio=0.2872, Maximum Drawdown=1.997e-11, YoY Return=2.24%
</code></pre>
<h1 id="conclusion">Conclusion</h1>
<p>Both results are amazingly great (especially compared with our result using random parameters before any tuning). Considering here we&rsquo;re not utilizing any future data in backtest, the performance is satisfactory despite we&rsquo;re neglecting a lot executional details in our analysis, like transaction costs and market impacts. There are also several comments on the processing of data:</p>
<ul>
<li>We are using the first <code>M</code> days to calculate the rolling median of <code>N</code>, which causes a loss in data. Perhaps we should use <code>M</code> days of further previous historical data to make up this loss.</li>
<li>Thresholds change, over time. To be more specific, the &ldquo;ideal&rdquo; thresholds change all the time, partly due to market regime shifting and partly other unknown reasons. We may, therefore, never have the &ldquo;best&rdquo; parameters for trading. Should we go for a dynamic version of spread trading? I doubt so. But it&rsquo;s worth thinking if there&rsquo;s any remedy for this problem.</li>
</ul>


<script>
  var unfocusableElems = document.querySelectorAll('pre');
  unfocusableElems.forEach(function (el) { el.setAttribute("tabindex", "-1"); });
  var unfocusableElems = document.querySelectorAll('iframe');
  unfocusableElems.forEach(function (el) { el.setAttribute("tabindex", "-1"); });
</script>

<footer>
  
<br><br>
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/blog/perfect-market-maker/">The Perfect Market Maker: Is it Possible?</a></span>
  <span class="nav-next"><a href="/blog/var-name-python/">How to Get Variable Name as a String in Python</a> &rarr;</span>
</nav>

<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/blog\/perfect-market-maker\/';
    
  } else if (e.which == 39) {  
    
    url = '\/blog\/var-name-python\/';
    
  }
  if (url) window.location = url;
});
</script>



<script src="https://giscus.app/client.js" data-repo="allenfrostline/allenfrostline.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnk3NzEzOTkxNg==" data-category="General" data-category-id="DIC_kwDOBJkPzM4CbgIQ"
        data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0"
        data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"
        async>
        </script>



<script async src="/js/alt-title.js"></script>

<script async src="/js/center-img.js"></script>

<script async src="/js/external-link.js"></script>

<script async src="/js/fix-footnote.js"></script>

<script async src="/js/header-link.js"></script>

<script async src="/js/load-typekit.js"></script>

<script async src="/js/math-code.js"></script>

<script async src="/js/mermaid.min.js"></script>

<script async src="/js/right-quote.js"></script>


<script src="/js/math-code.js"></script>

  
  
  
  
</footer>
</article>
</body>

</html>
