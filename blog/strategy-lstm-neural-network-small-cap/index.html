<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Strategy: LSTM Neural Network &#43; Small Cap - Allen&#39;s Whiteboard</title>
    <meta property="og:title" content="Strategy: LSTM Neural Network &#43; Small Cap - Allen&#39;s Whiteboard">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="This post covers the introduction to a simple LSTM neural network strategy in China A-share market, as well as its programming realization. Here we use RqAlpha&amp;rsquo;s trading API.
[&amp;hellip;] It is &amp;hellip;">
      <meta property="og:description" content="This post covers the introduction to a simple LSTM neural network strategy in China A-share market, as well as its programming realization. Here we use RqAlpha&amp;rsquo;s trading API.
[&amp;hellip;] It is &amp;hellip;">
      
    

    
    
    
    <meta name="twitter:image" content="https://allenfrostline.com/logo.png">
    
    

    

    
    




    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    

<script>
  (function (u, c) {
    var d = document, t = 'script', o = d.createElement(t), s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(e); }); }
    s.parentNode.insertBefore(o, s);
  })('//cdn.jsdelivr.net/npm/pangu@4.0.5/dist/browser/pangu.min.js', function () {
    pangu.spacingPage();
  });
</script>



<script async src="/js/center-img.js"></script>


<script>
    window.minimalAnalytics = {
        trackingId: 'G-B4WMGBPB4Z',
        autoTrack: true, 
    };
</script>
<script src="/index_1423847519945263698.js" async></script>
  </head>

  
  <body class="blog">
    <header class="masthead">
      

<h1><a href="/"><img src="/logo.png" alt="allenfrostline" /></a></h1>



      <nav class="menu">
  <ul>
  
  
  <li><a href="/blog/">Blog</a></li>
  
  <li><a href="/vitae/">Vitae</a></li>
  
  <li><a href="/recipe/">Recipe</a></li>
  
  <li><a href="https://beliapp.co/lists/allenfrostline">Eatery</a></li>
  
  <li><a href="/pottery/">Pottery</a></li>
  
  













  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
    <h1>Strategy: LSTM Neural Network &#43; Small Cap</h1>
    

    <hr style="margin-top:-1em">

    <h3 style="margin-top:-2.3em">
    
        

        
            2017-01-17
        
    
    </h3>



      </header>



<p>This post covers the introduction to a simple LSTM neural network strategy in China A-share market, as well as its programming realization. Here we use RqAlpha&rsquo;s trading API.</p>
<!-- more -->
<h1 id="performance">Performance</h1>
<table>
<thead>
<tr>
<th style="text-align:center">Info</th>
<th style="text-align:center">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Backtest Interval</td>
<td style="text-align:center">20130101 - 20170101</td>
</tr>
<tr>
<td style="text-align:center">Initial Capital</td>
<td style="text-align:center">1,000,000</td>
</tr>
<tr>
<td style="text-align:center">Annualized Return (Strategy)</td>
<td style="text-align:center">68.444%</td>
</tr>
<tr>
<td style="text-align:center">Annualized Return (Benchmark)</td>
<td style="text-align:center">9.205%</td>
</tr>
<tr>
<td style="text-align:center">Sharpe Ratio</td>
<td style="text-align:center">3.4771</td>
</tr>
<tr>
<td style="text-align:center">Maximum Drawdown</td>
<td style="text-align:center">-13.396%</td>
</tr>
</tbody>
</table>
<img src="/images/lstm_smc1.png" style="width: 850;"/>
<h1 id="intuition-small-cap">Intuition: Small Cap</h1>
<p>It is quite intuitive that small cap companies generally embrace larger probability to go up. Also, due to market making in A-share market, small caps usually have more stable paterns. These two facts hold from bear to bull and are rarely violated.</p>
<h1 id="tool-lstm-neural-network">Tool: LSTM Neural Network</h1>
<p>LSTM is an RNN network model. It&rsquo;s strength is in efficiently processing text and time series of various length. For more detailed information, check <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/">this</a> out.</p>
<h1 id="codes">Codes</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#b84">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#b84">author: Allen Frostline
</span></span></span><span style="display:flex;"><span><span style="color:#b84">update: 2017-01-16
</span></span></span><span style="display:flex;"><span><span style="color:#b84">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># some importance libraries</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">pandas</span> <span style="font-weight:bold">as</span> <span style="color:#555">pd</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">numpy</span> <span style="font-weight:bold">as</span> <span style="color:#555">np</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">datetime</span> <span style="font-weight:bold">import</span> timedelta
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">pybrain.datasets</span> <span style="font-weight:bold">import</span> SequentialDataSet
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">pybrain.tools.shortcuts</span> <span style="font-weight:bold">import</span> buildNetwork
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">pybrain.structure.networks</span> <span style="font-weight:bold">import</span> Network
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">pybrain.structure.modules</span> <span style="font-weight:bold">import</span> ReluLayer, LSTMLayer
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">pybrain.supervised</span> <span style="font-weight:bold">import</span> RPropMinusTrainer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># train on trainX and trainY, return a net and its score</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">train</span>(context, trainX, trainY):
</span></span><span style="display:flex;"><span>    ds <span style="font-weight:bold">=</span> SequentialDataSet(<span style="color:#099">4</span>, <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> dataX, dataY <span style="font-weight:bold">in</span> <span style="color:#999">zip</span>(trainX, trainY):
</span></span><span style="display:flex;"><span>        ds<span style="font-weight:bold">.</span>addSample(dataX, dataY)
</span></span><span style="display:flex;"><span>    net <span style="font-weight:bold">=</span> buildNetwork(<span style="color:#099">4</span>, <span style="color:#099">1</span>, <span style="color:#099">1</span>, hiddenclass<span style="font-weight:bold">=</span>LSTMLayer, outputbias<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>, recurrent<span style="font-weight:bold">=</span><span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>    trainer <span style="font-weight:bold">=</span> RPropMinusTrainer(net, dataset<span style="font-weight:bold">=</span>ds)
</span></span><span style="display:flex;"><span>    EPOCHS_PER_CYCLE <span style="font-weight:bold">=</span> <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>    CYCLES <span style="font-weight:bold">=</span> <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(CYCLES):
</span></span><span style="display:flex;"><span>        trainer<span style="font-weight:bold">.</span>trainEpochs(EPOCHS_PER_CYCLE)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> net, trainer<span style="font-weight:bold">.</span>testOnData()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># update data</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">load</span>(context, ticker):
</span></span><span style="display:flex;"><span>    close <span style="font-weight:bold">=</span> history_bars(ticker, <span style="color:#099">180</span>, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;close&#39;</span>)
</span></span><span style="display:flex;"><span>    high  <span style="font-weight:bold">=</span> history_bars(ticker, <span style="color:#099">180</span>, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;high&#39;</span>)
</span></span><span style="display:flex;"><span>    low   <span style="font-weight:bold">=</span> history_bars(ticker, <span style="color:#099">180</span>, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;low&#39;</span>)
</span></span><span style="display:flex;"><span>    volume<span style="font-weight:bold">=</span> history_bars(ticker, <span style="color:#099">180</span>, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;volume&#39;</span>)
</span></span><span style="display:flex;"><span>    data <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>matrix([close, high, low, volume])
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>position_ratio<span style="font-weight:bold">.</span>append(np<span style="font-weight:bold">.</span>array([close<span style="font-weight:bold">.</span>mean(), high<span style="font-weight:bold">.</span>mean(), low<span style="font-weight:bold">.</span>mean(), volume<span style="font-weight:bold">.</span>mean()]))
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>shape_ratio<span style="font-weight:bold">.</span>append(np<span style="font-weight:bold">.</span>array([close<span style="font-weight:bold">.</span>std(), high<span style="font-weight:bold">.</span>std(), low<span style="font-weight:bold">.</span>std(), volume<span style="font-weight:bold">.</span>std()]))
</span></span><span style="display:flex;"><span>    data[<span style="color:#099">0</span>,:] <span style="font-weight:bold">=</span> (data[<span style="color:#099">0</span>,:] <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[<span style="font-weight:bold">-</span><span style="color:#099">1</span>][<span style="color:#099">0</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[<span style="font-weight:bold">-</span><span style="color:#099">1</span>][<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>    data[<span style="color:#099">1</span>,:] <span style="font-weight:bold">=</span> (data[<span style="color:#099">1</span>,:] <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[<span style="font-weight:bold">-</span><span style="color:#099">1</span>][<span style="color:#099">1</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[<span style="font-weight:bold">-</span><span style="color:#099">1</span>][<span style="color:#099">1</span>]
</span></span><span style="display:flex;"><span>    data[<span style="color:#099">2</span>,:] <span style="font-weight:bold">=</span> (data[<span style="color:#099">2</span>,:] <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[<span style="font-weight:bold">-</span><span style="color:#099">1</span>][<span style="color:#099">2</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[<span style="font-weight:bold">-</span><span style="color:#099">1</span>][<span style="color:#099">2</span>]
</span></span><span style="display:flex;"><span>    data[<span style="color:#099">3</span>,:] <span style="font-weight:bold">=</span> (data[<span style="color:#099">3</span>,:] <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[<span style="font-weight:bold">-</span><span style="color:#099">1</span>][<span style="color:#099">3</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[<span style="font-weight:bold">-</span><span style="color:#099">1</span>][<span style="color:#099">3</span>]
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># blacklist is a necessity</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">filter_blacklist</span>(context, stock_list):
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> [ticker <span style="font-weight:bold">for</span> ticker <span style="font-weight:bold">in</span> stock_list <span style="font-weight:bold">if</span> ticker <span style="font-weight:bold">not</span> <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>blacklist]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">filter_stlist</span>(stock_list):
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> [ticker <span style="font-weight:bold">for</span> ticker <span style="font-weight:bold">in</span> stock_list <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> is_st_stock(ticker)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># use data of past 6 months to train the model and apply it for the next 3 months</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">modelize</span>(context, bar_dict):
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> context<span style="font-weight:bold">.</span>every_3_months <span style="font-weight:bold">%</span> <span style="color:#099">3</span> <span style="font-weight:bold">!=</span> <span style="color:#099">0</span>: 
</span></span><span style="display:flex;"><span>        context<span style="font-weight:bold">.</span>every_3_months <span style="font-weight:bold">+=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;-&#39;</span><span style="font-weight:bold">*</span><span style="color:#099">65</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;------&#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39;</span><span style="color:#b84">{:-^59}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#b84">&#39;modelizing&#39;</span>))
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>position_ratio <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>shape_ratio    <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>data  <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>net   <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>list  <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    templist <span style="font-weight:bold">=</span> <span style="color:#999">list</span>(get_fundamentals(query(fundamentals<span style="font-weight:bold">.</span>eod_derivative_indicator<span style="font-weight:bold">.</span>market_cap)
</span></span><span style="display:flex;"><span>                                    <span style="font-weight:bold">.</span>order_by(fundamentals<span style="font-weight:bold">.</span>eod_derivative_indicator<span style="font-weight:bold">.</span>market_cap<span style="font-weight:bold">.</span>asc())
</span></span><span style="display:flex;"><span>                                    <span style="font-weight:bold">.</span>limit(context<span style="font-weight:bold">.</span>num<span style="font-weight:bold">*</span><span style="color:#099">5</span>))<span style="font-weight:bold">.</span>columns)
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>list <span style="font-weight:bold">=</span> filter_blacklist(context, filter_stlist(templist))[:context<span style="font-weight:bold">.</span>num]
</span></span><span style="display:flex;"><span>    names  <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    scores <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> ticker <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>list:
</span></span><span style="display:flex;"><span>        names<span style="font-weight:bold">.</span>append(<span style="color:#b84">&#39;</span><span style="color:#b84">{:&lt;11}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(ticker))
</span></span><span style="display:flex;"><span>        data <span style="font-weight:bold">=</span> load(context, ticker)
</span></span><span style="display:flex;"><span>        trainX <span style="font-weight:bold">=</span> data[:,:<span style="font-weight:bold">-</span><span style="color:#099">1</span>]<span style="font-weight:bold">.</span>T
</span></span><span style="display:flex;"><span>        trainY <span style="font-weight:bold">=</span> data[<span style="color:#099">0</span>,<span style="color:#099">1</span>:]<span style="font-weight:bold">.</span>T
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            net, mse <span style="font-weight:bold">=</span> train(context, trainX, trainY)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">except</span>:
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>blacklist<span style="font-weight:bold">.</span>append(ticker)
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>mflag <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">return</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        context<span style="font-weight:bold">.</span>data<span style="font-weight:bold">.</span>append(data)
</span></span><span style="display:flex;"><span>        context<span style="font-weight:bold">.</span>net<span style="font-weight:bold">.</span>append(net)
</span></span><span style="display:flex;"><span>        scores<span style="font-weight:bold">.</span>append(<span style="color:#b84">&#39;</span><span style="color:#b84">{:&lt;11}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#999">str</span>(mse)[:<span style="color:#099">6</span>]))
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> np<span style="font-weight:bold">.</span>isnan(mse):
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>blacklist<span style="font-weight:bold">.</span>append(ticker)
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>mflag <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">return</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>pct <span style="font-weight:bold">=</span> [<span style="color:#099">0</span>] <span style="font-weight:bold">*</span> context<span style="font-weight:bold">.</span>num
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;------&#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39;</span><span style="color:#b84">{:-^59}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#b84">&#39;finished&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;-&#39;</span><span style="font-weight:bold">*</span><span style="color:#099">65</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39; nm | &#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39; &#39;</span><span style="font-weight:bold">.</span>join(names))
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;mse | &#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39; &#39;</span><span style="font-weight:bold">.</span>join(scores))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>mflag <span style="font-weight:bold">=</span> <span style="color:#099">1</span>  <span style="color:#998;font-style:italic"># flag that we&#39;ve already modelized at least once</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>tflag <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>every_3_months <span style="font-weight:bold">+=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>mv <span style="font-weight:bold">=</span> <span style="color:#999">dict</span>(<span style="color:#999">zip</span>(context<span style="font-weight:bold">.</span>list, [<span style="color:#099">0</span>]<span style="font-weight:bold">*</span><span style="color:#999">len</span>(context<span style="font-weight:bold">.</span>list)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">mkt_panic</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># market alert</span>
</span></span><span style="display:flex;"><span>    mkt <span style="font-weight:bold">=</span> history_bars(<span style="color:#b84">&#39;000001.XSHG&#39;</span>, <span style="color:#099">3</span>, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;close&#39;</span>)
</span></span><span style="display:flex;"><span>    panic <span style="font-weight:bold">=</span> (mkt[<span style="font-weight:bold">-</span><span style="color:#099">1</span>]<span style="font-weight:bold">/</span>mkt[<span style="font-weight:bold">-</span><span style="color:#099">2</span>] <span style="font-weight:bold">&lt;</span> <span style="color:#099">0.97</span> <span style="font-weight:bold">and</span> mkt[<span style="font-weight:bold">-</span><span style="color:#099">2</span>]<span style="font-weight:bold">/</span>mkt[<span style="font-weight:bold">-</span><span style="color:#099">3</span>] <span style="font-weight:bold">&lt;</span> <span style="color:#099">0.97</span>) <span style="font-weight:bold">or</span> mkt[<span style="font-weight:bold">-</span><span style="color:#099">1</span>]<span style="font-weight:bold">/</span>mkt[<span style="font-weight:bold">-</span><span style="color:#099">2</span>] <span style="font-weight:bold">&lt;</span> <span style="color:#099">0.95</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> panic:
</span></span><span style="display:flex;"><span>        <span style="color:#999">print</span>(<span style="color:#b84">&#39;!!!!!!&#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39;</span><span style="color:#b84">{:!^59}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#b84">&#39;panic&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># set alert range [a,b]</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">trade</span>(context,bar_dict):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">while</span> context<span style="font-weight:bold">.</span>mflag <span style="font-weight:bold">==</span> <span style="color:#099">0</span>: modelize(context, bar_dict)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    trash_bin <span style="font-weight:bold">=</span> [ticker <span style="font-weight:bold">for</span> ticker <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>portfolio<span style="font-weight:bold">.</span>positions <span style="font-weight:bold">if</span> ticker <span style="font-weight:bold">not</span> <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>list]
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> ticker <span style="font-weight:bold">in</span> trash_bin: order_target_percent(ticker, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    actual_close  <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    actual_high   <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    actual_low    <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    actual_vol    <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    actual_open   <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    actual_data   <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    predict_close <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(context<span style="font-weight:bold">.</span>num):
</span></span><span style="display:flex;"><span>        actual_close<span style="font-weight:bold">.</span>append((history_bars(context<span style="font-weight:bold">.</span>list[i], <span style="color:#099">1</span>,<span style="color:#b84">&#39;1d&#39;</span>,<span style="color:#b84">&#39;close&#39;</span>)[<span style="color:#099">0</span>] <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[i][<span style="color:#099">0</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[i][<span style="color:#099">0</span>])
</span></span><span style="display:flex;"><span>        actual_high<span style="font-weight:bold">.</span>append((history_bars(context<span style="font-weight:bold">.</span>list[i], <span style="color:#099">1</span>,<span style="color:#b84">&#39;1d&#39;</span>,<span style="color:#b84">&#39;high&#39;</span>)[<span style="color:#099">0</span>]   <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[i][<span style="color:#099">1</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[i][<span style="color:#099">1</span>])
</span></span><span style="display:flex;"><span>        actual_low<span style="font-weight:bold">.</span>append((history_bars(context<span style="font-weight:bold">.</span>list[i], <span style="color:#099">1</span>,<span style="color:#b84">&#39;1d&#39;</span>,<span style="color:#b84">&#39;low&#39;</span>)[<span style="color:#099">0</span>]     <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[i][<span style="color:#099">2</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[i][<span style="color:#099">2</span>])
</span></span><span style="display:flex;"><span>        actual_vol<span style="font-weight:bold">.</span>append((history_bars(context<span style="font-weight:bold">.</span>list[i], <span style="color:#099">1</span>,<span style="color:#b84">&#39;1d&#39;</span>,<span style="color:#b84">&#39;volume&#39;</span>)[<span style="color:#099">0</span>]  <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[i][<span style="color:#099">3</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[i][<span style="color:#099">3</span>])
</span></span><span style="display:flex;"><span>        actual_open<span style="font-weight:bold">.</span>append((history_bars(context<span style="font-weight:bold">.</span>list[i], <span style="color:#099">1</span>,<span style="color:#b84">&#39;1m&#39;</span>,<span style="color:#b84">&#39;close&#39;</span>)[<span style="color:#099">0</span>]  <span style="font-weight:bold">-</span> context<span style="font-weight:bold">.</span>position_ratio[i][<span style="color:#099">0</span>]) <span style="font-weight:bold">/</span> context<span style="font-weight:bold">.</span>shape_ratio[i][<span style="color:#099">0</span>])
</span></span><span style="display:flex;"><span>        actual_data<span style="font-weight:bold">.</span>append([actual_close[i],actual_high[i],actual_low[i],actual_vol[i]])
</span></span><span style="display:flex;"><span>        predict_close<span style="font-weight:bold">.</span>append(context<span style="font-weight:bold">.</span>net[i]<span style="font-weight:bold">.</span>activate(actual_data[i])[<span style="color:#099">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> context<span style="font-weight:bold">.</span>tflag <span style="font-weight:bold">==</span> <span style="color:#099">0</span>: 
</span></span><span style="display:flex;"><span>        context<span style="font-weight:bold">.</span>temp_pc <span style="font-weight:bold">=</span> predict_close
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    r <span style="font-weight:bold">=</span> [<span style="color:#999">float</span>((pc<span style="font-weight:bold">*</span>shape_ratio[<span style="color:#099">0</span>]<span style="font-weight:bold">+</span>position_ratio[<span style="color:#099">0</span>]) <span style="font-weight:bold">/</span> (ao<span style="font-weight:bold">*</span>shape_ratio[<span style="color:#099">0</span>]<span style="font-weight:bold">+</span>position_ratio[<span style="color:#099">0</span>]) <span style="font-weight:bold">-</span> <span style="color:#099">1</span>) <span style="font-weight:bold">for</span> pc, ao, shape_ratio, position_ratio <span style="font-weight:bold">in</span> <span style="color:#999">zip</span>(predict_close, actual_open, context<span style="font-weight:bold">.</span>shape_ratio, context<span style="font-weight:bold">.</span>position_ratio)]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    temp_r <span style="font-weight:bold">=</span> [<span style="color:#999">float</span>((pc<span style="font-weight:bold">*</span>shape_ratio[<span style="color:#099">0</span>]<span style="font-weight:bold">+</span>position_ratio[<span style="color:#099">0</span>]) <span style="font-weight:bold">/</span> (tpc<span style="font-weight:bold">*</span>shape_ratio[<span style="color:#099">0</span>]<span style="font-weight:bold">+</span>position_ratio[<span style="color:#099">0</span>]) <span style="font-weight:bold">-</span> <span style="color:#099">1</span>) <span style="font-weight:bold">for</span> pc, tpc, shape_ratio, position_ratio <span style="font-weight:bold">in</span> <span style="color:#999">zip</span>(predict_close, context<span style="font-weight:bold">.</span>temp_pc, context<span style="font-weight:bold">.</span>shape_ratio, context<span style="font-weight:bold">.</span>position_ratio)]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># stop loss trick</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> stock <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>portfolio<span style="font-weight:bold">.</span>positions:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            mv <span style="font-weight:bold">=</span> context<span style="font-weight:bold">.</span>portfolio<span style="font-weight:bold">.</span>positions[stock]<span style="font-weight:bold">.</span>market_value <span style="color:#998;font-style:italic"># Cap</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> mv <span style="font-weight:bold">&gt;</span> context<span style="font-weight:bold">.</span>mv[stock]: context<span style="font-weight:bold">.</span>mv[stock] <span style="font-weight:bold">=</span> mv    <span style="color:#998;font-style:italic"># History Price Max</span>
</span></span><span style="display:flex;"><span>            md <span style="font-weight:bold">=</span> <span style="color:#099">1</span> <span style="font-weight:bold">-</span> mv<span style="font-weight:bold">/</span>context<span style="font-weight:bold">.</span>mv[stock]                        <span style="color:#998;font-style:italic"># Max DD</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> md <span style="font-weight:bold">&gt;</span> <span style="color:#099">.5</span>: order_value(stock, mv<span style="font-weight:bold">/</span><span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">except</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># The essence of this strategy</span>
</span></span><span style="display:flex;"><span>    hybrid_r <span style="font-weight:bold">=</span> [<span style="color:#999">max</span>(ri,temp_ri,ri<span style="font-weight:bold">+</span>temp_ri) <span style="font-weight:bold">for</span> ri, temp_ri <span style="font-weight:bold">in</span> <span style="color:#999">zip</span>(r,temp_r)]
</span></span><span style="display:flex;"><span>    bad_hybrid_signal <span style="font-weight:bold">=</span> <span style="color:#999">sum</span>([x <span style="font-weight:bold">&lt;=</span> <span style="color:#099">0</span> <span style="font-weight:bold">for</span> x <span style="font-weight:bold">in</span> hybrid_r])
</span></span><span style="display:flex;"><span>    a, b <span style="font-weight:bold">=</span> <span style="color:#099">0.02</span>, <span style="font-weight:bold">-</span><span style="color:#099">0.02</span>
</span></span><span style="display:flex;"><span>    panic <span style="font-weight:bold">=</span> mkt_panic()
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(context<span style="font-weight:bold">.</span>num):
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> panic <span style="font-weight:bold">or</span> <span style="color:#099">0</span> <span style="font-weight:bold">&lt;</span> context<span style="font-weight:bold">.</span>post_panic <span style="font-weight:bold">&lt;</span> <span style="color:#099">22</span> <span style="font-weight:bold">*</span> context<span style="font-weight:bold">.</span>num:
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>pct[i] <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>post_panic <span style="font-weight:bold">=</span> (<span style="color:#099">1</span> <span style="font-weight:bold">-</span> panic) <span style="font-weight:bold">*</span> (context<span style="font-weight:bold">.</span>post_panic <span style="font-weight:bold">+</span> <span style="color:#099">1</span>) <span style="font-weight:bold">+</span> panic
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">elif</span> hybrid_r[i] <span style="font-weight:bold">&gt;</span> a:
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>pct[i] <span style="font-weight:bold">=</span> <span style="color:#999">min</span>(context<span style="font-weight:bold">.</span>pct[i] <span style="font-weight:bold">+</span> <span style="color:#099">.5</span><span style="font-weight:bold">/</span>context<span style="font-weight:bold">.</span>num, <span style="color:#099">2</span><span style="font-weight:bold">/</span>context<span style="font-weight:bold">.</span>num)
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>post_panic <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">elif</span> hybrid_r[i] <span style="font-weight:bold">&lt;</span> b <span style="font-weight:bold">or</span> bad_hybrid_signal <span style="font-weight:bold">&gt;</span> <span style="color:#099">3</span><span style="font-weight:bold">*</span>context<span style="font-weight:bold">.</span>num<span style="font-weight:bold">//</span><span style="color:#099">5</span>:
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>pct[i] <span style="font-weight:bold">=</span> <span style="color:#999">max</span>(context<span style="font-weight:bold">.</span>pct[i] <span style="font-weight:bold">-</span> <span style="color:#099">.5</span><span style="font-weight:bold">/</span>context<span style="font-weight:bold">.</span>num, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>            context<span style="font-weight:bold">.</span>post_panic <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> context<span style="font-weight:bold">.</span>tflag <span style="font-weight:bold">==</span> <span style="color:#099">1</span>: <span style="color:#999">print</span>(<span style="color:#b84">&#39; ac | &#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39; &#39;</span><span style="font-weight:bold">.</span>join([<span style="color:#b84">&#39;</span><span style="color:#b84">{:&lt;11}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#999">str</span>(ac)[:<span style="color:#099">6</span>]) <span style="font-weight:bold">for</span> ac <span style="font-weight:bold">in</span> actual_close]))
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;-&#39;</span><span style="font-weight:bold">*</span><span style="color:#099">65</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39; ao | &#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39; &#39;</span><span style="font-weight:bold">.</span>join([<span style="color:#b84">&#39;</span><span style="color:#b84">{:&lt;11}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#999">str</span>(ao)[:<span style="color:#099">6</span>]) <span style="font-weight:bold">for</span> ao <span style="font-weight:bold">in</span> actual_open]))
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39; pc | &#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39; &#39;</span><span style="font-weight:bold">.</span>join([<span style="color:#b84">&#39;</span><span style="color:#b84">{:&lt;11}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#999">str</span>(pc)[:<span style="color:#099">6</span>]) <span style="font-weight:bold">for</span> pc <span style="font-weight:bold">in</span> predict_close]))
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;  r | &#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39; &#39;</span><span style="font-weight:bold">.</span>join([<span style="color:#b84">&#39;</span><span style="color:#b84">{:&lt;11}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#999">str</span>(ri)[:<span style="color:#099">6</span>]) <span style="font-weight:bold">for</span> ri <span style="font-weight:bold">in</span> hybrid_r]))
</span></span><span style="display:flex;"><span>    pct <span style="font-weight:bold">=</span> <span style="color:#999">sum</span>([context<span style="font-weight:bold">.</span>portfolio<span style="font-weight:bold">.</span>positions[ticker]<span style="font-weight:bold">.</span>market_value <span style="font-weight:bold">for</span> ticker <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>portfolio<span style="font-weight:bold">.</span>positions])<span style="font-weight:bold">/</span>(context<span style="font-weight:bold">.</span>portfolio<span style="font-weight:bold">.</span>market_value<span style="font-weight:bold">+</span>context<span style="font-weight:bold">.</span>portfolio<span style="font-weight:bold">.</span>cash)
</span></span><span style="display:flex;"><span>    tot_pct <span style="font-weight:bold">=</span> <span style="color:#999">max</span>(<span style="color:#999">sum</span>(context<span style="font-weight:bold">.</span>pct), <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>pct <span style="font-weight:bold">=</span> <span style="color:#999">list</span>(<span style="color:#999">map</span>(<span style="font-weight:bold">lambda</span> x: x<span style="font-weight:bold">/</span>tot_pct, context<span style="font-weight:bold">.</span>pct))
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;  % | &#39;</span><span style="font-weight:bold">+</span><span style="color:#b84">&#39; &#39;</span><span style="font-weight:bold">.</span>join([<span style="color:#b84">&#39;</span><span style="color:#b84">{:&lt;11}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(<span style="color:#999">str</span>(p)[:<span style="color:#099">6</span>]) <span style="font-weight:bold">for</span> p <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>pct]))
</span></span><span style="display:flex;"><span>    plot(<span style="color:#b84">&#39;total position&#39;</span>, pct <span style="font-weight:bold">*</span> <span style="color:#099">100</span>)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(context<span style="font-weight:bold">.</span>num): order_target_percent(context<span style="font-weight:bold">.</span>list[i], context<span style="font-weight:bold">.</span>pct[i])
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>tflag <span style="font-weight:bold">=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>temp_pc <span style="font-weight:bold">=</span> predict_close
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">init</span>(context):
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>temp_pc        <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>every_3_months <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>tflag          <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>mflag          <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>mv             <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>position_ratio <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>shape_ratio    <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>num            <span style="font-weight:bold">=</span> <span style="color:#099">20</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>list           <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>pct            <span style="font-weight:bold">=</span> [<span style="color:#099">0</span>] <span style="font-weight:bold">*</span> context<span style="font-weight:bold">.</span>num
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>net            <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>data           <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>post_panic     <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>blacklist      <span style="font-weight:bold">=</span> [
</span></span><span style="display:flex;"><span>                              <span style="color:#b84">&#39;000004.XSHE&#39;</span>,<span style="color:#b84">&#39;000546.XSHE&#39;</span>,
</span></span><span style="display:flex;"><span>                              <span style="color:#b84">&#39;000594.XSHE&#39;</span>,<span style="color:#b84">&#39;002352.XSHE&#39;</span>,
</span></span><span style="display:flex;"><span>                              <span style="color:#b84">&#39;300176.XSHE&#39;</span>,<span style="color:#b84">&#39;300260.XSHE&#39;</span>,
</span></span><span style="display:flex;"><span>                              <span style="color:#b84">&#39;300372.XSHE&#39;</span>,<span style="color:#b84">&#39;600137.XSHG&#39;</span>,
</span></span><span style="display:flex;"><span>                              <span style="color:#b84">&#39;600306.XSHG&#39;</span>,<span style="color:#b84">&#39;600656.XSHG&#39;</span>,
</span></span><span style="display:flex;"><span>                             ]
</span></span><span style="display:flex;"><span>    scheduler<span style="font-weight:bold">.</span>run_monthly(modelize,<span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>    scheduler<span style="font-weight:bold">.</span>run_daily(trade)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># do nothing before 9:00</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">before_trading</span>(context):
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># do not trigger minute bar activities</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">handle_bar</span>(context, bar_dict):
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">pass</span>
</span></span></code></pre></div><hr>
<h1 id="references">References:</h1>
<ul>
<li><a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/">Understanding LSTM Networks</a></li>
<li><a href="https://en.wikipedia.org/wiki/Long_short-term_memory">Long Short-term Memery</a></li>
</ul>


<script>
  var unfocusableElems = document.querySelectorAll('pre');
  unfocusableElems.forEach(function (el) { el.setAttribute("tabindex", "-1"); });
  var unfocusableElems = document.querySelectorAll('iframe');
  unfocusableElems.forEach(function (el) { el.setAttribute("tabindex", "-1"); });
</script>

<footer>
  
<br><br>
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/blog/gmm-estimation/">GMM Estimation of an ARMA(2,1) Model</a></span>
  <span class="nav-next"><a href="/blog/trading-system-on-aliyun/">How to Set Up an Algo-trading System on Aliyun</a> &rarr;</span>
</nav>

<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/blog\/gmm-estimation\/';
    
  } else if (e.which == 39) {  
    
    url = '\/blog\/trading-system-on-aliyun\/';
    
  }
  if (url) window.location = url;
});
</script>



<script src="https://giscus.app/client.js" data-repo="allenfrostline/allenfrostline.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnk3NzEzOTkxNg==" data-category="General" data-category-id="DIC_kwDOBJkPzM4CbgIQ"
        data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0"
        data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"
        async>
        </script>



<script async src="/js/center-img.js"></script>

<script async src="/js/right-quote.js"></script>

<script async src="/js/fix-footnote.js"></script>

<script async src="/js/math-code.js"></script>

<script async src="/js/external-link.js"></script>

<script async src="/js/alt-title.js"></script>

<script async src="/js/header-link.js"></script>


<script src="/js/math-code.js"></script>

  
  
  
  
</footer>
</article>
</body>

</html>
