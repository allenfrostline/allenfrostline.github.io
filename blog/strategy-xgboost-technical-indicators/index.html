<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Strategy: XGBoost Classification &#43; Technical Indicators - Allen&#39;s Whiteboard</title>
    <meta property="og:title" content="Strategy: XGBoost Classification &#43; Technical Indicators - Allen&#39;s Whiteboard">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="On many Kaggle public leaderboards, you will see an algorithm called &amp;ldquo;XGBoost&amp;rdquo;, or &amp;ldquo;Xtreme Gradient Boosting&amp;rdquo;. This is an optimized algorithm under the Gradient Boosting &amp;hellip;">
      <meta property="og:description" content="On many Kaggle public leaderboards, you will see an algorithm called &amp;ldquo;XGBoost&amp;rdquo;, or &amp;ldquo;Xtreme Gradient Boosting&amp;rdquo;. This is an optimized algorithm under the Gradient Boosting &amp;hellip;">
      
    

    
    
    
    <meta name="twitter:image" content="https://allenfrostline.com/logo.png">
    
    

    

    
    




    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
<script src="/js/math-code.js"></script>


<script>
  (function (u, c) {
    var d = document, t = 'script', o = d.createElement(t), s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(e); }); }
    s.parentNode.insertBefore(o, s);
  })('//cdn.jsdelivr.net/npm/pangu@4.0.5/dist/browser/pangu.min.js', function () {
    pangu.spacingPage();
  });
</script>



<script async src="/js/center-img.js"></script>


<script>
    window.minimalAnalytics = {
        trackingId: 'G-B4WMGBPB4Z',
        autoTrack: true, 
    };
</script>
<script src="/index_1423847519945263698.js" async></script>
  </head>

  
  <body class="blog">
    <header class="masthead">
      

<h1><a href="/"><img src="/logo.png" alt="allenfrostline" /></a></h1>



      <nav class="menu">
  <ul>
  
  
  <li><a href="/blog/">Blog</a></li>
  
  <li><a href="/pottery/">Pottery</a></li>
  
  <li><a href="/recipe/">Recipe</a></li>
  
  <li><a href="/kotoba">Kotoba</a></li>
  
  <li><a href="/vitae/">Vitae</a></li>
  
  













  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
    <h1>Strategy: XGBoost Classification &#43; Technical Indicators</h1>
    

    <hr style="margin-top:-1em">

    <h3 style="margin-top:-2.3em">
    
        

        
            2017-03-12
        
    
    </h3>



      </header>



<p>On many <a href="https://www.kaggle.com">Kaggle</a> public leaderboards, you will see an algorithm called &ldquo;XGBoost&rdquo;, or &ldquo;Xtreme Gradient Boosting&rdquo;. This is an optimized algorithm under the Gradient Boosting framework. The key difference between the normal boosting models and XGBoost, as far as I can see, is that XGBoost allows for parallel processing while keeps the accuracy on its performance. This dramatically makes large-scale machine learning algorithms (since boosting is essentially an ensemble of several weak learning algorithms) possible on personal computers (even on my MBP 2015), and further empowers people like me to apply them onto more practical scenarios, e.g. stock price prediction as we are gonna talk about today. Highest tribute to Tianqi Chen and his great <a href="https://arxiv.org/abs/1603.02754">paper</a>!</p>
<!-- more -->
<h2 id="performance">Performance</h2>
<table>
<thead>
<tr>
<th style="text-align:center">Statistic</th>
<th style="text-align:center">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Backtest Interval</td>
<td style="text-align:center">20130101 - 20170101</td>
</tr>
<tr>
<td style="text-align:center">Initial Capital</td>
<td style="text-align:center">1,000,000</td>
</tr>
<tr>
<td style="text-align:center">Annualized Return (Strategy)</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:center">Annualized Return (Benchmark)</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:center">Sharpe Ratio</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:center">Maximum Drawdown</td>
<td style="text-align:center">TBD</td>
</tr>
</tbody>
</table>
<p>(Performance screenshot not available at present. Will be uploaded later.)</p>
<h2 id="intuition-long-term-vs-short-term-prediction">Intuition: Long-term vs. Short-term Prediction</h2>
<p>I got the inspiration from <a href="https://www.researchgate.net/profile/Snehanshu_Saha/publication/309492895_Forecasting_to_Classification_Predicting_the_direction_of_stock_market_price_using_Xtreme_Gradient_Boosting/links/581384c008aedc7d8961e371.pdf">this paper</a>. The author raised an interesting but also convincing point when doing stock price prediction: the long-term trend is always easier to predict than the short-term. Again, let&rsquo;s take <a href="https://www.google.com/finance?q=NASDAQ:AAPL">AAPL</a> for example. The Apple Inc. witnessed a close at $139.14 per share today, a slight rise by 0.33 percent point. What is the expected price change in percentage for, say, tomorrow? Also let&rsquo;s assume that you have access to all the historical data you want, regardless of the size of the dataset or other computational issues? What if an chief engineer suddenly decides to resign from the company and the news leaks instantly through social networks? What if Samsung or another mobile phone company launches its newest prototype right after your prediction? What if, just for fun, the new prototype of Samsung (or whatever) should explode during the presentation, on the spot? The randomness is so changable that our prediction could even be totally the opposite of the true story. However, in a sense of long-term prediction, things get easier, since the overall relationship between Apple and Samsung would least likely change in the near future, and the general performance of AAPL is in principle dependent on how Apple Inc. behave in the following months. So GIVEN THAT COOPER IS NOT INSANE, BUT A RATHER CAUTIOUS CEO, we can expect a higher accuracy when predicting the average price change of AAPL in the next three months (60 tradingdays or so).</p>
<p>Notice again that we are not talking about predicting the close of the day three months from now. We are talking about the AVERAGE price change of the following three months. Now, let&rsquo;s turn to see what predictor we can use to perform the idea.</p>
<h2 id="tool-technical-indicators--xgboost-classification">Tool: Technical Indicators &amp; XGBoost Classification</h2>
<p>We are using the classification algorithm in XGBoost. The regression algorithm is slower but more intuitive, but binary classification is just faster in this case, which allows for efficient backtesting later on. The prediction is based on a certain length of historical data including open, high, low, close and volume, along with other 77 techinical indicators that are not extracted until before the prediction. This is of course far from &ldquo;all historical data&rdquo; in the market, not to mention the off-market rumors, social and political concerns, etc. But this is enough for illustration here. Therefore, a good amendment for this strategy is surely to append these left-out indicators. For NLA and similar applications in stock price prediction, you can check my <a href="https://allenfrostline.github.io/2017/02/what-about-crawling-trumps-tweets-and-make-it-to-a-trading-algo/">post</a> about making Mr. Trump&rsquo;s tweets into prediction indicators. I didn&rsquo;t acutally write the project because I found a really mature application already written on Github, but I would definitely rewrite it myself during the summer vacation. If you find the post not changed even after that, please feel free to mail me and &ldquo;harshly&rdquo; urge me for the overdue task.</p>
<h2 id="codes">Codes</h2>
<p>The codes mainly consists of three parts:</p>
<ul>
<li>Definition of techinical indicators.</li>
<li>Two Python classes: <code>classifier</code> and <code>stock</code>.</li>
<li>Main program, including configuration parameters for the backtesting framework.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">sys</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">numpy</span> <span style="font-weight:bold">as</span> <span style="color:#555">np</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">tushare</span> <span style="font-weight:bold">as</span> <span style="color:#555">ts</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">pandas</span> <span style="font-weight:bold">as</span> <span style="color:#555">pd</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">talib</span> <span style="font-weight:bold">as</span> <span style="color:#555">tb</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">xgboost</span> <span style="font-weight:bold">import</span> XGBClassifier
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">datetime</span> <span style="font-weight:bold">import</span> datetime <span style="font-weight:bold">as</span> dt
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">dateutil.relativedelta</span> <span style="font-weight:bold">import</span> relativedelta
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">sklearn.model_selection</span> <span style="font-weight:bold">import</span> StratifiedKFold, GridSearchCV
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">sklearn.metrics</span> <span style="font-weight:bold">import</span> accuracy_score
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># define pivot variables for easy use</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">technical</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#999">open</span> <span style="font-weight:bold">=</span> df[<span style="color:#b84">&#39;open&#39;</span>]<span style="font-weight:bold">.</span>values
</span></span><span style="display:flex;"><span>    close <span style="font-weight:bold">=</span> df[<span style="color:#b84">&#39;close&#39;</span>]<span style="font-weight:bold">.</span>values
</span></span><span style="display:flex;"><span>    high <span style="font-weight:bold">=</span> df[<span style="color:#b84">&#39;high&#39;</span>]<span style="font-weight:bold">.</span>values
</span></span><span style="display:flex;"><span>    low <span style="font-weight:bold">=</span> df[<span style="color:#b84">&#39;low&#39;</span>]<span style="font-weight:bold">.</span>values
</span></span><span style="display:flex;"><span>    volume <span style="font-weight:bold">=</span> df[<span style="color:#b84">&#39;volume&#39;</span>]<span style="font-weight:bold">.</span>values
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># define the technical analysis matrix</span>
</span></span><span style="display:flex;"><span>    retn <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>array([
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>MA(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">5</span>),                                         <span style="color:#998;font-style:italic"># 1</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>MA(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">10</span>),                                        <span style="color:#998;font-style:italic"># 2</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>MA(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">20</span>),                                        <span style="color:#998;font-style:italic"># 3</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>MA(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">60</span>),                                        <span style="color:#998;font-style:italic"># 4</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>MA(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">90</span>),                                        <span style="color:#998;font-style:italic"># 5</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>MA(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">120</span>),                                       <span style="color:#998;font-style:italic"># 6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>ADX(high, low, close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">20</span>),                            <span style="color:#998;font-style:italic"># 7</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>ADXR(high, low, close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">20</span>),                           <span style="color:#998;font-style:italic"># 8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>MACD(close, fastperiod<span style="font-weight:bold">=</span><span style="color:#099">12</span>, slowperiod<span style="font-weight:bold">=</span><span style="color:#099">26</span>, signalperiod<span style="font-weight:bold">=</span><span style="color:#099">9</span>)[<span style="color:#099">0</span>],    <span style="color:#998;font-style:italic"># 9</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>RSI(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">14</span>),                                       <span style="color:#998;font-style:italic"># 10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>BBANDS(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">5</span>, nbdevup<span style="font-weight:bold">=</span><span style="color:#099">2</span>, nbdevdn<span style="font-weight:bold">=</span><span style="color:#099">2</span>, matype<span style="font-weight:bold">=</span><span style="color:#099">0</span>)[<span style="color:#099">0</span>],  <span style="color:#998;font-style:italic"># 11</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>BBANDS(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">5</span>, nbdevup<span style="font-weight:bold">=</span><span style="color:#099">2</span>, nbdevdn<span style="font-weight:bold">=</span><span style="color:#099">2</span>, matype<span style="font-weight:bold">=</span><span style="color:#099">0</span>)[<span style="color:#099">1</span>],  <span style="color:#998;font-style:italic"># 12</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>BBANDS(close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">5</span>, nbdevup<span style="font-weight:bold">=</span><span style="color:#099">2</span>, nbdevdn<span style="font-weight:bold">=</span><span style="color:#099">2</span>, matype<span style="font-weight:bold">=</span><span style="color:#099">0</span>)[<span style="color:#099">2</span>],  <span style="color:#998;font-style:italic"># 13</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>AD(high, low, close, volume),                                    <span style="color:#998;font-style:italic"># 14</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>ATR(high, low, close, timeperiod<span style="font-weight:bold">=</span><span style="color:#099">14</span>),                            <span style="color:#998;font-style:italic"># 15</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>HT_DCPERIOD(close),                                              <span style="color:#998;font-style:italic"># 16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDL2CROWS(<span style="color:#999">open</span>, high, low, close),                               <span style="color:#998;font-style:italic"># 17</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDL3BLACKCROWS(<span style="color:#999">open</span>, high, low, close),                          <span style="color:#998;font-style:italic"># 18</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDL3INSIDE(<span style="color:#999">open</span>, high, low, close),                              <span style="color:#998;font-style:italic"># 19</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDL3LINESTRIKE(<span style="color:#999">open</span>, high, low, close),                          <span style="color:#998;font-style:italic"># 20</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDL3OUTSIDE(<span style="color:#999">open</span>, high, low, close),                             <span style="color:#998;font-style:italic"># 21</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDL3STARSINSOUTH(<span style="color:#999">open</span>, high, low, close),                        <span style="color:#998;font-style:italic"># 22</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDL3WHITESOLDIERS(<span style="color:#999">open</span>, high, low, close),                       <span style="color:#998;font-style:italic"># 23</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLABANDONEDBABY(<span style="color:#999">open</span>, high, low, close, penetration<span style="font-weight:bold">=</span><span style="color:#099">0</span>),         <span style="color:#998;font-style:italic"># 24</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLADVANCEBLOCK(<span style="color:#999">open</span>, high, low, close),                         <span style="color:#998;font-style:italic"># 25</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLBELTHOLD(<span style="color:#999">open</span>, high, low, close),                             <span style="color:#998;font-style:italic"># 26</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLBREAKAWAY(<span style="color:#999">open</span>, high, low, close),                            <span style="color:#998;font-style:italic"># 27</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLCLOSINGMARUBOZU(<span style="color:#999">open</span>, high, low, close),                      <span style="color:#998;font-style:italic"># 28</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLCONCEALBABYSWALL(<span style="color:#999">open</span>, high, low, close),                     <span style="color:#998;font-style:italic"># 29</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLCOUNTERATTACK(<span style="color:#999">open</span>, high, low, close),                        <span style="color:#998;font-style:italic"># 30</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLDARKCLOUDCOVER(<span style="color:#999">open</span>, high, low, close, penetration<span style="font-weight:bold">=</span><span style="color:#099">0</span>),        <span style="color:#998;font-style:italic"># 31</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLDOJI(<span style="color:#999">open</span>, high, low, close),                                 <span style="color:#998;font-style:italic"># 32</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLDOJISTAR(<span style="color:#999">open</span>, high, low, close),                             <span style="color:#998;font-style:italic"># 33</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLDRAGONFLYDOJI(<span style="color:#999">open</span>, high, low, close),                        <span style="color:#998;font-style:italic"># 34</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLENGULFING(<span style="color:#999">open</span>, high, low, close),                            <span style="color:#998;font-style:italic"># 35</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLEVENINGDOJISTAR(<span style="color:#999">open</span>, high, low, close, penetration<span style="font-weight:bold">=</span><span style="color:#099">0</span>),       <span style="color:#998;font-style:italic"># 36</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLEVENINGSTAR(<span style="color:#999">open</span>, high, low, close, penetration<span style="font-weight:bold">=</span><span style="color:#099">0</span>),           <span style="color:#998;font-style:italic"># 37</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLGAPSIDESIDEWHITE(<span style="color:#999">open</span>, high, low, close),                     <span style="color:#998;font-style:italic"># 38</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLGRAVESTONEDOJI(<span style="color:#999">open</span>, high, low, close),                       <span style="color:#998;font-style:italic"># 39</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLHAMMER(<span style="color:#999">open</span>, high, low, close),                               <span style="color:#998;font-style:italic"># 40</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLHANGINGMAN(<span style="color:#999">open</span>, high, low, close),                           <span style="color:#998;font-style:italic"># 41</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLHARAMI(<span style="color:#999">open</span>, high, low, close),                               <span style="color:#998;font-style:italic"># 42</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLHARAMICROSS(<span style="color:#999">open</span>, high, low, close),                          <span style="color:#998;font-style:italic"># 43</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLHIGHWAVE(<span style="color:#999">open</span>, high, low, close),                             <span style="color:#998;font-style:italic"># 44</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLHIKKAKE(<span style="color:#999">open</span>, high, low, close),                              <span style="color:#998;font-style:italic"># 45</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLHIKKAKEMOD(<span style="color:#999">open</span>, high, low, close),                           <span style="color:#998;font-style:italic"># 46</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLHOMINGPIGEON(<span style="color:#999">open</span>, high, low, close),                         <span style="color:#998;font-style:italic"># 47</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLIDENTICAL3CROWS(<span style="color:#999">open</span>, high, low, close),                      <span style="color:#998;font-style:italic"># 48</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLINNECK(<span style="color:#999">open</span>, high, low, close),                               <span style="color:#998;font-style:italic"># 49</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLINVERTEDHAMMER(<span style="color:#999">open</span>, high, low, close),                       <span style="color:#998;font-style:italic"># 50</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLKICKING(<span style="color:#999">open</span>, high, low, close),                              <span style="color:#998;font-style:italic"># 51</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLKICKINGBYLENGTH(<span style="color:#999">open</span>, high, low, close),                      <span style="color:#998;font-style:italic"># 52</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLLADDERBOTTOM(<span style="color:#999">open</span>, high, low, close),                         <span style="color:#998;font-style:italic"># 53</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLLONGLEGGEDDOJI(<span style="color:#999">open</span>, high, low, close),                       <span style="color:#998;font-style:italic"># 54</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLLONGLINE(<span style="color:#999">open</span>, high, low, close),                             <span style="color:#998;font-style:italic"># 55</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLMARUBOZU(<span style="color:#999">open</span>, high, low, close),                             <span style="color:#998;font-style:italic"># 56</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLMATCHINGLOW(<span style="color:#999">open</span>, high, low, close),                          <span style="color:#998;font-style:italic"># 57</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLMATHOLD(<span style="color:#999">open</span>, high, low, close, penetration<span style="font-weight:bold">=</span><span style="color:#099">0</span>),               <span style="color:#998;font-style:italic"># 58</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLMORNINGDOJISTAR(<span style="color:#999">open</span>, high, low, close, penetration<span style="font-weight:bold">=</span><span style="color:#099">0</span>),       <span style="color:#998;font-style:italic"># 59</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLMORNINGSTAR(<span style="color:#999">open</span>, high, low, close, penetration<span style="font-weight:bold">=</span><span style="color:#099">0</span>),           <span style="color:#998;font-style:italic"># 60</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLONNECK(<span style="color:#999">open</span>, high, low, close),                               <span style="color:#998;font-style:italic"># 61</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLPIERCING(<span style="color:#999">open</span>, high, low, close),                             <span style="color:#998;font-style:italic"># 62</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLRICKSHAWMAN(<span style="color:#999">open</span>, high, low, close),                          <span style="color:#998;font-style:italic"># 63</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLRISEFALL3METHODS(<span style="color:#999">open</span>, high, low, close),                     <span style="color:#998;font-style:italic"># 64</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLSEPARATINGLINES(<span style="color:#999">open</span>, high, low, close),                      <span style="color:#998;font-style:italic"># 65</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLSHOOTINGSTAR(<span style="color:#999">open</span>, high, low, close),                         <span style="color:#998;font-style:italic"># 66</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLSHORTLINE(<span style="color:#999">open</span>, high, low, close),                            <span style="color:#998;font-style:italic"># 67</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLSPINNINGTOP(<span style="color:#999">open</span>, high, low, close),                          <span style="color:#998;font-style:italic"># 68</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLSTALLEDPATTERN(<span style="color:#999">open</span>, high, low, close),                       <span style="color:#998;font-style:italic"># 69</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLSTICKSANDWICH(<span style="color:#999">open</span>, high, low, close),                        <span style="color:#998;font-style:italic"># 70</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLTAKURI(<span style="color:#999">open</span>, high, low, close),                               <span style="color:#998;font-style:italic"># 71</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLTASUKIGAP(<span style="color:#999">open</span>, high, low, close),                            <span style="color:#998;font-style:italic"># 72</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLTHRUSTING(<span style="color:#999">open</span>, high, low, close),                            <span style="color:#998;font-style:italic"># 73</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLTRISTAR(<span style="color:#999">open</span>, high, low, close),                              <span style="color:#998;font-style:italic"># 74</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLUNIQUE3RIVER(<span style="color:#999">open</span>, high, low, close),                         <span style="color:#998;font-style:italic"># 75</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLUPSIDEGAP2CROWS(<span style="color:#999">open</span>, high, low, close),                      <span style="color:#998;font-style:italic"># 76</span>
</span></span><span style="display:flex;"><span>        tb<span style="font-weight:bold">.</span>CDLXSIDEGAP3METHODS(<span style="color:#999">open</span>, high, low, close)                      <span style="color:#998;font-style:italic"># 77</span>
</span></span><span style="display:flex;"><span>    ])<span style="font-weight:bold">.</span>T
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> retn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">stock</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> __init__(self, <span style="color:#999">id</span>):
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>id <span style="font-weight:bold">=</span> <span style="color:#999">id</span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>train <span style="font-weight:bold">=</span> <span style="font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>test <span style="font-weight:bold">=</span> <span style="font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">load</span>(self, window_length<span style="font-weight:bold">=</span><span style="color:#099">120</span>, ratio<span style="font-weight:bold">=</span><span style="color:#099">0</span>, back_length<span style="font-weight:bold">=</span><span style="color:#099">10</span>, forward_length<span style="font-weight:bold">=</span><span style="color:#099">60</span>, test_size<span style="font-weight:bold">=</span><span style="color:#099">0.25</span>, verbose<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># load dataset through tushare</span>
</span></span><span style="display:flex;"><span>        <span style="color:#999">open</span> <span style="font-weight:bold">=</span> history_bars(self<span style="font-weight:bold">.</span>id, window_length, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;open&#39;</span>)
</span></span><span style="display:flex;"><span>        close <span style="font-weight:bold">=</span> history_bars(self<span style="font-weight:bold">.</span>id, window_length, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;close&#39;</span>)
</span></span><span style="display:flex;"><span>        high <span style="font-weight:bold">=</span> history_bars(self<span style="font-weight:bold">.</span>id, window_length, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;high&#39;</span>)
</span></span><span style="display:flex;"><span>        low <span style="font-weight:bold">=</span> history_bars(self<span style="font-weight:bold">.</span>id, window_length, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;low&#39;</span>)
</span></span><span style="display:flex;"><span>        volume <span style="font-weight:bold">=</span> history_bars(self<span style="font-weight:bold">.</span>id, window_length, <span style="color:#b84">&#39;1d&#39;</span>, <span style="color:#b84">&#39;volume&#39;</span>)
</span></span><span style="display:flex;"><span>        df <span style="font-weight:bold">=</span> pd<span style="font-weight:bold">.</span>DataFrame({<span style="color:#b84">&#39;open&#39;</span>: <span style="color:#999">open</span>, <span style="color:#b84">&#39;close&#39;</span>: close, <span style="color:#b84">&#39;high&#39;</span>: high, <span style="color:#b84">&#39;low&#39;</span>: low, <span style="color:#b84">&#39;volume&#39;</span>: volume})<span style="font-weight:bold">.</span>astype(<span style="color:#999">float</span>)
</span></span><span style="display:flex;"><span>        tot_len <span style="font-weight:bold">=</span> <span style="color:#999">len</span>(df)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># use the technical function to load all the technical data</span>
</span></span><span style="display:flex;"><span>        tech <span style="font-weight:bold">=</span> technical(df)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># define the label function, ratio required</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">label</span>(df, ratio, back_length, forward_length):
</span></span><span style="display:flex;"><span>            close <span style="font-weight:bold">=</span> df[<span style="color:#b84">&#39;close&#39;</span>]
</span></span><span style="display:flex;"><span>            r <span style="font-weight:bold">=</span> <span style="color:#099">0.04</span>  <span style="color:#998;font-style:italic"># discount rate</span>
</span></span><span style="display:flex;"><span>            mean_diff <span style="font-weight:bold">=</span> <span style="color:#999">sum</span>([<span style="font-weight:bold">-</span>close<span style="font-weight:bold">.</span>diff(<span style="font-weight:bold">-</span>i) <span style="font-weight:bold">*</span> np<span style="font-weight:bold">.</span>exp(<span style="font-weight:bold">-</span>r <span style="font-weight:bold">*</span> i) <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(<span style="color:#099">1</span>, forward_length <span style="font-weight:bold">+</span> <span style="color:#099">1</span>)]) <span style="font-weight:bold">/</span> forward_length
</span></span><span style="display:flex;"><span>            mean_p_change <span style="font-weight:bold">=</span> (mean_diff <span style="font-weight:bold">/</span> close)[back_length: <span style="font-weight:bold">-</span>forward_length]
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">return</span> (mean_p_change <span style="font-weight:bold">&gt;</span> ratio)<span style="font-weight:bold">.</span>astype(<span style="color:#999">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># split data into X and y</span>
</span></span><span style="display:flex;"><span>        X <span style="font-weight:bold">=</span> df[[<span style="color:#b84">&#39;open&#39;</span>, <span style="color:#b84">&#39;close&#39;</span>, <span style="color:#b84">&#39;high&#39;</span>, <span style="color:#b84">&#39;low&#39;</span>, <span style="color:#b84">&#39;volume&#39;</span>]]
</span></span><span style="display:flex;"><span>        X_shift <span style="font-weight:bold">=</span> [X]
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(<span style="color:#099">1</span>, back_length):
</span></span><span style="display:flex;"><span>            X_shift<span style="font-weight:bold">.</span>append(df[[<span style="color:#b84">&#39;open&#39;</span>, <span style="color:#b84">&#39;close&#39;</span>, <span style="color:#b84">&#39;high&#39;</span>, <span style="color:#b84">&#39;low&#39;</span>, <span style="color:#b84">&#39;volume&#39;</span>]]<span style="font-weight:bold">.</span>shift(i))
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> forward_length <span style="font-weight:bold">==</span> <span style="color:#099">0</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">return</span> np<span style="font-weight:bold">.</span>concatenate([tech, np<span style="font-weight:bold">.</span>log(pd<span style="font-weight:bold">.</span>concat(X_shift, axis<span style="font-weight:bold">=</span><span style="color:#099">1</span>)<span style="font-weight:bold">.</span>values)], axis<span style="font-weight:bold">=</span><span style="color:#099">1</span>)[back_length:]
</span></span><span style="display:flex;"><span>        X <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>concatenate([tech, np<span style="font-weight:bold">.</span>log(pd<span style="font-weight:bold">.</span>concat(X_shift, axis<span style="font-weight:bold">=</span><span style="color:#099">1</span>)<span style="font-weight:bold">.</span>values)], axis<span style="font-weight:bold">=</span><span style="color:#099">1</span>)[back_length: <span style="font-weight:bold">-</span>forward_length]
</span></span><span style="display:flex;"><span>        y <span style="font-weight:bold">=</span> label(df, ratio, back_length, forward_length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># split data into train and test sets</span>
</span></span><span style="display:flex;"><span>        test_len <span style="font-weight:bold">=</span> <span style="color:#999">int</span>(tot_len <span style="font-weight:bold">*</span> test_size)
</span></span><span style="display:flex;"><span>        train_len <span style="font-weight:bold">=</span> tot_len <span style="font-weight:bold">-</span> test_len
</span></span><span style="display:flex;"><span>        X_train, X_test <span style="font-weight:bold">=</span> X[:train_len], X[<span style="font-weight:bold">-</span>test_len:]
</span></span><span style="display:flex;"><span>        y_train, y_test <span style="font-weight:bold">=</span> y[:train_len], y[<span style="font-weight:bold">-</span>test_len:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># update the train and test dataset</span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>train <span style="font-weight:bold">=</span> [X_train, y_train]
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>test <span style="font-weight:bold">=</span> [X_test, y_test]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">classifier</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>model <span style="font-weight:bold">=</span> XGBClassifier(n_estimators<span style="font-weight:bold">=</span><span style="color:#099">300</span>,
</span></span><span style="display:flex;"><span>                                   learning_rate<span style="font-weight:bold">=</span><span style="color:#099">0.1</span>,
</span></span><span style="display:flex;"><span>                                   max_depth<span style="font-weight:bold">=</span><span style="color:#099">4</span>,
</span></span><span style="display:flex;"><span>                                   min_child_weight<span style="font-weight:bold">=</span><span style="color:#099">4</span>,
</span></span><span style="display:flex;"><span>                                   subsample<span style="font-weight:bold">=</span><span style="color:#099">0.6</span>,
</span></span><span style="display:flex;"><span>                                   colsample_bytree<span style="font-weight:bold">=</span><span style="color:#099">0.5</span>,
</span></span><span style="display:flex;"><span>                                   seed<span style="font-weight:bold">=</span><span style="color:#099">123</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">train</span>(self, data):
</span></span><span style="display:flex;"><span>        X_train, y_train <span style="font-weight:bold">=</span> data<span style="font-weight:bold">.</span>train[<span style="color:#099">0</span>], data<span style="font-weight:bold">.</span>train[<span style="color:#099">1</span>]
</span></span><span style="display:flex;"><span>        X_test, y_test <span style="font-weight:bold">=</span> data<span style="font-weight:bold">.</span>test[<span style="color:#099">0</span>], data<span style="font-weight:bold">.</span>test[<span style="color:#099">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>model<span style="font-weight:bold">.</span>fit(X_train, y_train,
</span></span><span style="display:flex;"><span>                       eval_metric<span style="font-weight:bold">=</span><span style="color:#b84">&#39;error&#39;</span>,
</span></span><span style="display:flex;"><span>                       eval_set<span style="font-weight:bold">=</span>[(X_train, y_train), (X_test, y_test)],
</span></span><span style="display:flex;"><span>                       early_stopping_rounds<span style="font-weight:bold">=</span><span style="color:#099">20</span>,
</span></span><span style="display:flex;"><span>                       verbose<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        y_pred <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>model<span style="font-weight:bold">.</span>predict(X_train)
</span></span><span style="display:flex;"><span>        predictions <span style="font-weight:bold">=</span> [<span style="color:#999">round</span>(value) <span style="font-weight:bold">for</span> value <span style="font-weight:bold">in</span> y_pred]
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># evaluate predictions</span>
</span></span><span style="display:flex;"><span>        train_acc <span style="font-weight:bold">=</span> accuracy_score(y_train, predictions)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># make predictions for test data</span>
</span></span><span style="display:flex;"><span>        y_pred <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>model<span style="font-weight:bold">.</span>predict(X_test)
</span></span><span style="display:flex;"><span>        predictions <span style="font-weight:bold">=</span> [<span style="color:#999">round</span>(value) <span style="font-weight:bold">for</span> value <span style="font-weight:bold">in</span> y_pred]
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># evaluate predictions</span>
</span></span><span style="display:flex;"><span>        test_acc <span style="font-weight:bold">=</span> accuracy_score(y_test, predictions)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#999">print</span>(<span style="color:#b84">&#39;</span><span style="color:#b84">{}</span><span style="color:#b84"> train acc: </span><span style="color:#b84">{:.2f}</span><span style="color:#b84">%, test acc: </span><span style="color:#b84">{:.2f}</span><span style="color:#b84">%&#39;</span><span style="font-weight:bold">.</span>format(data<span style="font-weight:bold">.</span>id, train_acc <span style="font-weight:bold">*</span> <span style="color:#099">100</span>, test_acc <span style="font-weight:bold">*</span> <span style="color:#099">100</span>))
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> test_acc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">predict</span>(self, data):
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> self<span style="font-weight:bold">.</span>model<span style="font-weight:bold">.</span>predict(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">close_all</span>(context):
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> s <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>portfolio<span style="font-weight:bold">.</span>positions:
</span></span><span style="display:flex;"><span>        order_target_percent(s, <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">modelize</span>(context, bar_dict):
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> context<span style="font-weight:bold">.</span>flag <span style="font-weight:bold">%</span> (context<span style="font-weight:bold">.</span>FL <span style="font-weight:bold">//</span> <span style="color:#099">20</span>) <span style="font-weight:bold">!=</span> <span style="color:#099">0</span>:
</span></span><span style="display:flex;"><span>        context<span style="font-weight:bold">.</span>flag <span style="font-weight:bold">+=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> <span style="font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;modelizing&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;-&#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">49</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    close_all(context)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>pool <span style="font-weight:bold">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;600799.XSHG&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;600745.XSHG&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;600721.XSHG&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;000979.XSHE&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;600703.XSHG&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;000008.XSHE&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;600139.XSHG&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;000545.XSHE&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;000703.XSHE&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#39;600804.XSHG&#39;</span>, ]
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>stock <span style="font-weight:bold">=</span> [stock(s) <span style="font-weight:bold">for</span> s <span style="font-weight:bold">in</span> context<span style="font-weight:bold">.</span>pool]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;loading training dataset&#39;</span>)
</span></span><span style="display:flex;"><span>    stt <span style="font-weight:bold">=</span> (context<span style="font-weight:bold">.</span>now <span style="font-weight:bold">+</span> relativedelta(months<span style="font-weight:bold">=-</span>context<span style="font-weight:bold">.</span>WL <span style="font-weight:bold">//</span> <span style="color:#099">20</span>))<span style="font-weight:bold">.</span>strftime(<span style="color:#b84">&#39;%Y-%m-</span><span style="color:#b84">%d</span><span style="color:#b84">&#39;</span>)
</span></span><span style="display:flex;"><span>    end <span style="font-weight:bold">=</span> context<span style="font-weight:bold">.</span>now<span style="font-weight:bold">.</span>strftime(<span style="color:#b84">&#39;%Y-%m-</span><span style="color:#b84">%d</span><span style="color:#b84">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(context<span style="font-weight:bold">.</span>N):
</span></span><span style="display:flex;"><span>        context<span style="font-weight:bold">.</span>stock[i]<span style="font-weight:bold">.</span>load(window_length<span style="font-weight:bold">=</span>context<span style="font-weight:bold">.</span>WL,
</span></span><span style="display:flex;"><span>                              ratio<span style="font-weight:bold">=</span>context<span style="font-weight:bold">.</span>ratio,
</span></span><span style="display:flex;"><span>                              back_length<span style="font-weight:bold">=</span>context<span style="font-weight:bold">.</span>BL,
</span></span><span style="display:flex;"><span>                              forward_length<span style="font-weight:bold">=</span>context<span style="font-weight:bold">.</span>FL)
</span></span><span style="display:flex;"><span>        <span style="color:#999">print</span>(context<span style="font-weight:bold">.</span>stock[i]<span style="font-weight:bold">.</span>id <span style="font-weight:bold">+</span> <span style="color:#b84">&#39; loaded&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;-&#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">49</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;training&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(context<span style="font-weight:bold">.</span>N):
</span></span><span style="display:flex;"><span>        context<span style="font-weight:bold">.</span>score[i] <span style="font-weight:bold">=</span> context<span style="font-weight:bold">.</span>clf[i]<span style="font-weight:bold">.</span>train(context<span style="font-weight:bold">.</span>stock[i])
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;-&#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">49</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;predicting&#39;</span>)
</span></span><span style="display:flex;"><span>    stt <span style="font-weight:bold">=</span> (context<span style="font-weight:bold">.</span>now <span style="font-weight:bold">+</span> relativedelta(months<span style="font-weight:bold">=-</span><span style="color:#099">1</span>))<span style="font-weight:bold">.</span>strftime(<span style="color:#b84">&#39;%Y-%m-</span><span style="color:#b84">%d</span><span style="color:#b84">&#39;</span>)
</span></span><span style="display:flex;"><span>    sig <span style="font-weight:bold">=</span> <span style="font-weight:bold">lambda</span> s: <span style="color:#b84">&#39;+&#39;</span> <span style="font-weight:bold">if</span> s <span style="font-weight:bold">else</span> <span style="color:#b84">&#39;-&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(context<span style="font-weight:bold">.</span>N):
</span></span><span style="display:flex;"><span>        context<span style="font-weight:bold">.</span>signal[i] <span style="font-weight:bold">=</span> context<span style="font-weight:bold">.</span>clf[i]<span style="font-weight:bold">.</span>predict(context<span style="font-weight:bold">.</span>stock[i]<span style="font-weight:bold">.</span>load(window_length<span style="font-weight:bold">=</span>context<span style="font-weight:bold">.</span>BL <span style="font-weight:bold">*</span> <span style="color:#099">2</span>,
</span></span><span style="display:flex;"><span>                                                                         ratio<span style="font-weight:bold">=</span>context<span style="font-weight:bold">.</span>ratio,
</span></span><span style="display:flex;"><span>                                                                         back_length<span style="font-weight:bold">=</span>context<span style="font-weight:bold">.</span>BL,
</span></span><span style="display:flex;"><span>                                                                         forward_length<span style="font-weight:bold">=</span><span style="color:#099">0</span>))[<span style="font-weight:bold">-</span><span style="color:#099">1</span>] <span style="font-weight:bold">*</span> \
</span></span><span style="display:flex;"><span>            <span style="color:#999">int</span>(context<span style="font-weight:bold">.</span>score[i] <span style="font-weight:bold">&gt;</span> <span style="color:#099">0.9</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#999">print</span>(<span style="color:#b84">&#39;</span><span style="color:#b84">{}</span><span style="color:#b84">: </span><span style="color:#b84">{}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(context<span style="font-weight:bold">.</span>stock[i]<span style="font-weight:bold">.</span>id, sig(context<span style="font-weight:bold">.</span>signal[i])))
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39;-&#39;</span> <span style="font-weight:bold">*</span> <span style="color:#099">49</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tot <span style="font-weight:bold">=</span> <span style="color:#999">sum</span>(context<span style="font-weight:bold">.</span>signal)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> tot:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(context<span style="font-weight:bold">.</span>N):
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> context<span style="font-weight:bold">.</span>signal[i]:
</span></span><span style="display:flex;"><span>                order_target_percent(context<span style="font-weight:bold">.</span>pool[i], <span style="color:#099">1</span> <span style="font-weight:bold">/</span> tot)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        close_all(context)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">init</span>(context):
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>N <span style="font-weight:bold">=</span> <span style="color:#099">10</span>          <span style="color:#998;font-style:italic"># number of stocks in pool</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>BL <span style="font-weight:bold">=</span> <span style="color:#099">20</span>         <span style="color:#998;font-style:italic"># backward length</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>FL <span style="font-weight:bold">=</span> <span style="color:#099">60</span>         <span style="color:#998;font-style:italic"># forward length</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>WL <span style="font-weight:bold">=</span> <span style="color:#099">240</span>        <span style="color:#998;font-style:italic"># total window length</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>ratio <span style="font-weight:bold">=</span> <span style="color:#099">0.000</span>   <span style="color:#998;font-style:italic"># critical ratio as threshold</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>flag <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>pool <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>stock <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>signal <span style="font-weight:bold">=</span> [<span style="color:#099">0</span>] <span style="font-weight:bold">*</span> context<span style="font-weight:bold">.</span>N
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>score <span style="font-weight:bold">=</span> [<span style="color:#099">0</span>] <span style="font-weight:bold">*</span> context<span style="font-weight:bold">.</span>N
</span></span><span style="display:flex;"><span>    context<span style="font-weight:bold">.</span>clf <span style="font-weight:bold">=</span> [classifier()] <span style="font-weight:bold">*</span> context<span style="font-weight:bold">.</span>N
</span></span><span style="display:flex;"><span>    scheduler<span style="font-weight:bold">.</span>run_monthly(modelize, tradingday<span style="font-weight:bold">=</span><span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>__config__ <span style="font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#b84">&#34;base&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;strategy_type&#34;</span>: <span style="color:#b84">&#34;stock&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;start_date&#34;</span>: <span style="color:#b84">&#34;2011-01-01&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;end_date&#34;</span>: <span style="color:#b84">&#34;2017-01-01&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;frequency&#34;</span>: <span style="color:#b84">&#34;1d&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;matching_type&#34;</span>: <span style="color:#b84">&#34;next_bar&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;future_starting_cash&#34;</span>: <span style="color:#099">1000000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;commission_multiplier&#34;</span>: <span style="color:#099">0.01</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;benchmark&#34;</span>: <span style="color:#b84">&#34;000300.XSHG&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#b84">&#34;extra&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;log_level&#34;</span>: <span style="color:#b84">&#34;error&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#b84">&#34;mod&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#b84">&#34;progress&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#b84">&#34;enabled&#34;</span>: <span style="font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#b84">&#34;priority&#34;</span>: <span style="color:#099">400</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h1 id="references">References:</h1>
<ul>
<li>Chen, Tianqi, and Carlos Guestrin. &ldquo;Xgboost: A scalable tree boosting system.&rdquo; Proceedings of the 22Nd ACM SIGKDD International Conference on Knowledge Discovery and Data Mining. ACM, 2016.</li>
<li>Dey, Shubharthi, et al. &ldquo;Forecasting to Classification: Predicting the direction of stock market price using Xtreme Gradient Boosting.&rdquo;</li>
</ul>


<script>
  var unfocusableElems = document.querySelectorAll('pre');
  unfocusableElems.forEach(function (el) { el.setAttribute("tabindex", "-1"); });
  var unfocusableElems = document.querySelectorAll('iframe');
  unfocusableElems.forEach(function (el) { el.setAttribute("tabindex", "-1"); });
</script>

<footer>
  
<br><br>
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/blog/arma-for-aapl/">Basic Walkthrough of ARMA: Take AAPL for Example</a></span>
  <span class="nav-next"><a href="/blog/is-my-apple-pencil-broken/">Is My Apple Pencil Broken!?</a> &rarr;</span>
</nav>

<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/blog\/arma-for-aapl\/';
    
  } else if (e.which == 39) {  
    
    url = '\/blog\/is-my-apple-pencil-broken\/';
    
  }
  if (url) window.location = url;
});
</script>



<script src="https://giscus.app/client.js" data-repo="allenfrostline/allenfrostline.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnk3NzEzOTkxNg==" data-category="General" data-category-id="DIC_kwDOBJkPzM4CbgIQ"
        data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0"
        data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"
        async>
        </script>



<script async src="/js/alt-title.js"></script>

<script async src="/js/center-img.js"></script>

<script async src="/js/external-link.js"></script>

<script async src="/js/fix-footnote.js"></script>

<script async src="/js/header-link.js"></script>

<script async src="/js/load-typekit.js"></script>

<script async src="/js/math-code.js"></script>

<script async src="/js/mermaid.min.js"></script>

<script async src="/js/right-quote.js"></script>


<script src="/js/math-code.js"></script>

  
  
  
  
</footer>
</article>
</body>

</html>
