<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Cryptocurrency Arbitrage (2): Performance - Allen&#39;s Whiteboard</title>
    <meta property="og:title" content="Cryptocurrency Arbitrage (2): Performance - Allen&#39;s Whiteboard">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="Below is the PnL plot of the multi-coin arb strategy. The strategy is running on Amazon EC2 and portfolio value pulled dynamically to plot this using plotly. Timezone is set at my local time, i.e. &amp;hellip;">
      <meta property="og:description" content="Below is the PnL plot of the multi-coin arb strategy. The strategy is running on Amazon EC2 and portfolio value pulled dynamically to plot this using plotly. Timezone is set at my local time, i.e. &amp;hellip;">
      
    

    
    
    
    <meta name="twitter:image" content="https://allenfrostline.com/logo.png">
    
    

    

    
    




    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
<script src="/js/math-code.js"></script>


<script async src="/js/center-img.js"></script>

<script>
  (function (u, c) {
    var d = document, t = 'script', o = d.createElement(t), s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(e); }); }
    s.parentNode.insertBefore(o, s);
  })('//cdn.jsdelivr.net/npm/pangu@4.0.5/dist/browser/pangu.min.js', function () {
    pangu.spacingPage();
  });
</script>



<script async src="/js/center-img.js"></script>
  </head>

  
  <body class="blog">
    <header class="masthead">
      

<h1><a href="/"><img src="/logo.png" alt="allenfrostline" /></a></h1>



      <nav class="menu">
  <ul>
  
  
  <li><a href="/blog/">Blog</a></li>
  
  <li><a href="/vitae/">Vitae</a></li>
  
  <li><a href="/recipe/">Recipe</a></li>
  
  <li><a href="/eatery/">Eatery</a></li>
  
  













  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
    <h1>Cryptocurrency Arbitrage (2): Performance</h1>
    

    <hr style="margin-top:-1em">

    <h3 style="margin-top:-2.3em">
    
        

        
            2018-01-09
        
    
    </h3>



      </header>



<p>Below is the PnL plot of the multi-coin arb strategy. The strategy is running on Amazon EC2 and portfolio value pulled dynamically to plot this using <code>plotly</code>. Timezone is set at my local time, i.e. <code>Europe/Amsterdam</code>. Cheers!</p>
<img src="/images/trace.png" style="width: 100%;"/>
<p><strong>Update April 11:</strong></p>
<p>Strategy offline before I realized my AWS bills was being owed and the server down due to that&hellip; Performance excl. and incl. loss due to holding costs and enforcing execution, etc. (which I would call &ldquo;true performance&rdquo; but is actually summarized from two accounts) is compared below.</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Gross Performance</th>
<th style="text-align:center">Adjusted Performance</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Timespan in Days</td>
<td style="text-align:center">78.72</td>
<td style="text-align:center">78.72</td>
</tr>
<tr>
<td style="text-align:center">Cumulative Returns</td>
<td style="text-align:center">+1386.17%</td>
<td style="text-align:center">+651.53%</td>
</tr>
<tr>
<td style="text-align:center">Annualized Returns</td>
<td style="text-align:center">+6431.49%</td>
<td style="text-align:center">+3022.94%</td>
</tr>
<tr>
<td style="text-align:center">Sharpe Ratio</td>
<td style="text-align:center">7.35</td>
<td style="text-align:center">7.06</td>
</tr>
<tr>
<td style="text-align:center">Maximum Drawdown</td>
<td style="text-align:center">-</td>
<td style="text-align:center">8.05%</td>
</tr>
</tbody>
</table>
<p><strong>Update June 3:</strong></p>
<p>Since the mass slump this January, the strategy has experienced a remarkable decline in performance. Could be due to market panic and the corresponding flooding. Now that it&rsquo;s no longer profitable, I&rsquo;m sharing part of codes in the main file as below. Feel free to tell me your suggestions in comments!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Author: Allen Frostline / Version 0.1.8</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># - Dynamic slippage proportional to spreads</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># - Order retry</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># - Flush all orders and errors</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># - Added a new order delay/timeout mechanism</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># - Using limit order instead of market order now</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># - Added a log-t estimation of expected time to a hit</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># - Added the sim trading feature</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># - Keep 10% BNB in the account so that fee = 5bps</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">os</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">imp</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">sys</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">ccxt</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">config</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">numpy</span> <span style="font-weight:bold">as</span> <span style="color:#555">np</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">import</span> <span style="color:#555">pandas</span> <span style="font-weight:bold">as</span> <span style="color:#555">pd</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">time</span> <span style="font-weight:bold">import</span> sleep
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">pytz</span> <span style="font-weight:bold">import</span> timezone
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">scipy.stats</span> <span style="font-weight:bold">import</span> t
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">scipy.misc</span> <span style="font-weight:bold">import</span> imread
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">datetime</span> <span style="font-weight:bold">import</span> datetime
</span></span><span style="display:flex;"><span><span style="font-weight:bold">from</span> <span style="color:#555">skimage.transform</span> <span style="font-weight:bold">import</span> resize
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERSION <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;0.1.8&#39;</span>
</span></span><span style="display:flex;"><span>SCREEN_WIDTH <span style="font-weight:bold">=</span> <span style="color:#099">100</span>
</span></span><span style="display:flex;"><span>PRINT_BRAND <span style="font-weight:bold">=</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">if</span> sys<span style="font-weight:bold">.</span>stdout<span style="font-weight:bold">.</span>isatty():
</span></span><span style="display:flex;"><span>    RED <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;</span><span style="color:#b84">\u001b</span><span style="color:#b84">[1m</span><span style="color:#b84">\u001b</span><span style="color:#b84">[38;5;196m&#39;</span>
</span></span><span style="display:flex;"><span>    GRAY <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;</span><span style="color:#b84">\u001b</span><span style="color:#b84">[1m</span><span style="color:#b84">\u001b</span><span style="color:#b84">[38;5;240m&#39;</span>
</span></span><span style="display:flex;"><span>    GREEN <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;</span><span style="color:#b84">\u001b</span><span style="color:#b84">[1m</span><span style="color:#b84">\u001b</span><span style="color:#b84">[38;5;46m&#39;</span>
</span></span><span style="display:flex;"><span>    YELLOW <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;</span><span style="color:#b84">\u001b</span><span style="color:#b84">[1m</span><span style="color:#b84">\u001b</span><span style="color:#b84">[38;5;220m&#39;</span>
</span></span><span style="display:flex;"><span>    CYAN <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;</span><span style="color:#b84">\u001b</span><span style="color:#b84">[1m</span><span style="color:#b84">\u001b</span><span style="color:#b84">[38;5;51m&#39;</span>
</span></span><span style="display:flex;"><span>    RESET <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;</span><span style="color:#b84">\u001b</span><span style="color:#b84">[0m&#39;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>    RED <span style="font-weight:bold">=</span> GRAY <span style="font-weight:bold">=</span> GREEN <span style="font-weight:bold">=</span> YELLOW <span style="font-weight:bold">=</span> CYAN <span style="font-weight:bold">=</span> RESET <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IS_OSX <span style="font-weight:bold">=</span> (sys<span style="font-weight:bold">.</span>platform <span style="font-weight:bold">==</span> <span style="color:#b84">&#39;darwin&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">now</span>():
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> datetime<span style="font-weight:bold">.</span>now(timezone(<span style="color:#b84">&#39;Europe/Amsterdam&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">log</span>(s, flush<span style="font-weight:bold">=</span><span style="font-weight:bold">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#999">print</span>(<span style="color:#b84">&#39; &#39;</span> <span style="font-weight:bold">*</span> (SCREEN_WIDTH <span style="font-weight:bold">+</span> <span style="color:#099">60</span>), end<span style="font-weight:bold">=</span><span style="color:#b84">&#39;</span><span style="color:#b84">\r</span><span style="color:#b84">&#39;</span>)
</span></span><span style="display:flex;"><span>    sys<span style="font-weight:bold">.</span>stdout<span style="font-weight:bold">.</span>flush()
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> flush:
</span></span><span style="display:flex;"><span>        <span style="color:#999">print</span>(<span style="color:#b84">&#39;[&#39;</span> <span style="font-weight:bold">+</span> GREEN <span style="font-weight:bold">+</span> now()<span style="font-weight:bold">.</span>strftime(<span style="color:#b84">&#39;%Y-%m-</span><span style="color:#b84">%d</span><span style="color:#b84"> %H:%M:%S&#39;</span>) <span style="font-weight:bold">+</span> RESET <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;]&#39;</span>, s)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#999">print</span>(<span style="color:#b84">&#39;[&#39;</span> <span style="font-weight:bold">+</span> GREEN <span style="font-weight:bold">+</span> now()<span style="font-weight:bold">.</span>strftime(<span style="color:#b84">&#39;%Y-%m-</span><span style="color:#b84">%d</span><span style="color:#b84"> %H:%M:%S&#39;</span>) <span style="font-weight:bold">+</span> RESET <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;]&#39;</span>, s, end<span style="font-weight:bold">=</span><span style="color:#b84">&#39;</span><span style="color:#b84">\r</span><span style="color:#b84">&#39;</span>)
</span></span><span style="display:flex;"><span>        sys<span style="font-weight:bold">.</span>stdout<span style="font-weight:bold">.</span>flush()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>YEAR <span style="font-weight:bold">=</span> now()<span style="font-weight:bold">.</span>year
</span></span><span style="display:flex;"><span>FLUSH_ORDERS <span style="font-weight:bold">=</span> <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>FLUSH_ERRORS <span style="font-weight:bold">=</span> <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>PRINT_BNB_RATIO <span style="font-weight:bold">=</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>ORDER_DELAY_MAX <span style="font-weight:bold">=</span> <span style="color:#099">1000</span>
</span></span><span style="display:flex;"><span>ORDER_RETRY_MAX <span style="font-weight:bold">=</span> <span style="color:#099">10</span>
</span></span><span style="display:flex;"><span>HISTORY_LENGTH <span style="font-weight:bold">=</span> <span style="color:#099">100</span>
</span></span><span style="display:flex;"><span>ERROR_LENGTH <span style="font-weight:bold">=</span> <span style="color:#099">123</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Coinbot</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>mtime_config <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>sim_pnl <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>mv0 <span style="font-weight:bold">=</span> <span style="font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>seconds <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>log_retns <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>init <span style="font-weight:bold">=</span> PRINT_BRAND
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">mv</span>(self):
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> self<span style="font-weight:bold">.</span>sim:
</span></span><span style="display:flex;"><span>            base_amount <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>sim_amount <span style="font-weight:bold">*</span> (<span style="color:#099">1</span> <span style="font-weight:bold">+</span> self<span style="font-weight:bold">.</span>sim_pnl)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">return</span> self<span style="font-weight:bold">.</span>mv_in_usd(self<span style="font-weight:bold">.</span>base_coin, base_amount), base_amount
</span></span><span style="display:flex;"><span>        orders_made, balance <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>close_all()
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> orders_made: balance <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_total_balance()
</span></span><span style="display:flex;"><span>        tot_mv <span style="font-weight:bold">=</span> <span style="color:#999">sum</span>([self<span style="font-weight:bold">.</span>mv_in_usd(c, balance[c]) <span style="font-weight:bold">for</span> c <span style="font-weight:bold">in</span> balance])
</span></span><span style="display:flex;"><span>        bnb_ratio <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>mv_in_usd(<span style="color:#b84">&#39;BNB&#39;</span>, balance[<span style="color:#b84">&#39;BNB&#39;</span>]) <span style="font-weight:bold">/</span> tot_mv
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> tot_mv, balance[self<span style="font-weight:bold">.</span>base_coin], bnb_ratio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">mv_in_usd</span>(self, c, amount):
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> amount: <span style="font-weight:bold">return</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> c <span style="font-weight:bold">not</span> <span style="font-weight:bold">in</span> self<span style="font-weight:bold">.</span>coin_list: <span style="font-weight:bold">return</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        ret <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>        rates <span style="font-weight:bold">=</span> {<span style="color:#b84">&#39;USDT&#39;</span>: <span style="color:#099">1</span>,
</span></span><span style="display:flex;"><span>                 <span style="color:#b84">&#39;BTC&#39;</span>: self<span style="font-weight:bold">.</span>tickers[<span style="color:#b84">&#39;BTC/USDT&#39;</span>][<span style="color:#b84">&#39;last&#39;</span>],
</span></span><span style="display:flex;"><span>                 <span style="color:#b84">&#39;ETH&#39;</span>: self<span style="font-weight:bold">.</span>tickers[<span style="color:#b84">&#39;ETH/USDT&#39;</span>][<span style="color:#b84">&#39;last&#39;</span>],
</span></span><span style="display:flex;"><span>                 <span style="color:#b84">&#39;BNB&#39;</span>: self<span style="font-weight:bold">.</span>tickers[<span style="color:#b84">&#39;BNB/USDT&#39;</span>][<span style="color:#b84">&#39;last&#39;</span>]}
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> c <span style="font-weight:bold">in</span> rates: ret <span style="font-weight:bold">=</span> amount <span style="font-weight:bold">*</span> rates[c]
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">for</span> coin <span style="font-weight:bold">in</span> rates:
</span></span><span style="display:flex;"><span>                symbol <span style="font-weight:bold">=</span> c <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;/&#39;</span> <span style="font-weight:bold">+</span> coin
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">if</span> symbol <span style="font-weight:bold">in</span> self<span style="font-weight:bold">.</span>symbols:
</span></span><span style="display:flex;"><span>                    ret <span style="font-weight:bold">=</span> amount <span style="font-weight:bold">*</span> self<span style="font-weight:bold">.</span>tickers[symbol][<span style="color:#b84">&#39;last&#39;</span>] <span style="font-weight:bold">*</span> rates[coin]
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> ret <span style="font-weight:bold">*</span> (ret <span style="font-weight:bold">&gt;</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">update_config</span>(self):
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span>  <span style="color:#998;font-style:italic"># instructions to print good-looking configurations</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">order</span>(self, from_coin, to_coin, from_amount<span style="font-weight:bold">=</span><span style="font-weight:bold">None</span>, rate<span style="font-weight:bold">=</span><span style="font-weight:bold">None</span>, retry<span style="font-weight:bold">=</span><span style="color:#099">0</span>):
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> retry <span style="font-weight:bold">&gt;</span> ORDER_RETRY_MAX: <span style="font-weight:bold">return</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        from_amount_init <span style="font-weight:bold">=</span> from_amount
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> from_amount:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">if</span> from_coin <span style="font-weight:bold">==</span> <span style="color:#b84">&#39;BNB&#39;</span>:
</span></span><span style="display:flex;"><span>                    from_amount <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_total_balance()[from_coin] <span style="font-weight:bold">*</span> (<span style="color:#099">1</span> <span style="font-weight:bold">-</span> self<span style="font-weight:bold">.</span>bnb_ratio)
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">else</span>: from_amount <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_total_balance()[from_coin]
</span></span><span style="display:flex;"><span>            symbol <span style="font-weight:bold">=</span> from_coin <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;/&#39;</span> <span style="font-weight:bold">+</span> to_coin
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> symbol <span style="font-weight:bold">in</span> self<span style="font-weight:bold">.</span>symbols:
</span></span><span style="display:flex;"><span>                limit <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>limit[symbol]
</span></span><span style="display:flex;"><span>                from_amount <span style="font-weight:bold">=</span> from_amount <span style="font-weight:bold">//</span> limit <span style="font-weight:bold">*</span> limit
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> self<span style="font-weight:bold">.</span>mv_in_usd(from_coin, from_amount): <span style="font-weight:bold">return</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">if</span> rate:
</span></span><span style="display:flex;"><span>                    log(<span style="color:#b84">&#39;Sell </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84"> for </span><span style="color:#b84">{}</span><span style="color:#b84"> at </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84">/</span><span style="color:#b84">{}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#999">format</span>(from_amount, from_coin, to_coin, rate, to_coin, from_coin), FLUSH_ORDERS)
</span></span><span style="display:flex;"><span>                    self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>create_limit_sell_order(symbol, from_amount, rate)
</span></span><span style="display:flex;"><span>                    order_delay <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">while</span> order_delay <span style="font-weight:bold">&lt;</span> ORDER_DELAY_MAX:
</span></span><span style="display:flex;"><span>                        open_orders <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_open_orders(symbol)
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">if</span> open_orders:
</span></span><span style="display:flex;"><span>                            sleep(<span style="color:#099">.1</span>)
</span></span><span style="display:flex;"><span>                            order_delay <span style="font-weight:bold">+=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>                            log(<span style="color:#b84">&#39;Sell </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84"> for </span><span style="color:#b84">{}</span><span style="color:#b84"> at </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84">/</span><span style="color:#b84">{}</span><span style="color:#b84"> (delay </span><span style="color:#b84">{}</span><span style="color:#b84">/</span><span style="color:#b84">{}</span><span style="color:#b84">)&#39;</span><span style="font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#999">format</span>(from_amount, from_coin, to_coin, rate, to_coin, 
</span></span><span style="display:flex;"><span>                                       from_coin, order_delay, ORDER_DELAY_MAX), <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">return</span> <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">for</span> open_order <span style="font-weight:bold">in</span> open_orders: self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>cancel_order(open_order[<span style="color:#b84">&#39;id&#39;</span>], symbol)
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">return</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                    log(<span style="color:#b84">&#39;Sell </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84"> for </span><span style="color:#b84">{}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(from_amount, from_coin, to_coin), FLUSH_ORDERS)
</span></span><span style="display:flex;"><span>                    self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>create_market_sell_order(symbol, from_amount)
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">return</span> <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                symbol <span style="font-weight:bold">=</span> to_coin <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;/&#39;</span> <span style="font-weight:bold">+</span> from_coin
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">if</span> rate:
</span></span><span style="display:flex;"><span>                    to_amount <span style="font-weight:bold">=</span> from_amount <span style="font-weight:bold">/</span> rate
</span></span><span style="display:flex;"><span>                    limit <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>limit[symbol]
</span></span><span style="display:flex;"><span>                    to_amount <span style="font-weight:bold">=</span> to_amount <span style="font-weight:bold">//</span> limit <span style="font-weight:bold">*</span> limit
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> self<span style="font-weight:bold">.</span>mv_in_usd(to_coin, to_amount): <span style="font-weight:bold">return</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>                    log(<span style="color:#b84">&#39;Buy </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84"> with </span><span style="color:#b84">{}</span><span style="color:#b84"> at </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84">/</span><span style="color:#b84">{}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#999">format</span>(to_amount, to_coin, from_coin, rate, from_coin, to_coin), FLUSH_ORDERS)
</span></span><span style="display:flex;"><span>                    self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>create_limit_buy_order(symbol, to_amount, rate)
</span></span><span style="display:flex;"><span>                    order_delay <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">while</span> order_delay <span style="font-weight:bold">&lt;</span> ORDER_DELAY_MAX:
</span></span><span style="display:flex;"><span>                        open_orders <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_open_orders(symbol)
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">if</span> open_orders:
</span></span><span style="display:flex;"><span>                            sleep(<span style="color:#099">.1</span>)
</span></span><span style="display:flex;"><span>                            order_delay <span style="font-weight:bold">+=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>                            log(<span style="color:#b84">&#39;Buy </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84"> with </span><span style="color:#b84">{}</span><span style="color:#b84"> at </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84">/</span><span style="color:#b84">{}</span><span style="color:#b84"> (delay </span><span style="color:#b84">{}</span><span style="color:#b84">/</span><span style="color:#b84">{}</span><span style="color:#b84">)&#39;</span><span style="font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#999">format</span>(to_amount, to_coin, from_coin, rate, from_coin, to_coin,
</span></span><span style="display:flex;"><span>                                       order_delay, ORDER_DELAY_MAX), <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">return</span> <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">for</span> open_order <span style="font-weight:bold">in</span> open_orders: self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>cancel_order(open_order[<span style="color:#b84">&#39;id&#39;</span>], symbol)
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">return</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                    to_amount <span style="font-weight:bold">=</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>                    order_book <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_order_book(symbol)
</span></span><span style="display:flex;"><span>                    slippage <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>updated_slippage(symbol, order_book)
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">for</span> x <span style="font-weight:bold">in</span> order_book[<span style="color:#b84">&#39;asks&#39;</span>]:
</span></span><span style="display:flex;"><span>                        p <span style="font-weight:bold">=</span> x[<span style="color:#099">0</span>] <span style="font-weight:bold">*</span> (<span style="color:#099">1</span> <span style="font-weight:bold">+</span> slippage)
</span></span><span style="display:flex;"><span>                        a <span style="font-weight:bold">=</span> x[<span style="color:#099">1</span>]
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">if</span> a <span style="font-weight:bold">*</span> p <span style="font-weight:bold">&lt;</span> from_amount:
</span></span><span style="display:flex;"><span>                            to_amount <span style="font-weight:bold">+=</span> a
</span></span><span style="display:flex;"><span>                            from_amount <span style="font-weight:bold">-=</span> a <span style="font-weight:bold">*</span> p
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                            to_amount <span style="font-weight:bold">+=</span> from_amount <span style="font-weight:bold">/</span> p
</span></span><span style="display:flex;"><span>                            from_amount <span style="font-weight:bold">-=</span> from_amount
</span></span><span style="display:flex;"><span>                            <span style="font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>                    limit <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>limit[symbol]
</span></span><span style="display:flex;"><span>                    to_amount <span style="font-weight:bold">=</span> to_amount <span style="font-weight:bold">//</span> limit <span style="font-weight:bold">*</span> limit
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> self<span style="font-weight:bold">.</span>mv_in_usd(to_coin, to_amount): <span style="font-weight:bold">return</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>                    log(<span style="color:#b84">&#39;Buy </span><span style="color:#b84">{:.6f}</span><span style="color:#b84"> </span><span style="color:#b84">{}</span><span style="color:#b84"> with </span><span style="color:#b84">{}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(to_amount, to_coin, from_coin), FLUSH_ORDERS)
</span></span><span style="display:flex;"><span>                    self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>create_market_buy_order(symbol, to_amount)
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">return</span> <span style="font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">except</span> <span style="color:#900;font-weight:bold">AssertionError</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">raise</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">except</span> <span style="color:#900;font-weight:bold">Exception</span> <span style="font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> IS_OSX: os<span style="font-weight:bold">.</span>system(<span style="color:#b84">&#39;afplay /System/Library/Sounds/Hero.aiff&#39;</span>)
</span></span><span style="display:flex;"><span>            err <span style="font-weight:bold">=</span> <span style="color:#999">str</span>(e)
</span></span><span style="display:flex;"><span>            log(<span style="color:#b84">&#39;Error: </span><span style="color:#b84">{}</span><span style="color:#b84">...&#39;</span><span style="font-weight:bold">.</span>format(err[:ERROR_LENGTH]<span style="font-weight:bold">.</span>strip()), FLUSH_ERRORS)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> symbol:
</span></span><span style="display:flex;"><span>                open_orders <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_open_orders(symbol)
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">for</span> open_order <span style="font-weight:bold">in</span> open_orders: self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>cancel_order(open_order[<span style="color:#b84">&#39;id&#39;</span>], symbol)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                sleep(<span style="color:#099">.1</span>)
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>order(from_coin, to_coin, from_amount<span style="font-weight:bold">=</span>from_amount_init, rate<span style="font-weight:bold">=</span>rate, retry<span style="font-weight:bold">=</span>retry <span style="font-weight:bold">+</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">close_all</span>(self):
</span></span><span style="display:flex;"><span>        orders_made <span style="font-weight:bold">=</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        balance <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_total_balance()
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># all to btc (except bnb, usdt and btc)</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">for</span> c <span style="font-weight:bold">in</span> balance:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> self<span style="font-weight:bold">.</span>mv_in_usd(c, balance[c]): <span style="font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> c <span style="font-weight:bold">in</span> [self<span style="font-weight:bold">.</span>base_coin, <span style="color:#b84">&#39;BNB&#39;</span>, <span style="color:#b84">&#39;BTC&#39;</span>]: <span style="font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            orders_made <span style="font-weight:bold">+=</span> self<span style="font-weight:bold">.</span>order(c, <span style="color:#b84">&#39;BTC&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># all BTC -&gt; BASE_COIN</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> self<span style="font-weight:bold">.</span>base_coin <span style="font-weight:bold">!=</span> <span style="color:#b84">&#39;BTC&#39;</span>: orders_made <span style="font-weight:bold">+=</span> self<span style="font-weight:bold">.</span>order(<span style="color:#b84">&#39;BTC&#39;</span>, self<span style="font-weight:bold">.</span>base_coin)
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># if BASE_COIN is not BNB</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> self<span style="font-weight:bold">.</span>base_coin <span style="font-weight:bold">!=</span> <span style="color:#b84">&#39;BNB&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic"># calc ratio of bnb (both in usd)</span>
</span></span><span style="display:flex;"><span>            tot_mv <span style="font-weight:bold">=</span> <span style="color:#999">sum</span>([self<span style="font-weight:bold">.</span>mv_in_usd(c, balance[c]) <span style="font-weight:bold">for</span> c <span style="font-weight:bold">in</span> balance])
</span></span><span style="display:flex;"><span>            bnb_mv <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>mv_in_usd(<span style="color:#b84">&#39;BNB&#39;</span>, balance[<span style="color:#b84">&#39;BNB&#39;</span>])
</span></span><span style="display:flex;"><span>            bnb_ratio <span style="font-weight:bold">=</span> <span style="color:#999">round</span>(bnb_mv <span style="font-weight:bold">/</span> tot_mv <span style="font-weight:bold">*</span> <span style="color:#099">100</span>) <span style="font-weight:bold">/</span> <span style="color:#099">100</span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic"># calc offset and make orders BASE_COIN -&gt; BNB</span>
</span></span><span style="display:flex;"><span>            bnb_usdt <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>tickers[<span style="color:#b84">&#39;BNB/USDT&#39;</span>][<span style="color:#b84">&#39;last&#39;</span>]
</span></span><span style="display:flex;"><span>            base_usdt <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>tickers[self<span style="font-weight:bold">.</span>base_coin <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;/USDT&#39;</span>][<span style="color:#b84">&#39;last&#39;</span>] <span style="font-weight:bold">if</span> self<span style="font-weight:bold">.</span>base_coin <span style="font-weight:bold">!=</span> <span style="color:#b84">&#39;USDT&#39;</span> <span style="font-weight:bold">else</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> bnb_ratio <span style="font-weight:bold">&gt;</span> self<span style="font-weight:bold">.</span>bnb_ratio:
</span></span><span style="display:flex;"><span>                orders_made <span style="font-weight:bold">+=</span> self<span style="font-weight:bold">.</span>order(<span style="color:#b84">&#39;BNB&#39;</span>, self<span style="font-weight:bold">.</span>base_coin,
</span></span><span style="display:flex;"><span>                                          from_amount<span style="font-weight:bold">=</span>tot_mv <span style="font-weight:bold">*</span> (bnb_ratio <span style="font-weight:bold">-</span> self<span style="font-weight:bold">.</span>bnb_ratio) <span style="font-weight:bold">/</span> bnb_usdt)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">elif</span> bnb_ratio <span style="font-weight:bold">&lt;</span> self<span style="font-weight:bold">.</span>bnb_ratio:
</span></span><span style="display:flex;"><span>                orders_made <span style="font-weight:bold">+=</span> self<span style="font-weight:bold">.</span>order(self<span style="font-weight:bold">.</span>base_coin, <span style="color:#b84">&#39;BNB&#39;</span>,
</span></span><span style="display:flex;"><span>                                          from_amount<span style="font-weight:bold">=</span>tot_mv <span style="font-weight:bold">*</span> (self<span style="font-weight:bold">.</span>bnb_ratio <span style="font-weight:bold">-</span> bnb_ratio) <span style="font-weight:bold">/</span> base_usdt)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> orders_made, balance
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">simulate</span>(self, path):
</span></span><span style="display:flex;"><span>        from_coin <span style="font-weight:bold">=</span> path[<span style="font-weight:bold">-</span><span style="color:#099">1</span>]
</span></span><span style="display:flex;"><span>        ffrom_coin <span style="font-weight:bold">=</span> <span style="font-weight:bold">None</span> <span style="font-weight:bold">if</span> <span style="color:#999">len</span>(path) <span style="font-weight:bold">==</span> <span style="color:#099">1</span> <span style="font-weight:bold">else</span> path[<span style="font-weight:bold">-</span><span style="color:#099">2</span>]
</span></span><span style="display:flex;"><span>        path_list <span style="font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">for</span> symbol <span style="font-weight:bold">in</span> self<span style="font-weight:bold">.</span>symbols:
</span></span><span style="display:flex;"><span>            ss <span style="font-weight:bold">=</span> symbol<span style="font-weight:bold">.</span>split(<span style="color:#b84">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> (from_coin <span style="font-weight:bold">not</span> <span style="font-weight:bold">in</span> ss) <span style="font-weight:bold">or</span> (ffrom_coin <span style="font-weight:bold">in</span> ss): <span style="font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            to_coin <span style="font-weight:bold">=</span> ss[<span style="color:#099">1</span>] <span style="font-weight:bold">if</span> from_coin <span style="font-weight:bold">==</span> ss[<span style="color:#099">0</span>] <span style="font-weight:bold">else</span> ss[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> to_coin <span style="font-weight:bold">==</span> self<span style="font-weight:bold">.</span>base_coin: path_list<span style="font-weight:bold">.</span>append(path <span style="font-weight:bold">+</span> [to_coin])
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">elif</span> <span style="color:#999">len</span>(path) <span style="font-weight:bold">&lt;</span> self<span style="font-weight:bold">.</span>max_len <span style="font-weight:bold">-</span> <span style="color:#099">1</span>:
</span></span><span style="display:flex;"><span>                temp <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>simulate(path <span style="font-weight:bold">+</span> [to_coin])
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">if</span> <span style="font-weight:bold">not</span> temp: <span style="font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">else</span>: path_list <span style="font-weight:bold">+=</span> temp
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> path_list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">updated_slippage</span>(self, symbol, order_book):
</span></span><span style="display:flex;"><span>        spread <span style="font-weight:bold">=</span> (order_book[<span style="color:#b84">&#39;asks&#39;</span>][<span style="color:#099">0</span>][<span style="color:#099">0</span>] <span style="font-weight:bold">-</span> order_book[<span style="color:#b84">&#39;bids&#39;</span>][<span style="color:#099">0</span>][<span style="color:#099">0</span>]) <span style="font-weight:bold">/</span> order_book[<span style="color:#b84">&#39;asks&#39;</span>][<span style="color:#099">0</span>][<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>spreads[symbol]<span style="font-weight:bold">.</span>append(spread)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> <span style="color:#999">len</span>(self<span style="font-weight:bold">.</span>spreads) <span style="font-weight:bold">&gt;</span> HISTORY_LENGTH: self<span style="font-weight:bold">.</span>spreads<span style="font-weight:bold">.</span>pop(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>        mean_spread <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>mean(self<span style="font-weight:bold">.</span>spreads[symbol])
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> mean_spread <span style="font-weight:bold">*</span> self<span style="font-weight:bold">.</span>slippage_ratio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">optimum</span>(self, base_amount):
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">return</span> path, ratio, amount   <span style="color:#998;font-style:italic"># MCTS algorithm</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">cancel_all</span>(self):
</span></span><span style="display:flex;"><span>        log(<span style="color:#b84">&#39;Cancelling all open orders&#39;</span>, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">for</span> symbol <span style="font-weight:bold">in</span> self<span style="font-weight:bold">.</span>symbols:
</span></span><span style="display:flex;"><span>            open_orders <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_open_orders(symbol)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> open_orders:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">for</span> open_order <span style="font-weight:bold">in</span> open_orders:
</span></span><span style="display:flex;"><span>                    self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>cancel_order(open_order[<span style="color:#b84">&#39;id&#39;</span>], open_order[<span style="color:#b84">&#39;symbol&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">trade</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>tickers <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_tickers(self<span style="font-weight:bold">.</span>symbols)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>order_book <span style="font-weight:bold">=</span> {symbol: self<span style="font-weight:bold">.</span>exchange<span style="font-weight:bold">.</span>fetch_order_book(symbol) <span style="font-weight:bold">for</span> symbol <span style="font-weight:bold">in</span> self<span style="font-weight:bold">.</span>symbols}
</span></span><span style="display:flex;"><span>        mv, base_amount, bnb_ratio <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>mv()
</span></span><span style="display:flex;"><span>        opt <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>optimum(base_amount)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> opt <span style="font-weight:bold">is</span> <span style="font-weight:bold">None</span>: <span style="font-weight:bold">return</span> <span style="font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        opt_path, opt_retn, opt_rate_list <span style="font-weight:bold">=</span> opt
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>end <span style="font-weight:bold">=</span> now()
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>seconds<span style="font-weight:bold">.</span>append((self<span style="font-weight:bold">.</span>end <span style="font-weight:bold">-</span> self<span style="font-weight:bold">.</span>start)<span style="font-weight:bold">.</span>seconds)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>log_retns<span style="font-weight:bold">.</span>append(np<span style="font-weight:bold">.</span>log(<span style="color:#099">1</span> <span style="font-weight:bold">+</span> opt_retn))
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> <span style="color:#999">len</span>(self<span style="font-weight:bold">.</span>seconds) <span style="font-weight:bold">&gt;</span> HISTORY_LENGTH:
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>seconds<span style="font-weight:bold">.</span>pop(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>log_retns<span style="font-weight:bold">.</span>pop(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>        freq <span style="font-weight:bold">=</span> <span style="color:#099">60</span> <span style="font-weight:bold">/</span> np<span style="font-weight:bold">.</span>mean(self<span style="font-weight:bold">.</span>seconds)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> <span style="color:#999">len</span>(self<span style="font-weight:bold">.</span>seconds) <span style="font-weight:bold">&gt;</span> <span style="color:#099">5</span>:
</span></span><span style="display:flex;"><span>            ccdf <span style="font-weight:bold">=</span> <span style="color:#099">1</span> <span style="font-weight:bold">-</span> t<span style="font-weight:bold">.</span>cdf(self<span style="font-weight:bold">.</span>threshold, <span style="font-weight:bold">*</span>t<span style="font-weight:bold">.</span>fit(self<span style="font-weight:bold">.</span>log_retns))
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> ccdf <span style="font-weight:bold">&gt;</span> <span style="color:#099">1e-4</span>: exp_rounds <span style="font-weight:bold">=</span> <span style="color:#099">1</span> <span style="font-weight:bold">/</span> ccdf
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">else</span>: exp_rounds <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>inf
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">else</span>: exp_rounds <span style="font-weight:bold">=</span> np<span style="font-weight:bold">.</span>inf
</span></span><span style="display:flex;"><span>        len_trans <span style="font-weight:bold">=</span> <span style="color:#999">len</span>(opt_path) <span style="font-weight:bold">-</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        mv_str <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;$&#39;</span> <span style="font-weight:bold">+</span> RED <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;</span><span style="color:#b84">{:.4f}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(mv) <span style="font-weight:bold">+</span> RESET <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;/&#39;</span> <span style="font-weight:bold">+</span> \
</span></span><span style="display:flex;"><span>                 RED <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;</span><span style="color:#b84">{:+.4f}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(mv <span style="font-weight:bold">/</span> self<span style="font-weight:bold">.</span>mv0 <span style="font-weight:bold">*</span> <span style="color:#099">100</span> <span style="font-weight:bold">-</span> <span style="color:#099">100</span>) <span style="font-weight:bold">+</span> RESET <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;% &#39;</span>
</span></span><span style="display:flex;"><span>        path_str <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;[&#39;</span> <span style="font-weight:bold">+</span> <span style="color:#b84">&#39; </span><span style="color:#b84">\u2192</span><span style="color:#b84"> &#39;</span><span style="font-weight:bold">.</span>join([YELLOW <span style="font-weight:bold">+</span> coin <span style="font-weight:bold">+</span> RESET <span style="font-weight:bold">for</span> coin <span style="font-weight:bold">in</span> opt_path]) <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;] &#39;</span>
</span></span><span style="display:flex;"><span>        retn_str <span style="font-weight:bold">=</span> CYAN <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;</span><span style="color:#b84">{:+.4f}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(opt_retn <span style="font-weight:bold">*</span> <span style="color:#099">10000</span>) <span style="font-weight:bold">+</span> RESET <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;bps &#39;</span>
</span></span><span style="display:flex;"><span>        freq_str <span style="font-weight:bold">=</span> <span style="color:#b84">&#39;(&#39;</span> <span style="font-weight:bold">+</span> GREEN <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;</span><span style="color:#b84">{:.2f}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(freq) <span style="font-weight:bold">+</span> RESET <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;rpm/&#39;</span> <span style="font-weight:bold">+</span> \
</span></span><span style="display:flex;"><span>                   GREEN <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;</span><span style="color:#b84">{:.2f}</span><span style="color:#b84">&#39;</span><span style="font-weight:bold">.</span>format(exp_rounds <span style="font-weight:bold">/</span> freq) <span style="font-weight:bold">+</span> RESET <span style="font-weight:bold">+</span> <span style="color:#b84">&#39;mph)&#39;</span>
</span></span><span style="display:flex;"><span>        log_str <span style="font-weight:bold">=</span> mv_str <span style="font-weight:bold">+</span> path_str <span style="font-weight:bold">+</span> retn_str <span style="font-weight:bold">+</span> freq_str
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> PRINT_BNB_RATIO:
</span></span><span style="display:flex;"><span>            ratio_str <span style="font-weight:bold">=</span> <span style="color:#b84">&#39; ~ </span><span style="color:#b84">{:.2f}</span><span style="color:#b84">%&#39;</span><span style="font-weight:bold">.</span>format(bnb_ratio <span style="font-weight:bold">*</span> <span style="color:#099">100</span>)
</span></span><span style="display:flex;"><span>            log_str <span style="font-weight:bold">+=</span> ratio_str
</span></span><span style="display:flex;"><span>        log(log_str, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> (opt_retn <span style="font-weight:bold">&gt;</span> self<span style="font-weight:bold">.</span>threshold):
</span></span><span style="display:flex;"><span>            log(log_str)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> IS_OSX: os<span style="font-weight:bold">.</span>system(<span style="color:#b84">&#39;afplay /System/Library/Sounds/Ping.aiff&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> self<span style="font-weight:bold">.</span>sim:
</span></span><span style="display:flex;"><span>                self<span style="font-weight:bold">.</span>sim_pnl <span style="font-weight:bold">+=</span> (<span style="color:#099">1</span> <span style="font-weight:bold">+</span> self<span style="font-weight:bold">.</span>sim_pnl) <span style="font-weight:bold">*</span> opt_retn
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(len_trans):
</span></span><span style="display:flex;"><span>                    from_coin <span style="font-weight:bold">=</span> opt_path[i]
</span></span><span style="display:flex;"><span>                    to_coin <span style="font-weight:bold">=</span> opt_path[i <span style="font-weight:bold">+</span> <span style="color:#099">1</span>]
</span></span><span style="display:flex;"><span>                    rate <span style="font-weight:bold">=</span> opt_rate_list[i]
</span></span><span style="display:flex;"><span>                    order_result <span style="font-weight:bold">=</span> self<span style="font-weight:bold">.</span>order(from_coin, to_coin, rate<span style="font-weight:bold">=</span>rate)
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">if</span> order_result <span style="font-weight:bold">is</span> <span style="font-weight:bold">False</span>:
</span></span><span style="display:flex;"><span>                        log(<span style="color:#b84">&#39;Order cancelled&#39;</span>, <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                        <span style="font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> IS_OSX: os<span style="font-weight:bold">.</span>system(<span style="color:#b84">&#39;afplay /System/Library/Sounds/Tink.aiff&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="font-weight:bold">.</span>start <span style="font-weight:bold">=</span> now()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">def</span> <span style="color:#900;font-weight:bold">run</span>(self):
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">while</span> <span style="font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>                mtime_config <span style="font-weight:bold">=</span> os<span style="font-weight:bold">.</span>path<span style="font-weight:bold">.</span>getmtime(<span style="color:#b84">&#39;config.py&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">if</span> mtime_config <span style="font-weight:bold">!=</span> self<span style="font-weight:bold">.</span>mtime_config: self<span style="font-weight:bold">.</span>update_config()
</span></span><span style="display:flex;"><span>                self<span style="font-weight:bold">.</span>trade()
</span></span><span style="display:flex;"><span>                self<span style="font-weight:bold">.</span>mtime_config <span style="font-weight:bold">=</span> mtime_config
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">except</span> <span style="color:#900;font-weight:bold">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>cancel_all()
</span></span><span style="display:flex;"><span>            log(<span style="color:#b84">&#39;Good bye&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">except</span> (<span style="color:#900;font-weight:bold">AssertionError</span>, <span style="color:#900;font-weight:bold">KeyError</span>) <span style="font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> IS_OSX: os<span style="font-weight:bold">.</span>system(<span style="color:#b84">&#39;afplay /System/Library/Sounds/Hero.aiff&#39;</span>)
</span></span><span style="display:flex;"><span>            err <span style="font-weight:bold">=</span> <span style="color:#999">str</span>(e)
</span></span><span style="display:flex;"><span>            log(err, FLUSH_ERRORS)
</span></span><span style="display:flex;"><span>            sleep(<span style="color:#099">.1</span>)
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>cancel_all()
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>start <span style="font-weight:bold">=</span> now()
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>run()
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">except</span> <span style="color:#900;font-weight:bold">Exception</span> <span style="font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> IS_OSX: os<span style="font-weight:bold">.</span>system(<span style="color:#b84">&#39;afplay /System/Library/Sounds/Hero.aiff&#39;</span>)
</span></span><span style="display:flex;"><span>            err <span style="font-weight:bold">=</span> <span style="color:#999">str</span>(e)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">if</span> <span style="color:#b84">&#39;until&#39;</span> <span style="font-weight:bold">in</span> err:
</span></span><span style="display:flex;"><span>                idx <span style="font-weight:bold">=</span> err<span style="font-weight:bold">.</span>index(<span style="color:#b84">&#39;until&#39;</span>) <span style="font-weight:bold">+</span> <span style="color:#099">6</span>
</span></span><span style="display:flex;"><span>                timestamp <span style="font-weight:bold">=</span> <span style="color:#999">int</span>(err[idx: idx <span style="font-weight:bold">+</span> <span style="color:#099">13</span>])
</span></span><span style="display:flex;"><span>                wait <span style="font-weight:bold">=</span> (datetime<span style="font-weight:bold">.</span>fromtimestamp(timestamp <span style="font-weight:bold">/</span> <span style="color:#099">1000</span>) <span style="font-weight:bold">-</span> datetime<span style="font-weight:bold">.</span>now())<span style="font-weight:bold">.</span>seconds
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">for</span> i <span style="font-weight:bold">in</span> <span style="color:#999">range</span>(wait):
</span></span><span style="display:flex;"><span>                    log(<span style="color:#b84">&#39;Error: too many requests, IP banned for </span><span style="color:#b84">{}</span><span style="color:#b84"> seconds&#39;</span><span style="font-weight:bold">.</span>format(wait <span style="font-weight:bold">-</span> i), <span style="font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                    sleep(<span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                log(<span style="color:#b84">&#39;Error: </span><span style="color:#b84">{}</span><span style="color:#b84">...&#39;</span><span style="font-weight:bold">.</span>format(err[:ERROR_LENGTH]<span style="font-weight:bold">.</span>strip()), FLUSH_ERRORS)
</span></span><span style="display:flex;"><span>                sleep(<span style="color:#099">.1</span>)
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>cancel_all()
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>start <span style="font-weight:bold">=</span> now()
</span></span><span style="display:flex;"><span>            self<span style="font-weight:bold">.</span>run()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">if</span> __name__ <span style="font-weight:bold">==</span> <span style="color:#b84">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    agent <span style="font-weight:bold">=</span> Coinbot()
</span></span><span style="display:flex;"><span>    agent<span style="font-weight:bold">.</span>run()
</span></span></code></pre></div>

<script>
  var unfocusableElems = document.querySelectorAll('pre');
  unfocusableElems.forEach(function (el) { el.setAttribute("tabindex", "-1"); });
  var unfocusableElems = document.querySelectorAll('iframe');
  unfocusableElems.forEach(function (el) { el.setAttribute("tabindex", "-1"); });
</script>

<footer>
  
<br><br>
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/blog/cryptocurrency-arbitrage-1/">Cryptocurrency Arbitrage (1): Some Ideas</a></span>
  <span class="nav-next"><a href="/blog/switch-hexo-theme-to-apollo/">Switched Hexo Theme to Apollo</a> &rarr;</span>
</nav>

<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/blog\/cryptocurrency-arbitrage-1\/';
    
  } else if (e.which == 39) {  
    
    url = '\/blog\/switch-hexo-theme-to-apollo\/';
    
  }
  if (url) window.location = url;
});
</script>



<script src="https://giscus.app/client.js" data-repo="allenfrostline/allenfrostline.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnk3NzEzOTkxNg==" data-category="General" data-category-id="DIC_kwDOBJkPzM4CbgIQ"
        data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0"
        data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"
        async>
        </script>



<script async src="/js/center-img.js"></script>

<script async src="/js/right-quote.js"></script>

<script async src="/js/fix-footnote.js"></script>

<script async src="/js/math-code.js"></script>

<script async src="/js/external-link.js"></script>

<script async src="/js/alt-title.js"></script>

<script async src="/js/header-link.js"></script>


<script src="/js/math-code.js"></script>

  
  
  
  
</footer>
</article>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-93356635-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
</body>

</html>
